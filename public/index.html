<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Bible Interpreter</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Literata:opsz,wght@7..72,400;7..72,500;7..72,600&display=swap" rel="stylesheet">
  <style>
    /* ===== Design System ===== */
    :root {
      /* Colors - Light Mode */
      --primary-50: #EEF2FF;
      --primary-100: #E0E7FF;
      --primary-500: #6366F1;
      --primary-600: #4F46E5;
      --primary-700: #4338CA;

      --neutral-50: #FAFAFA;
      --neutral-100: #F5F5F5;
      --neutral-200: #E5E5E5;
      --neutral-300: #D4D4D4;
      --neutral-400: #A3A3A3;
      --neutral-500: #737373;
      --neutral-600: #525252;
      --neutral-700: #404040;
      --neutral-800: #262626;
      --neutral-900: #171717;

      --selection-bg: #DBEAFE;
      --selection-border: #3B82F6;
      --success: #10B981;
      --error: #EF4444;

      --scripture-bg: #F0F2F5;
      --verse-hover: #E4E7EC;

      --header-bg: #1E1B4B;
      --panel-bg: #FFFFFF;

      /* Typography */
      --font-ui: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      --font-scripture: 'Literata', Georgia, 'Times New Roman', serif;
      --font-mono: 'SF Mono', Monaco, 'Cascadia Code', Consolas, monospace;

      /* Type Scale */
      --text-xs: 0.75rem;
      --text-sm: 0.875rem;
      --text-base: 1rem;
      --text-lg: 1.125rem;
      --text-xl: 1.25rem;
      --text-2xl: 1.5rem;
      --text-3xl: 1.875rem;

      /* Spacing */
      --space-1: 0.25rem;
      --space-2: 0.5rem;
      --space-3: 0.75rem;
      --space-4: 1rem;
      --space-5: 1.25rem;
      --space-6: 1.5rem;
      --space-8: 2rem;
      --space-10: 2.5rem;
      --space-12: 3rem;

      /* Shadows */
      --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
      --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
      --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -4px rgba(0, 0, 0, 0.1);
      --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1);

      /* Transitions */
      --transition-fast: 0.15s ease;
      --transition-normal: 0.2s ease;
      --transition-slow: 0.3s ease;
    }

    /* Dark Mode */
    :root.dark {
      --primary-50: #312E81;
      --primary-100: #3730A3;
      --primary-500: #818CF8;
      --primary-600: #A5B4FC;
      --primary-700: #C7D2FE;

      --neutral-50: #0A0A0A;
      --neutral-100: #171717;
      --neutral-200: #262626;
      --neutral-300: #404040;
      --neutral-400: #525252;
      --neutral-500: #8A8A8A;
      --neutral-600: #B8B8B8;
      --neutral-700: #E0E0E0;
      --neutral-800: #F0F0F0;
      --neutral-900: #FFFFFF;

      --selection-bg: #422006;
      --selection-border: #D97706;

      --scripture-bg: #1C1917;
      --verse-hover: #292524;

      --header-bg: #0F0D1A;
      --panel-bg: #171717;
    }

    /* ===== Base Styles ===== */
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: var(--font-ui);
      line-height: 1.6;
      color: var(--neutral-700);
      background: var(--neutral-50);
      height: 100vh;
      display: flex;
      flex-direction: column;
      transition: background var(--transition-normal), color var(--transition-normal);
    }

    /* Focus styles */
    :focus-visible {
      outline: 2px solid var(--primary-500);
      outline-offset: 2px;
    }

    /* ===== Header ===== */
    header {
      background: var(--header-bg);
      color: white;
      padding: var(--space-3) var(--space-5);
      display: flex;
      align-items: center;
      gap: var(--space-4);
      position: relative;
      z-index: 100;
    }

    header h1 {
      font-size: var(--text-lg);
      font-weight: 600;
      white-space: nowrap;
    }

    .nav-controls {
      display: flex;
      gap: var(--space-2);
      align-items: center;
    }

    .nav-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 36px;
      height: 36px;
      border: none;
      border-radius: 8px;
      background: rgba(255,255,255,0.1);
      color: white;
      cursor: pointer;
      transition: background var(--transition-fast);
    }

    .nav-btn:hover:not(:disabled) {
      background: var(--primary-500);
    }

    .nav-btn:disabled {
      opacity: 0.3;
      cursor: not-allowed;
    }

    .nav-btn svg {
      width: 20px;
      height: 20px;
    }

    .nav-controls select {
      padding: var(--space-2) var(--space-3);
      font-size: var(--text-sm);
      border: none;
      border-radius: 8px;
      background: white;
      color: #262626;
      cursor: pointer;
      min-width: 120px;
    }

    .nav-controls .go-btn {
      padding: var(--space-2) var(--space-4);
      font-size: var(--text-sm);
      font-weight: 500;
      border: none;
      border-radius: 8px;
      background: var(--primary-500);
      color: white;
      cursor: pointer;
      transition: background var(--transition-fast);
    }

    .nav-controls .go-btn:hover {
      background: var(--primary-600);
    }

    .header-actions {
      margin-left: auto;
      display: flex;
      align-items: center;
      gap: var(--space-3);
    }

    .version-select {
      padding: var(--space-2) var(--space-3);
      font-size: var(--text-sm);
      font-weight: 500;
      border: none;
      border-radius: 8px;
      background: rgba(255, 255, 255, 0.15);
      color: white;
      cursor: pointer;
      min-width: 70px;
    }

    .version-select:hover {
      background: rgba(255, 255, 255, 0.25);
    }

    .version-select option {
      background: var(--header-bg);
      color: white;
    }

    .theme-toggle {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 40px;
      height: 40px;
      border: none;
      border-radius: 8px;
      background: rgba(255,255,255,0.1);
      color: white;
      cursor: pointer;
      transition: background var(--transition-fast);
    }

    .theme-toggle:hover {
      background: rgba(255,255,255,0.2);
    }

    .theme-toggle svg {
      width: 20px;
      height: 20px;
    }

    .theme-toggle .sun-icon { display: none; }
    .theme-toggle .moon-icon { display: block; }
    :root.dark .theme-toggle .sun-icon { display: block; }
    :root.dark .theme-toggle .moon-icon { display: none; }

    .usage-badge {
      background: rgba(255,255,255,0.15);
      padding: var(--space-2) var(--space-3);
      border-radius: 20px;
      font-size: var(--text-sm);
      cursor: pointer;
      transition: background var(--transition-fast);
      white-space: nowrap;
    }

    .usage-badge:hover {
      background: rgba(255,255,255,0.25);
    }

    /* ===== Usage Modal ===== */
    .usage-modal {
      display: none;
      position: fixed;
      top: 60px;
      right: var(--space-5);
      background: var(--panel-bg);
      border-radius: 12px;
      box-shadow: var(--shadow-xl);
      padding: var(--space-5);
      width: 320px;
      z-index: 1000;
      color: var(--neutral-700);
    }

    .usage-modal.visible {
      display: block;
      animation: fadeIn 0.2s ease;
    }

    .usage-modal h3 {
      margin-bottom: var(--space-4);
      font-size: var(--text-base);
      color: var(--neutral-900);
    }

    .usage-stat {
      display: flex;
      justify-content: space-between;
      padding: var(--space-2) 0;
      border-bottom: 1px solid var(--neutral-200);
    }

    .usage-stat:last-child {
      border-bottom: none;
    }

    .usage-stat-label {
      color: var(--neutral-500);
      font-size: var(--text-sm);
    }

    .usage-stat-value {
      font-weight: 600;
      color: var(--neutral-900);
    }

    .usage-cost {
      font-size: var(--text-2xl);
      font-weight: 600;
      color: var(--success);
      text-align: center;
      padding: var(--space-4) 0;
    }

    .usage-reset {
      width: 100%;
      padding: var(--space-2);
      margin-top: var(--space-4);
      background: var(--error);
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: var(--text-sm);
      font-weight: 500;
      transition: background var(--transition-fast);
    }

    .usage-reset:hover {
      background: #DC2626;
    }

    .recent-requests {
      margin-top: var(--space-4);
      max-height: 150px;
      overflow-y: auto;
    }

    .recent-request {
      font-size: var(--text-xs);
      padding: var(--space-2) 0;
      border-bottom: 1px solid var(--neutral-200);
      display: flex;
      justify-content: space-between;
    }

    .recent-request-ref {
      font-weight: 500;
      color: var(--neutral-700);
    }

    .recent-request-cost {
      color: var(--success);
    }

    /* ===== Search Modal ===== */
    .search-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 1999;
      opacity: 0;
      visibility: hidden;
      transition: opacity var(--transition-normal), visibility var(--transition-normal);
    }

    .search-backdrop.open {
      opacity: 1;
      visibility: visible;
    }

    .search-modal {
      position: fixed;
      top: 20%;
      left: 50%;
      transform: translateX(-50%);
      width: 90%;
      max-width: 500px;
      background: var(--panel-bg);
      border-radius: 12px;
      box-shadow: var(--shadow-xl);
      z-index: 2000;
      overflow: hidden;
      opacity: 0;
      visibility: hidden;
      transition: opacity var(--transition-normal), visibility var(--transition-normal);
    }

    .search-modal.open {
      opacity: 1;
      visibility: visible;
    }

    .search-input-wrapper {
      display: flex;
      align-items: center;
      padding: var(--space-4);
      border-bottom: 1px solid var(--neutral-200);
    }

    .search-input-wrapper svg {
      width: 20px;
      height: 20px;
      color: var(--neutral-400);
      margin-right: var(--space-3);
      flex-shrink: 0;
    }

    .search-input {
      flex: 1;
      border: none;
      font-size: var(--text-lg);
      outline: none;
      background: transparent;
      color: var(--neutral-900);
    }

    .search-input::placeholder {
      color: var(--neutral-400);
    }

    .search-results {
      max-height: 300px;
      overflow-y: auto;
    }

    .search-result-item {
      padding: var(--space-3) var(--space-4);
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: background var(--transition-fast);
    }

    .search-result-item:hover,
    .search-result-item.highlighted {
      background: var(--primary-50);
    }

    .search-result-ref {
      font-weight: 500;
      color: var(--neutral-900);
    }

    .search-hint {
      padding: var(--space-3) var(--space-4);
      background: var(--neutral-100);
      font-size: var(--text-sm);
      color: var(--neutral-500);
      border-top: 1px solid var(--neutral-200);
    }

    .search-hint kbd {
      background: var(--neutral-200);
      padding: 2px 6px;
      border-radius: 4px;
      font-family: var(--font-mono);
      font-size: var(--text-xs);
      margin: 0 2px;
    }

    /* ===== Main Layout ===== */
    .main-container {
      display: flex;
      flex: 1;
      overflow: hidden;
    }

    /* ===== Bible Panel ===== */
    .bible-panel {
      flex: 1;
      padding: var(--space-8) var(--space-6);
      overflow-y: auto;
      background: var(--scripture-bg);
      display: flex;
      flex-direction: column;
      align-items: center;
      transition: background var(--transition-normal);
    }

    .bible-content {
      max-width: 700px;
      width: 100%;
    }

    .chapter-header {
      font-family: var(--font-scripture);
      font-size: var(--text-3xl);
      font-weight: 600;
      margin-bottom: var(--space-6);
      color: var(--neutral-900);
      padding-bottom: var(--space-4);
      border-bottom: 1px solid var(--neutral-200);
    }

    .verses-container {
      line-height: 2;
    }

    .verse {
      display: inline;
      cursor: pointer;
      padding: 2px 4px;
      margin: 0 -2px;
      border-radius: 4px;
      transition: background var(--transition-fast), box-shadow var(--transition-fast);
    }

    .verse:hover {
      background: var(--verse-hover);
    }

    .verse.selected {
      background: var(--selection-bg);
      box-shadow: inset 0 0 0 2px var(--selection-border);
    }

    .verse-num {
      font-family: var(--font-mono);
      font-size: var(--text-xs);
      font-weight: 600;
      color: var(--primary-500);
      vertical-align: super;
      margin-right: 3px;
      user-select: none;
    }

    .verse-text {
      font-family: var(--font-scripture);
      font-size: var(--text-lg);
      color: var(--neutral-700);
    }

    .instructions {
      text-align: center;
      padding: var(--space-10);
      color: var(--neutral-500);
    }

    .instructions p {
      margin-bottom: var(--space-2);
    }

    /* ===== Interpretation Panel ===== */
    .interpretation-panel {
      width: 450px;
      background: var(--panel-bg);
      border-left: 1px solid var(--neutral-200);
      display: flex;
      flex-direction: column;
      overflow: hidden;
      transform: translateX(0);
      transition: transform var(--transition-slow), background var(--transition-normal);
    }

    .interpretation-panel.hidden {
      transform: translateX(100%);
      position: absolute;
      right: 0;
      top: 0;
      bottom: 0;
    }

    .panel-header {
      padding: var(--space-4) var(--space-5);
      background: var(--neutral-100);
      border-bottom: 1px solid var(--neutral-200);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .panel-header h2 {
      font-size: var(--text-base);
      font-weight: 600;
      color: var(--neutral-900);
    }

    .close-panel {
      background: none;
      border: none;
      font-size: var(--text-xl);
      cursor: pointer;
      color: var(--neutral-500);
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 6px;
      transition: background var(--transition-fast), color var(--transition-fast);
    }

    .close-panel:hover {
      background: var(--neutral-200);
      color: var(--neutral-700);
    }

    .panel-content {
      flex: 1;
      overflow-y: auto;
      padding: var(--space-5);
      position: relative;
    }

    .selected-text {
      background: var(--selection-bg);
      padding: var(--space-3) var(--space-4);
      border-radius: 8px;
      margin-bottom: var(--space-5);
      font-family: var(--font-scripture);
      font-style: italic;
      font-size: var(--text-sm);
      color: var(--neutral-700);
      border-left: 3px solid var(--selection-border);
    }

    .section-title {
      font-size: var(--text-xs);
      font-weight: 600;
      color: var(--neutral-500);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin: var(--space-5) 0 var(--space-3);
      display: flex;
      align-items: center;
      gap: var(--space-2);
      cursor: pointer;
      user-select: none;
    }

    .section-title svg {
      width: 16px;
      height: 16px;
      transition: transform var(--transition-fast);
    }

    .section-title.collapsed svg {
      transform: rotate(-90deg);
    }

    .section-content {
      overflow: hidden;
      transition: max-height var(--transition-slow);
      max-height: 2000px;
    }

    .section-content.collapsed {
      max-height: 0;
    }

    .word-list {
      display: flex;
      flex-direction: column;
      gap: var(--space-3);
      margin-bottom: var(--space-5);
    }

    .word-item {
      padding: var(--space-3);
      background: var(--neutral-100);
      border-radius: 8px;
      border-left: 3px solid var(--primary-500);
    }

    .word-original {
      font-size: var(--text-lg);
      color: var(--neutral-900);
      font-weight: 600;
    }

    .word-transliteration {
      font-style: italic;
      color: var(--neutral-500);
      font-size: var(--text-sm);
    }

    .word-strongs {
      display: inline-block;
      font-size: var(--text-xs);
      background: var(--primary-500);
      color: white;
      padding: 2px 8px;
      border-radius: 4px;
      margin-top: var(--space-2);
    }

    .word-strongs a {
      color: white;
      text-decoration: none;
    }

    .word-strongs a:hover {
      text-decoration: underline;
    }

    .word-definition {
      margin-top: var(--space-2);
      font-size: var(--text-sm);
      color: var(--neutral-600);
    }

    .word-verse-badge {
      display: inline-block;
      font-size: var(--text-xs);
      background: var(--neutral-200);
      color: var(--neutral-600);
      padding: 2px 6px;
      border-radius: 4px;
      margin-left: var(--space-2);
      vertical-align: middle;
    }

    .interpretation-text {
      font-size: var(--text-sm);
      line-height: 1.8;
      color: var(--neutral-700);
    }

    .interpretation-text h2 {
      font-size: var(--text-lg);
      font-weight: 600;
      margin: var(--space-5) 0 var(--space-3);
      color: var(--neutral-900);
    }

    .interpretation-text h3 {
      font-size: var(--text-base);
      font-weight: 600;
      margin: var(--space-4) 0 var(--space-2);
      color: var(--neutral-900);
    }

    .interpretation-text p {
      margin-bottom: var(--space-4);
    }

    .interpretation-text strong {
      font-weight: 600;
      color: var(--neutral-900);
    }

    .interpretation-text em {
      font-style: italic;
    }

    .interpretation-text ul,
    .interpretation-text ol {
      margin: var(--space-3) 0;
      padding-left: var(--space-6);
    }

    .interpretation-text li {
      margin-bottom: var(--space-2);
    }

    /* ===== Panel Actions ===== */
    .panel-actions {
      display: flex;
      gap: var(--space-2);
      padding: var(--space-3) var(--space-5);
      border-top: 1px solid var(--neutral-200);
      background: var(--neutral-50);
    }

    .action-btn {
      display: flex;
      align-items: center;
      gap: var(--space-2);
      padding: var(--space-2) var(--space-3);
      border: 1px solid var(--neutral-200);
      border-radius: 6px;
      background: var(--panel-bg);
      color: var(--neutral-600);
      font-size: var(--text-sm);
      cursor: pointer;
      transition: all var(--transition-fast);
    }

    .action-btn:hover {
      border-color: var(--primary-500);
      color: var(--primary-600);
    }

    .action-btn svg {
      width: 16px;
      height: 16px;
    }

    .action-btn.copied {
      background: var(--success);
      border-color: var(--success);
      color: white;
    }

    /* ===== Loading State ===== */
    .loading-state {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: var(--space-10);
      color: var(--neutral-500);
    }

    .loading-state.hidden {
      display: none;
    }

    .spinner {
      width: 40px;
      height: 40px;
      border: 3px solid var(--neutral-200);
      border-top-color: var(--primary-500);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      margin-bottom: var(--space-4);
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .loading-state p {
      font-size: var(--text-sm);
    }

    /* ===== Toast ===== */
    .toast {
      position: fixed;
      bottom: var(--space-6);
      left: 50%;
      transform: translateX(-50%) translateY(100px);
      background: var(--neutral-900);
      color: white;
      padding: var(--space-3) var(--space-5);
      border-radius: 8px;
      font-size: var(--text-sm);
      box-shadow: var(--shadow-lg);
      transition: transform var(--transition-slow);
      z-index: 3000;
    }

    .toast.visible {
      transform: translateX(-50%) translateY(0);
    }

    /* ===== Floating Action Button ===== */
    .interpret-fab {
      position: fixed;
      bottom: var(--space-6);
      right: var(--space-6);
      background: var(--primary-500);
      color: white;
      border: none;
      padding: var(--space-4) var(--space-6);
      border-radius: 30px;
      font-size: var(--text-base);
      font-weight: 500;
      cursor: pointer;
      box-shadow: var(--shadow-lg);
      display: none;
      z-index: 100;
      transition: background var(--transition-fast), transform var(--transition-fast);
    }

    .interpret-fab:hover {
      background: var(--primary-600);
      transform: translateY(-2px);
    }

    .interpret-fab.visible {
      display: block;
      animation: fabBounce 0.5s ease;
    }

    @keyframes fabBounce {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-8px); }
    }

    /* ===== Keyboard Shortcuts Help ===== */
    .shortcuts-help {
      position: fixed;
      bottom: var(--space-4);
      left: var(--space-4);
      background: var(--neutral-800);
      color: var(--neutral-300);
      padding: var(--space-2) var(--space-3);
      border-radius: 6px;
      font-size: var(--text-xs);
      opacity: 0.7;
      transition: opacity var(--transition-fast);
    }

    .shortcuts-help:hover {
      opacity: 1;
    }

    .shortcuts-help kbd {
      display: inline-block;
      background: var(--neutral-600);
      padding: 2px 6px;
      border-radius: 3px;
      font-family: var(--font-mono);
      margin-right: var(--space-1);
    }

    /* ===== Loading Skeleton ===== */
    .skeleton-verse {
      display: flex;
      gap: var(--space-3);
      margin-bottom: var(--space-4);
      animation: shimmer 1.5s infinite;
    }

    .skeleton-num {
      width: 20px;
      height: 14px;
      background: var(--neutral-200);
      border-radius: 3px;
      flex-shrink: 0;
    }

    .skeleton-line {
      height: 18px;
      background: var(--neutral-200);
      border-radius: 4px;
      flex: 1;
    }

    .skeleton-line.short { width: 70%; flex: none; }
    .skeleton-line.medium { width: 85%; flex: none; }

    @keyframes shimmer {
      0%, 100% { opacity: 0.4; }
      50% { opacity: 1; }
    }

    /* ===== History Button ===== */
    .history-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 40px;
      height: 40px;
      border: none;
      border-radius: 8px;
      background: rgba(255,255,255,0.1);
      color: white;
      cursor: pointer;
      transition: background var(--transition-fast);
      position: relative;
    }

    .history-btn:hover { background: rgba(255,255,255,0.2); }
    .history-btn svg { width: 20px; height: 20px; }

    .history-btn .history-count {
      position: absolute;
      top: 2px;
      right: 2px;
      background: var(--primary-500);
      color: white;
      font-size: 10px;
      width: 16px;
      height: 16px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
    }

    /* ===== History Panel ===== */
    .history-modal {
      display: none;
      position: fixed;
      top: 60px;
      right: 100px;
      background: var(--panel-bg);
      border-radius: 12px;
      box-shadow: var(--shadow-xl);
      padding: var(--space-5);
      width: 360px;
      max-height: 500px;
      overflow-y: auto;
      z-index: 1000;
      color: var(--neutral-700);
    }

    .history-modal.visible { display: block; animation: fadeIn 0.2s ease; }

    .history-modal h3 {
      margin-bottom: var(--space-4);
      font-size: var(--text-base);
      color: var(--neutral-900);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .history-item {
      padding: var(--space-3);
      border: 1px solid var(--neutral-200);
      border-radius: 8px;
      margin-bottom: var(--space-2);
      cursor: pointer;
      transition: all var(--transition-fast);
    }

    .history-item:hover {
      border-color: var(--primary-500);
      background: var(--primary-50);
    }

    .history-item-ref {
      font-weight: 600;
      color: var(--neutral-900);
      font-size: var(--text-sm);
    }

    .history-item-preview {
      font-size: var(--text-xs);
      color: var(--neutral-500);
      margin-top: var(--space-1);
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .history-item-time {
      font-size: 10px;
      color: var(--neutral-400);
      margin-top: var(--space-1);
    }

    .history-clear {
      font-size: var(--text-xs);
      color: var(--error);
      background: none;
      border: none;
      cursor: pointer;
    }

    .history-clear:hover { text-decoration: underline; }

    .history-empty {
      text-align: center;
      color: var(--neutral-400);
      font-size: var(--text-sm);
      padding: var(--space-6) 0;
    }

    /* ===== Compare Translations Modal ===== */
    .compare-modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 1999;
      display: none;
    }

    .compare-modal-backdrop.visible { display: block; }

    .compare-modal {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 90%;
      max-width: 800px;
      max-height: 80vh;
      background: var(--panel-bg);
      border-radius: 12px;
      box-shadow: var(--shadow-xl);
      z-index: 2000;
      overflow: hidden;
      display: none;
    }

    .compare-modal.visible { display: flex; flex-direction: column; }

    .compare-header {
      padding: var(--space-4) var(--space-5);
      border-bottom: 1px solid var(--neutral-200);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .compare-header h3 {
      font-size: var(--text-base);
      font-weight: 600;
      color: var(--neutral-900);
    }

    .compare-body {
      flex: 1;
      overflow-y: auto;
      padding: var(--space-4);
    }

    .compare-row {
      display: grid;
      grid-template-columns: 80px 1fr;
      gap: var(--space-3);
      padding: var(--space-3) 0;
      border-bottom: 1px solid var(--neutral-100);
    }

    .compare-label {
      font-weight: 600;
      font-size: var(--text-sm);
      color: var(--primary-500);
    }

    .compare-text {
      font-family: var(--font-scripture);
      font-size: var(--text-sm);
      color: var(--neutral-700);
      line-height: 1.6;
    }

    /* ===== Search Count ===== */
    .search-count {
      padding: var(--space-2) var(--space-4);
      font-size: var(--text-xs);
      color: var(--neutral-400);
      border-bottom: 1px solid var(--neutral-100);
    }

    .search-result-item.keyboard-active {
      background: var(--primary-50);
      outline: 2px solid var(--primary-500);
      outline-offset: -2px;
    }

    /* ===== Compare Button in Panel ===== */
    .compare-btn {
      display: flex;
      align-items: center;
      gap: var(--space-2);
      padding: var(--space-2) var(--space-3);
      border: 1px solid var(--neutral-200);
      border-radius: 6px;
      background: var(--panel-bg);
      color: var(--neutral-600);
      font-size: var(--text-sm);
      cursor: pointer;
      transition: all var(--transition-fast);
    }

    .compare-btn:hover {
      border-color: var(--primary-500);
      color: var(--primary-600);
    }

    .compare-btn svg { width: 16px; height: 16px; }

    /* ===== Bible Content Wrapper (3-column layout) ===== */
    .bible-content-wrapper {
      display: grid;
      grid-template-columns: 1fr minmax(0, 260px);
      gap: var(--space-6);
      max-width: 1020px;
      width: 100%;
    }

    /* ===== Context Sidebar ===== */
    .context-sidebar {
      position: sticky;
      top: var(--space-4);
      align-self: start;
      display: flex;
      flex-direction: column;
      gap: var(--space-4);
    }

    .context-card, .toc-card, .notes-card {
      background: var(--panel-bg);
      border-radius: 10px;
      padding: var(--space-4);
      box-shadow: var(--shadow-sm);
      border: 1px solid var(--neutral-200);
    }

    .context-card h4, .toc-card h4, .notes-card h4 {
      font-size: var(--text-xs);
      font-weight: 600;
      color: var(--neutral-500);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-bottom: var(--space-3);
    }

    .context-row {
      display: flex;
      justify-content: space-between;
      padding: 5px 0;
      font-size: var(--text-xs);
      border-bottom: 1px solid var(--neutral-100);
    }

    .context-row:last-child { border-bottom: none; }

    .context-label {
      color: var(--neutral-500);
      font-weight: 500;
    }

    .context-value {
      color: var(--neutral-800);
      font-weight: 500;
      text-align: right;
      max-width: 60%;
    }

    /* ===== TOC ===== */
    .toc-item {
      display: flex;
      align-items: baseline;
      gap: var(--space-2);
      padding: 6px 0;
      cursor: pointer;
      border-bottom: 1px solid var(--neutral-100);
      transition: color var(--transition-fast);
    }

    .toc-item:last-child { border-bottom: none; }
    .toc-item:hover { color: var(--primary-500); }

    .toc-item-verses {
      font-size: 10px;
      font-family: var(--font-mono);
      color: var(--primary-500);
      white-space: nowrap;
      min-width: 36px;
    }

    .toc-item-title {
      font-size: var(--text-xs);
      color: var(--neutral-700);
      line-height: 1.3;
    }

    .toc-item:hover .toc-item-title { color: var(--primary-500); }

    .toc-generate {
      width: 100%;
      padding: 6px;
      border: 1px dashed var(--neutral-300);
      border-radius: 6px;
      background: transparent;
      color: var(--neutral-500);
      font-size: var(--text-xs);
      cursor: pointer;
      transition: all var(--transition-fast);
    }

    .toc-generate:hover {
      border-color: var(--primary-500);
      color: var(--primary-500);
    }

    /* ===== Highlight Palette ===== */
    .highlight-palette {
      position: fixed;
      bottom: calc(var(--space-6) + 52px);
      right: var(--space-6);
      background: var(--panel-bg);
      border-radius: 30px;
      padding: 6px 10px;
      box-shadow: var(--shadow-lg);
      display: none;
      align-items: center;
      gap: 6px;
      z-index: 101;
      border: 1px solid var(--neutral-200);
    }

    .highlight-palette.visible { display: flex; }

    .hl-dot {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      border: 2px solid transparent;
      cursor: pointer;
      transition: transform var(--transition-fast), border-color var(--transition-fast);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 11px;
    }

    .hl-dot:hover { transform: scale(1.2); }
    .hl-dot.active { border-color: var(--neutral-900); }
    .hl-dot[data-color="yellow"] { background: rgba(250, 204, 21, 0.6); }
    .hl-dot[data-color="green"] { background: rgba(34, 197, 94, 0.5); }
    .hl-dot[data-color="blue"] { background: rgba(59, 130, 246, 0.4); }
    .hl-dot[data-color="pink"] { background: rgba(244, 114, 182, 0.5); }
    .hl-dot[data-color="clear"] {
      background: var(--neutral-200);
      font-size: 12px;
      color: var(--neutral-600);
    }

    /* Highlighted verse styles */
    .verse[data-highlight="yellow"] { background: rgba(250, 204, 21, 0.2); border-radius: 3px; }
    .verse[data-highlight="green"] { background: rgba(34, 197, 94, 0.15); border-radius: 3px; }
    .verse[data-highlight="blue"] { background: rgba(59, 130, 246, 0.15); border-radius: 3px; }
    .verse[data-highlight="pink"] { background: rgba(244, 114, 182, 0.15); border-radius: 3px; }

    /* ===== Note Indicator ===== */
    .note-indicator {
      display: inline-block;
      font-size: 9px;
      color: var(--primary-500);
      margin-left: 1px;
      vertical-align: super;
      cursor: pointer;
    }

    /* ===== Note Editor (inline below verses) ===== */
    .note-editor-inline {
      display: block;
      margin: var(--space-2) 0 var(--space-3);
      padding: var(--space-3);
      background: var(--panel-bg);
      border: 1px solid var(--neutral-200);
      border-radius: 8px;
      box-shadow: var(--shadow-sm);
    }

    .note-editor-inline textarea {
      width: 100%;
      min-height: 60px;
      border: 1px solid var(--neutral-200);
      border-radius: 6px;
      padding: var(--space-2);
      font-family: var(--font-ui);
      font-size: var(--text-xs);
      resize: vertical;
      background: var(--neutral-50);
      color: var(--neutral-800);
    }

    .note-editor-inline textarea:focus {
      outline: 2px solid var(--primary-500);
      outline-offset: -1px;
    }

    .note-editor-actions {
      display: flex;
      gap: var(--space-2);
      margin-top: var(--space-2);
      justify-content: flex-end;
    }

    .note-editor-actions button {
      padding: 4px 12px;
      border-radius: 5px;
      font-size: var(--text-xs);
      cursor: pointer;
      border: 1px solid var(--neutral-200);
      background: var(--panel-bg);
      color: var(--neutral-600);
      transition: all var(--transition-fast);
    }

    .note-editor-actions .note-save-btn {
      background: var(--primary-500);
      color: white;
      border-color: var(--primary-500);
    }

    .note-editor-actions .note-save-btn:hover { background: var(--primary-600); }
    .note-editor-actions .note-delete-btn { color: var(--error); border-color: var(--error); }

    /* ===== Notes Panel Card ===== */
    .notes-card .note-item {
      padding: 6px 0;
      border-bottom: 1px solid var(--neutral-100);
      cursor: pointer;
      transition: color var(--transition-fast);
    }

    .notes-card .note-item:last-child { border-bottom: none; }
    .notes-card .note-item:hover { color: var(--primary-500); }

    .note-item-verse {
      font-size: 10px;
      font-weight: 600;
      color: var(--primary-500);
    }

    .note-item-text {
      font-size: var(--text-xs);
      color: var(--neutral-600);
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .notes-empty {
      font-size: var(--text-xs);
      color: var(--neutral-400);
      text-align: center;
      padding: var(--space-3) 0;
    }

    /* ===== Animations ===== */
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    @keyframes slideUp {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .verse {
      animation: slideUp 0.3s ease backwards;
    }

    /* ===== Reduced Motion ===== */
    @media (prefers-reduced-motion: reduce) {
      *, *::before, *::after {
        animation-duration: 0.01ms !important;
        transition-duration: 0.01ms !important;
      }
    }

    /* ===== Mobile Responsive ===== */
    @media (max-width: 768px) {
      header {
        flex-wrap: wrap;
        padding: var(--space-3);
        gap: var(--space-3);
      }

      header h1 {
        font-size: var(--text-base);
      }

      .nav-controls {
        order: 2;
        width: 100%;
      }

      .nav-controls select {
        flex: 1;
        min-width: 0;
      }

      .header-actions {
        margin-left: auto;
      }

      .main-container {
        flex-direction: column;
      }

      .bible-panel {
        padding: var(--space-4);
      }

      .bible-content {
        max-width: 100%;
      }

      .interpretation-panel {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        width: 100%;
        height: 60vh;
        border-radius: 16px 16px 0 0;
        border-left: none;
        box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.15);
        transform: translateY(100%);
      }

      .interpretation-panel:not(.hidden) {
        transform: translateY(0);
      }

      .interpretation-panel.hidden {
        position: fixed;
      }

      .interpret-fab {
        bottom: var(--space-4);
        right: var(--space-4);
        left: var(--space-4);
        width: auto;
        text-align: center;
      }

      .shortcuts-help {
        display: none;
      }

      .bible-content-wrapper {
        grid-template-columns: 1fr;
      }

      .context-sidebar {
        position: static;
        order: -1;
      }

      .search-modal {
        top: 0;
        width: 100%;
        max-width: none;
        height: 100vh;
        border-radius: 0;
      }
    }
  </style>
</head>
<body>
  <a href="#verses-container" class="sr-only">Skip to content</a>

  <header>
    <h1>Bible Interpreter</h1>
    <div class="nav-controls">
      <button class="nav-btn" id="prev-chapter" title="Previous Chapter" aria-label="Previous chapter">
        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/></svg>
      </button>
      <select id="book-select" aria-label="Select book"></select>
      <select id="chapter-select" aria-label="Select chapter"></select>
      <button class="nav-btn" id="next-chapter" title="Next Chapter" aria-label="Next chapter">
        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg>
      </button>
      <button class="go-btn" id="load-chapter">Go</button>
    </div>
    <div class="header-actions">
      <select id="version-select" class="version-select" aria-label="Select Bible version" title="Bible version">
        <option value="NIV2011">NIV</option>
        <option value="ESV">ESV</option>
        <option value="KJV">KJV</option>
        <option value="NLT">NLT</option>
        <option value="NKJV">NKJV</option>
        <option value="CSB17">CSB</option>
        <option value="NASB">NASB</option>
        <option value="MSG">MSG</option>
        <option value="AMP">AMP</option>
      </select>
      <button class="history-btn" id="history-btn" title="Interpretation History" aria-label="View interpretation history">
        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
        <span class="history-count" id="history-count" style="display:none">0</span>
      </button>
      <button class="theme-toggle" id="theme-toggle" title="Toggle dark mode" aria-label="Toggle dark mode">
        <svg class="moon-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"/></svg>
        <svg class="sun-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"/></svg>
      </button>
      <div class="usage-badge" id="usage-badge" title="Click to view API usage" role="button" tabindex="0">
        API: <span id="usage-cost">$0.00</span>
      </div>
    </div>
  </header>

  <div class="usage-modal" id="usage-modal" role="dialog" aria-labelledby="usage-modal-title">
    <h3 id="usage-modal-title">API Usage</h3>
    <div class="usage-cost" id="usage-total-cost">$0.0000</div>
    <div class="usage-stat">
      <span class="usage-stat-label">Total Requests</span>
      <span class="usage-stat-value" id="usage-requests">0</span>
    </div>
    <div class="usage-stat">
      <span class="usage-stat-label">Input Tokens</span>
      <span class="usage-stat-value" id="usage-input">0</span>
    </div>
    <div class="usage-stat">
      <span class="usage-stat-label">Output Tokens</span>
      <span class="usage-stat-value" id="usage-output">0</span>
    </div>
    <div class="recent-requests" id="recent-requests">
      <div class="usage-stat"><span class="usage-stat-label">Recent Requests</span></div>
    </div>
    <button class="usage-reset" id="usage-reset">Reset Usage Stats</button>
  </div>

  <div class="history-modal" id="history-modal" role="dialog" aria-label="Interpretation history">
    <h3>History <button class="history-clear" id="history-clear">Clear All</button></h3>
    <div id="history-list"></div>
  </div>

  <div class="compare-modal-backdrop" id="compare-backdrop"></div>
  <div class="compare-modal" id="compare-modal" role="dialog" aria-label="Compare translations">
    <div class="compare-header">
      <h3 id="compare-title">Compare Translations</h3>
      <button class="close-panel" id="close-compare" aria-label="Close">&times;</button>
    </div>
    <div class="compare-body" id="compare-body"></div>
  </div>

  <div class="search-backdrop" id="search-backdrop"></div>
  <div class="search-modal" id="search-modal" role="dialog" aria-labelledby="search-title">
    <div class="search-input-wrapper">
      <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>
      <input type="text" class="search-input" id="search-input" placeholder="Jump to reference (e.g., John 3:16)" aria-label="Search for a Bible reference">
    </div>
    <div class="search-results" id="search-results"></div>
    <div class="search-hint">
      Press <kbd>Enter</kbd> to go, <kbd>Esc</kbd> to close
    </div>
  </div>

  <main class="main-container" role="main">
    <div class="bible-panel" id="bible-panel" aria-label="Bible text">
      <div class="bible-content-wrapper">
        <div class="bible-content">
          <div class="instructions" id="instructions">
            <p>Select a book and chapter above to start reading.</p>
            <p>Click on verses to select them, then interpret.</p>
            <p style="margin-top: var(--space-4); font-size: var(--text-sm);">
              Press <kbd style="background: var(--neutral-200); padding: 2px 6px; border-radius: 4px; font-family: var(--font-mono);">/</kbd> to search
            </p>
          </div>
          <h2 class="chapter-header" id="chapter-header" style="display:none;"></h2>
          <div class="verses-container" id="verses-container" role="list" aria-label="Bible verses"></div>
        </div>
        <div class="context-sidebar" id="context-sidebar" style="display:none">
          <div class="context-card" id="context-card">
            <h4>Book Context</h4>
            <div id="context-rows"></div>
          </div>
          <div class="toc-card" id="toc-card">
            <h4>Chapter Outline</h4>
            <div id="toc-list"></div>
          </div>
          <div class="notes-card" id="notes-card">
            <h4>My Notes</h4>
            <div id="notes-list"></div>
          </div>
        </div>
      </div>
    </div>

    <aside class="interpretation-panel hidden" id="interpretation-panel" aria-label="Interpretation results" aria-live="polite">
      <div class="panel-header">
        <h2>Interpretation</h2>
        <button class="close-panel" id="close-panel" aria-label="Close panel">&times;</button>
      </div>
      <div class="panel-content" id="panel-content">
        <div class="loading-state hidden" id="panel-loading">
          <div class="spinner"></div>
          <p>Analyzing Greek and Hebrew roots...</p>
        </div>
        <div id="interpretation-content">
          <div class="selected-text" id="selected-text"></div>
          <div class="section-title" id="words-toggle">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
            Key Words
          </div>
          <div class="section-content" id="words-section">
            <div class="word-list" id="word-list"></div>
          </div>
          <div class="section-title" id="interpretation-toggle">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
            Interpretation
          </div>
          <div class="section-content" id="interpretation-section">
            <div class="interpretation-text" id="interpretation-text"></div>
          </div>
        </div>
      </div>
      <div class="panel-actions">
        <button class="action-btn" id="copy-btn" title="Copy to clipboard">
          <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/></svg>
          <span>Copy</span>
        </button>
        <button class="action-btn compare-btn" id="compare-btn" title="Compare translations">
          <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17V7m0 10a2 2 0 01-2 2H5a2 2 0 01-2-2V7a2 2 0 012-2h2a2 2 0 012 2m0 10a2 2 0 002 2h2a2 2 0 002-2M9 7a2 2 0 012-2h2a2 2 0 012 2m0 10V7m0 10a2 2 0 002 2h2a2 2 0 002-2V7a2 2 0 00-2-2h-2a2 2 0 00-2 2"/></svg>
          <span>Compare</span>
        </button>
        <button class="action-btn" id="share-btn" title="Share">
          <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z"/></svg>
          <span>Share</span>
        </button>
      </div>
    </aside>
  </main>

  <div class="highlight-palette" id="highlight-palette">
    <span class="hl-dot" data-color="yellow" title="Yellow"></span>
    <span class="hl-dot" data-color="green" title="Green"></span>
    <span class="hl-dot" data-color="blue" title="Blue"></span>
    <span class="hl-dot" data-color="pink" title="Pink"></span>
    <span class="hl-dot" data-color="clear" title="Clear">&#10005;</span>
  </div>
  <button class="interpret-fab" id="interpret-fab" aria-describedby="fab-description">Interpret Selection</button>
  <span id="fab-description" class="sr-only">Analyze selected verses with Greek and Hebrew insights</span>

  <div class="toast" id="toast"></div>

  <div class="shortcuts-help">
    <kbd>/</kbd> Search &nbsp; <kbd>D</kbd> Dark mode &nbsp; <kbd>Esc</kbd> Close
  </div>

  <style>.sr-only { position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0,0,0,0); white-space: nowrap; border: 0; }</style>

  <script>
    // ===== Book Data =====
    const BOOKS = [
      { name: 'Genesis', chapters: 50 }, { name: 'Exodus', chapters: 40 },
      { name: 'Leviticus', chapters: 27 }, { name: 'Numbers', chapters: 36 },
      { name: 'Deuteronomy', chapters: 34 }, { name: 'Joshua', chapters: 24 },
      { name: 'Judges', chapters: 21 }, { name: 'Ruth', chapters: 4 },
      { name: '1 Samuel', chapters: 31 }, { name: '2 Samuel', chapters: 24 },
      { name: '1 Kings', chapters: 22 }, { name: '2 Kings', chapters: 25 },
      { name: '1 Chronicles', chapters: 29 }, { name: '2 Chronicles', chapters: 36 },
      { name: 'Ezra', chapters: 10 }, { name: 'Nehemiah', chapters: 13 },
      { name: 'Esther', chapters: 10 }, { name: 'Job', chapters: 42 },
      { name: 'Psalms', chapters: 150 }, { name: 'Proverbs', chapters: 31 },
      { name: 'Ecclesiastes', chapters: 12 }, { name: 'Song of Solomon', chapters: 8 },
      { name: 'Isaiah', chapters: 66 }, { name: 'Jeremiah', chapters: 52 },
      { name: 'Lamentations', chapters: 5 }, { name: 'Ezekiel', chapters: 48 },
      { name: 'Daniel', chapters: 12 }, { name: 'Hosea', chapters: 14 },
      { name: 'Joel', chapters: 3 }, { name: 'Amos', chapters: 9 },
      { name: 'Obadiah', chapters: 1 }, { name: 'Jonah', chapters: 4 },
      { name: 'Micah', chapters: 7 }, { name: 'Nahum', chapters: 3 },
      { name: 'Habakkuk', chapters: 3 }, { name: 'Zephaniah', chapters: 3 },
      { name: 'Haggai', chapters: 2 }, { name: 'Zechariah', chapters: 14 },
      { name: 'Malachi', chapters: 4 },
      { name: 'Matthew', chapters: 28 }, { name: 'Mark', chapters: 16 },
      { name: 'Luke', chapters: 24 }, { name: 'John', chapters: 21 },
      { name: 'Acts', chapters: 28 }, { name: 'Romans', chapters: 16 },
      { name: '1 Corinthians', chapters: 16 }, { name: '2 Corinthians', chapters: 13 },
      { name: 'Galatians', chapters: 6 }, { name: 'Ephesians', chapters: 6 },
      { name: 'Philippians', chapters: 4 }, { name: 'Colossians', chapters: 4 },
      { name: '1 Thessalonians', chapters: 5 }, { name: '2 Thessalonians', chapters: 3 },
      { name: '1 Timothy', chapters: 6 }, { name: '2 Timothy', chapters: 4 },
      { name: 'Titus', chapters: 3 }, { name: 'Philemon', chapters: 1 },
      { name: 'Hebrews', chapters: 13 }, { name: 'James', chapters: 5 },
      { name: '1 Peter', chapters: 5 }, { name: '2 Peter', chapters: 3 },
      { name: '1 John', chapters: 5 }, { name: '2 John', chapters: 1 },
      { name: '3 John', chapters: 1 }, { name: 'Jude', chapters: 1 },
      { name: 'Revelation', chapters: 22 }
    ];

    // Book aliases for search
    const BOOK_ALIASES = {
      'gen': 0, 'ex': 1, 'lev': 2, 'num': 3, 'deut': 4, 'josh': 5, 'judg': 6, 'ru': 7,
      '1sam': 8, '2sam': 9, '1ki': 10, '2ki': 11, '1chr': 12, '2chr': 13,
      'ezr': 14, 'neh': 15, 'est': 16, 'ps': 18, 'psa': 18, 'prov': 19, 'eccl': 20,
      'song': 21, 'isa': 22, 'jer': 23, 'lam': 24, 'ezek': 25, 'dan': 26,
      'hos': 27, 'am': 29, 'ob': 30, 'jon': 31, 'mic': 32, 'nah': 33, 'hab': 34,
      'zeph': 35, 'hag': 36, 'zech': 37, 'mal': 38,
      'matt': 39, 'mt': 39, 'mk': 40, 'lk': 41, 'jn': 42, 'jhn': 42,
      'rom': 45, '1cor': 46, '2cor': 47, 'gal': 48, 'eph': 49, 'phil': 50, 'php': 50,
      'col': 51, '1thess': 52, '2thess': 53, '1tim': 54, '2tim': 55, 'tit': 56,
      'phlm': 57, 'heb': 58, 'jas': 59, '1pet': 60, '2pet': 61,
      '1jn': 62, '2jn': 63, '3jn': 64, 'rev': 65
    };

    // ===== DOM Elements =====
    const bookSelect = document.getElementById('book-select');
    const chapterSelect = document.getElementById('chapter-select');
    const loadChapterBtn = document.getElementById('load-chapter');
    const prevChapterBtn = document.getElementById('prev-chapter');
    const nextChapterBtn = document.getElementById('next-chapter');
    const versesContainer = document.getElementById('verses-container');
    const chapterHeader = document.getElementById('chapter-header');
    const instructions = document.getElementById('instructions');
    const interpretPanel = document.getElementById('interpretation-panel');
    const closePanel = document.getElementById('close-panel');
    const panelLoading = document.getElementById('panel-loading');
    const interpretationContent = document.getElementById('interpretation-content');
    const selectedTextEl = document.getElementById('selected-text');
    const wordList = document.getElementById('word-list');
    const interpretationText = document.getElementById('interpretation-text');
    const interpretFab = document.getElementById('interpret-fab');
    const themeToggle = document.getElementById('theme-toggle');
    const searchModal = document.getElementById('search-modal');
    const searchBackdrop = document.getElementById('search-backdrop');
    const searchInput = document.getElementById('search-input');
    const searchResults = document.getElementById('search-results');
    const toast = document.getElementById('toast');
    const versionSelect = document.getElementById('version-select');

	    // ===== State =====
	    let selectedVerses = new Set();
	    let currentBook = '';
	    let currentChapter = 0;
	    let currentBookIndex = 0;

	    function getSelectedRange() {
	      const sortedVerses = [...selectedVerses].sort((a, b) => a - b);
	      return {
	        sortedVerses,
	        startVerse: sortedVerses[0],
	        endVerse: sortedVerses[sortedVerses.length - 1],
	      };
	    }

	    async function getResponseError(response, fallback) {
	      try {
	        const data = await response.json();
	        if (data && data.error) return data.error;
	      } catch (e) {
	        // ignore
	      }
	      return fallback;
	    }

	    // ===== Theme =====
	    function initTheme() {
	      const stored = localStorage.getItem('bible-theme');
      const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
      if (stored === 'dark' || (!stored && prefersDark)) {
        document.documentElement.classList.add('dark');
      }
    }

    function toggleDarkMode() {
      const isDark = document.documentElement.classList.toggle('dark');
      localStorage.setItem('bible-theme', isDark ? 'dark' : 'light');
      showToast(isDark ? 'Dark mode enabled' : 'Light mode enabled');
    }

    themeToggle.addEventListener('click', toggleDarkMode);
    initTheme();

    // ===== Version Selection =====
    function initVersion() {
      const stored = localStorage.getItem('bible-version');
      if (stored && versionSelect.querySelector(`option[value="${stored}"]`)) {
        versionSelect.value = stored;
      }
    }

    versionSelect.addEventListener('change', () => {
      localStorage.setItem('bible-version', versionSelect.value);
      showToast(`Switched to ${versionSelect.options[versionSelect.selectedIndex].text}`);
      // Reload current chapter if one is loaded
      if (currentBook) {
        loadChapter();
      }
    });

    initVersion();

    // ===== Book/Chapter Navigation =====
    BOOKS.forEach((book, index) => {
      const option = document.createElement('option');
      option.value = index;
      option.textContent = book.name;
      bookSelect.appendChild(option);
    });

    bookSelect.addEventListener('change', () => {
      const bookIndex = parseInt(bookSelect.value);
      const book = BOOKS[bookIndex];
      chapterSelect.textContent = '';
      for (let i = 1; i <= book.chapters; i++) {
        const option = document.createElement('option');
        option.value = i;
        option.textContent = i;
        chapterSelect.appendChild(option);
      }
      updateNavButtons();
    });

    function updateNavButtons() {
      const bookIndex = parseInt(bookSelect.value);
      const chapter = parseInt(chapterSelect.value);
      prevChapterBtn.disabled = (bookIndex === 0 && chapter === 1);
      nextChapterBtn.disabled = (bookIndex === BOOKS.length - 1 && chapter === BOOKS[bookIndex].chapters);
    }

    chapterSelect.addEventListener('change', updateNavButtons);

    prevChapterBtn.addEventListener('click', () => {
      let bookIndex = parseInt(bookSelect.value);
      let chapter = parseInt(chapterSelect.value);
      if (chapter > 1) {
        chapterSelect.value = chapter - 1;
      } else if (bookIndex > 0) {
        bookIndex--;
        bookSelect.value = bookIndex;
        bookSelect.dispatchEvent(new Event('change'));
        chapterSelect.value = BOOKS[bookIndex].chapters;
      }
      loadChapter();
    });

    nextChapterBtn.addEventListener('click', () => {
      let bookIndex = parseInt(bookSelect.value);
      let chapter = parseInt(chapterSelect.value);
      if (chapter < BOOKS[bookIndex].chapters) {
        chapterSelect.value = chapter + 1;
      } else if (bookIndex < BOOKS.length - 1) {
        bookIndex++;
        bookSelect.value = bookIndex;
        bookSelect.dispatchEvent(new Event('change'));
        chapterSelect.value = 1;
      }
      loadChapter();
    });

    // Initialize with John 3
    bookSelect.value = 42;
    bookSelect.dispatchEvent(new Event('change'));
    chapterSelect.value = 3;
    updateNavButtons();

    loadChapterBtn.addEventListener('click', loadChapter);

	    async function loadChapter() {
	      const bookIndex = parseInt(bookSelect.value);
	      const book = BOOKS[bookIndex];
	      const chapter = parseInt(chapterSelect.value);

      currentBook = book.name;
      currentChapter = chapter;
      currentBookIndex = bookIndex;

      instructions.style.display = 'none';
      chapterHeader.style.display = 'block';
      chapterHeader.textContent = book.name + ' ' + chapter;
      if (typeof showLoadingSkeleton === 'function') showLoadingSkeleton(); else versesContainer.textContent = 'Loading...';

      updateNavButtons();

	      try {
	        const translation = versionSelect.value;
	        const response = await fetch('/api/chapter', {
	          method: 'POST',
	          headers: { 'Content-Type': 'application/json' },
	          body: JSON.stringify({ book: book.name, chapter, translation })
	        });

	        if (!response.ok) {
	          throw new Error(await getResponseError(response, 'Failed to load chapter'));
	        }

	        const data = await response.json();
	        displayVerses(data.verses);
	        if (typeof applyHighlights === 'function') applyHighlights();
	        if (typeof refreshNoteIndicators === 'function') refreshNoteIndicators();
	        if (typeof updateSidebar === 'function') updateSidebar();
	      } catch (err) {
	        versesContainer.textContent = 'Error loading chapter: ' + err.message;
      }
    }

    function displayVerses(verses) {
      versesContainer.textContent = '';
      selectedVerses.clear();
      updateFab();

      verses.forEach((v, i) => {
        const verseSpan = document.createElement('span');
        verseSpan.className = 'verse';
        verseSpan.dataset.verse = v.verse;
        verseSpan.setAttribute('role', 'listitem');
        verseSpan.style.animationDelay = `${Math.min(i * 0.02, 0.5)}s`;

        const numSpan = document.createElement('sup');
        numSpan.className = 'verse-num';
        numSpan.textContent = v.verse;

	        const textSpan = document.createElement('span');
	        textSpan.className = 'verse-text';
	        textSpan.textContent = v.text + ' ';

	        verseSpan.appendChild(numSpan);
	        verseSpan.appendChild(textSpan);
	        verseSpan.addEventListener('click', () => toggleVerse(v.verse));

	        versesContainer.appendChild(verseSpan);
	      });
	    }

	    function syncVerseSelectionUI() {
	      document.querySelectorAll('.verse').forEach(el => {
	        const verseNum = parseInt(el.dataset.verse);
	        el.classList.toggle('selected', selectedVerses.has(verseNum));
	      });
	    }

	    function toggleVerse(verseNum) {
	      if (selectedVerses.size === 0) {
	        selectedVerses.add(verseNum);
	        syncVerseSelectionUI();
	        updateFab();
	        return;
	      }

	      const { startVerse, endVerse } = getSelectedRange();

	      // Keep selection as a contiguous range, since analysis is range-based.
	      if (verseNum >= startVerse && verseNum <= endVerse) {
	        if (startVerse === endVerse) {
	          selectedVerses.clear();
	        } else {
	          selectedVerses = new Set([verseNum]);
	        }
	      } else {
	        const min = Math.min(startVerse, verseNum);
	        const max = Math.max(endVerse, verseNum);
	        selectedVerses = new Set();
	        for (let v = min; v <= max; v++) selectedVerses.add(v);
	      }

	      syncVerseSelectionUI();
	      updateFab();
	    }

	    function clearSelection() {
	      selectedVerses.clear();
	      syncVerseSelectionUI();
	      updateFab();
	    }

    function updateFab() {
      if (selectedVerses.size > 0) {
        interpretFab.classList.add('visible');
        const sorted = [...selectedVerses].sort((a, b) => a - b);
        interpretFab.textContent = sorted.length === 1
          ? 'Interpret Verse ' + sorted[0]
          : 'Interpret ' + sorted.length + ' Verses';
      } else {
        interpretFab.classList.remove('visible');
      }
      if (typeof updateHighlightPalette === 'function') updateHighlightPalette();
    }

    // ===== Interpretation =====
    interpretFab.addEventListener('click', interpretSelection);

	    async function interpretSelection() {
	      if (selectedVerses.size === 0) return;

	      const { sortedVerses, startVerse, endVerse } = getSelectedRange();

	      const reference = endVerse > startVerse
	        ? currentBook + ' ' + currentChapter + ':' + startVerse + '-' + endVerse
	        : currentBook + ' ' + currentChapter + ':' + startVerse;

      const selectedText = sortedVerses.map(v => {
        const el = document.querySelector('.verse[data-verse="' + v + '"] .verse-text');
        return v + ' ' + (el ? el.textContent.trim() : '');
      }).join(' ');

      interpretPanel.classList.remove('hidden');
      selectedTextEl.textContent = selectedText;
      panelLoading.classList.remove('hidden');
      interpretationContent.style.display = 'none';
      wordList.textContent = '';
      interpretationText.textContent = '';

	      try {
	        const translation = versionSelect.value;
	        const response = await fetch('/api/analyze', {
	          method: 'POST',
	          headers: { 'Content-Type': 'application/json' },
	          body: JSON.stringify({ reference, translation })
	        });

	        if (!response.ok) {
	          throw new Error(await getResponseError(response, 'Failed to analyze'));
	        }

	        const data = await response.json();
	        displayInterpretation(data);
	        fetchUsage();
	        if (typeof saveToHistory === 'function') saveToHistory(reference, data);
	      } catch (err) {
        interpretationText.textContent = 'Error: ' + err.message;
        interpretationContent.style.display = 'block';
      } finally {
        panelLoading.classList.add('hidden');
      }
    }

	    function escapeHtml(text) {
	      return String(text)
	        .replace(/&/g, '&amp;')
	        .replace(/</g, '&lt;')
	        .replace(/>/g, '&gt;')
	        .replace(/"/g, '&quot;')
	        .replace(/'/g, '&#39;');
	    }

	    function renderMarkdown(text) {
	      if (!text) return '';
	      return escapeHtml(text)
	        .replace(/^### (.*$)/gm, '<h4>$1</h4>')
	        .replace(/^## (.*$)/gm, '<h3>$1</h3>')
	        .replace(/^# (.*$)/gm, '<h2>$1</h2>')
	        .replace(/\*\*\*(.*?)\*\*\*/g, '<strong><em>$1</em></strong>')
        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
        .replace(/\*(.*?)\*/g, '<em>$1</em>')
        .replace(/\n\n/g, '</p><p>')
        .replace(/^/, '<p>')
        .replace(/$/, '</p>');
    }

    function displayInterpretation(data) {
      wordList.textContent = '';
      if (data.words && data.words.length > 0) {
        data.words.forEach(word => {
          const item = document.createElement('div');
          item.className = 'word-item';

          const original = document.createElement('div');
          original.className = 'word-original';
          original.textContent = word.original || '';
          item.appendChild(original);

          if (word.transliteration) {
            const translit = document.createElement('div');
            translit.className = 'word-transliteration';
            translit.textContent = word.transliteration;
            item.appendChild(translit);
          }

          if (word.strongs) {
            const strongs = document.createElement('span');
            strongs.className = 'word-strongs';
            const link = document.createElement('a');
            const isHebrew = word.strongs.toUpperCase().startsWith('H');
            const strongsNum = word.strongs.replace(/[^\d]/g, '');
            link.href = isHebrew
              ? 'https://biblehub.com/hebrew/' + strongsNum + '.htm'
              : 'https://biblehub.com/greek/' + strongsNum + '.htm';
            link.target = '_blank';
            link.rel = 'noopener';
            link.textContent = "Strong's " + word.strongs;
            strongs.appendChild(link);
            item.appendChild(strongs);
          }

          if (word.verse) {
            const verseBadge = document.createElement('span');
            verseBadge.className = 'word-verse-badge';
            verseBadge.textContent = 'v.' + word.verse;
            item.appendChild(verseBadge);
          }

          if (word.definition) {
            const def = document.createElement('div');
            def.className = 'word-definition';
            def.textContent = word.definition;
            item.appendChild(def);
          }

          wordList.appendChild(item);
        });
      } else {
        const noWords = document.createElement('div');
        noWords.textContent = 'Word-level data analyzed by AI below.';
        noWords.style.color = 'var(--neutral-500)';
        noWords.style.fontStyle = 'italic';
        noWords.style.fontSize = 'var(--text-sm)';
        wordList.appendChild(noWords);
      }

      interpretationText.innerHTML = renderMarkdown(data.interpretation || 'No interpretation available.');
      interpretationContent.style.display = 'block';
    }

    closePanel.addEventListener('click', () => {
      interpretPanel.classList.add('hidden');
    });

    // ===== Collapsible Sections =====
    document.getElementById('words-toggle').addEventListener('click', function() {
      this.classList.toggle('collapsed');
      document.getElementById('words-section').classList.toggle('collapsed');
    });

    document.getElementById('interpretation-toggle').addEventListener('click', function() {
      this.classList.toggle('collapsed');
      document.getElementById('interpretation-section').classList.toggle('collapsed');
    });

	    // ===== Panel Actions =====
	    document.getElementById('copy-btn').addEventListener('click', async () => {
	      const { startVerse, endVerse } = getSelectedRange();
	      const reference = endVerse > startVerse
	        ? `${currentBook} ${currentChapter}:${startVerse}-${endVerse}`
	        : `${currentBook} ${currentChapter}:${startVerse}`;
	      const text = `${reference}\n\n${selectedTextEl.textContent}\n\n${interpretationText.textContent}`;
	      try {
	        await navigator.clipboard.writeText(text);
	        const btn = document.getElementById('copy-btn');
	        btn.classList.add('copied');
	        btn.querySelector('span').textContent = 'Copied!';
        setTimeout(() => {
          btn.classList.remove('copied');
          btn.querySelector('span').textContent = 'Copy';
        }, 2000);
        showToast('Copied to clipboard');
      } catch (err) {
        showToast('Failed to copy');
      }
    });

    document.getElementById('share-btn').addEventListener('click', async () => {
      const shareData = {
        title: `${currentBook} ${currentChapter}`,
        text: interpretationText.textContent.substring(0, 200) + '...',
        url: window.location.href
      };

      if (navigator.share) {
        try {
          await navigator.share(shareData);
        } catch (err) {
          if (err.name !== 'AbortError') {
            await navigator.clipboard.writeText(window.location.href);
            showToast('Link copied');
          }
        }
      } else {
        await navigator.clipboard.writeText(window.location.href);
        showToast('Link copied to clipboard');
      }
    });

    // ===== Toast =====
    function showToast(message) {
      toast.textContent = message;
      toast.classList.add('visible');
      setTimeout(() => toast.classList.remove('visible'), 3000);
    }

    // ===== Search Modal =====
    function openSearch() {
      searchModal.classList.add('open');
      searchBackdrop.classList.add('open');
      searchInput.value = '';
      searchResults.textContent = '';
      searchInput.focus();
    }

    function closeSearch() {
      searchModal.classList.remove('open');
      searchBackdrop.classList.remove('open');
    }

    searchBackdrop.addEventListener('click', closeSearch);

	    searchInput.addEventListener('input', () => {
	      const query = searchInput.value.trim().toLowerCase();
	      searchResults.textContent = '';

	      if (!query) return;

	      // Parse reference
	      const match = query.match(/^(.+?)\s*(\d+)?(?::(\d+))?/i);
	      if (match) {
	        const [, bookPart, chapter, verse] = match;
	        const bookName = bookPart.replace(/\s+/g, '').toLowerCase();

        // Find matching books
        const matches = [];
        BOOKS.forEach((book, index) => {
          const name = book.name.toLowerCase().replace(/\s+/g, '');
          if (name.startsWith(bookName) || (BOOK_ALIASES[bookName] === index)) {
            matches.push({ book, index, chapter: chapter || 1, verse });
          }
        });

        matches.slice(0, 5).forEach(m => {
          const item = document.createElement('div');
          item.className = 'search-result-item';

          const ref = document.createElement('span');
          ref.className = 'search-result-ref';
          ref.textContent = m.book.name + (m.chapter ? ' ' + m.chapter : '') + (m.verse ? ':' + m.verse : '');

          item.appendChild(ref);
          item.addEventListener('click', () => {
            bookSelect.value = m.index;
            bookSelect.dispatchEvent(new Event('change'));
            chapterSelect.value = m.chapter;
            loadChapter();
            closeSearch();
          });

          searchResults.appendChild(item);
        });
      }
    });

    searchInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        const firstResult = searchResults.querySelector('.search-result-item');
        if (firstResult) firstResult.click();
      } else if (e.key === 'Escape') {
        closeSearch();
      }
    });

    // ===== Keyboard Shortcuts =====
    document.addEventListener('keydown', (e) => {
      if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;

      switch(e.code) {
        case 'ArrowLeft':
          if (!prevChapterBtn.disabled) prevChapterBtn.click();
          break;
        case 'ArrowRight':
          if (!nextChapterBtn.disabled) nextChapterBtn.click();
          break;
        case 'Escape':
          if (searchModal.classList.contains('open')) {
            closeSearch();
          } else {
            clearSelection();
            interpretPanel.classList.add('hidden');
          }
          break;
        case 'Enter':
          if (selectedVerses.size > 0) interpretSelection();
          break;
        case 'KeyD':
          toggleDarkMode();
          break;
        case 'Slash':
          e.preventDefault();
          openSearch();
          break;
      }
    });

    // Cmd/Ctrl+F for search
    document.addEventListener('keydown', (e) => {
      if ((e.metaKey || e.ctrlKey) && e.key === 'f') {
        e.preventDefault();
        openSearch();
      }
    });

    // ===== Usage Tracking =====
    const usageBadge = document.getElementById('usage-badge');
    const usageModal = document.getElementById('usage-modal');
    const usageCost = document.getElementById('usage-cost');
    const usageTotalCost = document.getElementById('usage-total-cost');
    const usageRequests = document.getElementById('usage-requests');
    const usageInput = document.getElementById('usage-input');
    const usageOutput = document.getElementById('usage-output');
    const recentRequestsEl = document.getElementById('recent-requests');
    const usageReset = document.getElementById('usage-reset');

    usageBadge.addEventListener('click', () => {
      usageModal.classList.toggle('visible');
      if (usageModal.classList.contains('visible')) fetchUsage();
    });

    usageBadge.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' || e.key === ' ') {
        e.preventDefault();
        usageBadge.click();
      }
    });

    document.addEventListener('click', (e) => {
      if (!usageModal.contains(e.target) && !usageBadge.contains(e.target)) {
        usageModal.classList.remove('visible');
      }
    });

    usageReset.addEventListener('click', async () => {
      if (confirm('Reset all usage stats? This cannot be undone.')) {
        await fetch('/api/usage/reset', { method: 'POST' });
        fetchUsage();
        showToast('Usage stats reset');
      }
    });

    async function fetchUsage() {
      try {
        const response = await fetch('/api/usage');
        const data = await response.json();
        updateUsageDisplay(data);
      } catch (err) {
        console.error('Error fetching usage:', err);
      }
    }

    function updateUsageDisplay(data) {
      usageCost.textContent = data.formattedCost;
      usageTotalCost.textContent = data.formattedCost;
      usageRequests.textContent = data.totalRequests.toLocaleString();
      usageInput.textContent = data.totalInputTokens.toLocaleString();
      usageOutput.textContent = data.totalOutputTokens.toLocaleString();

      recentRequestsEl.textContent = '';
      const header = document.createElement('div');
      header.className = 'usage-stat';
      const headerLabel = document.createElement('span');
      headerLabel.className = 'usage-stat-label';
      headerLabel.textContent = 'Recent Requests';
      header.appendChild(headerLabel);
      recentRequestsEl.appendChild(header);

      if (data.recentRequests && data.recentRequests.length > 0) {
        data.recentRequests.forEach(req => {
          const div = document.createElement('div');
          div.className = 'recent-request';
          const refSpan = document.createElement('span');
          refSpan.className = 'recent-request-ref';
          refSpan.textContent = req.reference;
          const costSpan = document.createElement('span');
          costSpan.className = 'recent-request-cost';
          costSpan.textContent = '$' + req.estimatedCost.toFixed(4);
          div.appendChild(refSpan);
          div.appendChild(costSpan);
          recentRequestsEl.appendChild(div);
        });
      } else {
        const noReqs = document.createElement('div');
        noReqs.className = 'recent-request';
        noReqs.textContent = 'No requests yet';
        recentRequestsEl.appendChild(noReqs);
      }
    }

    fetchUsage();

    // ===== Loading Skeleton =====
    function showLoadingSkeleton() {
      versesContainer.textContent = '';
      for (let i = 0; i < 12; i++) {
        const sk = document.createElement('div');
        sk.className = 'skeleton-verse';
        const numEl = document.createElement('div');
        numEl.className = 'skeleton-num';
        const lineEl = document.createElement('div');
        lineEl.className = 'skeleton-line' + (i % 3 === 2 ? ' short' : i % 3 === 1 ? ' medium' : '');
        sk.appendChild(numEl);
        sk.appendChild(lineEl);
        versesContainer.appendChild(sk);
      }
    }

    // showLoadingSkeleton is called from the original loadChapter above

    // ===== Interpretation History =====
    const HISTORY_KEY = 'bible-interp-history';
    const MAX_HISTORY = 25;

    function getHistory() {
      try {
        return JSON.parse(localStorage.getItem(HISTORY_KEY) || '[]');
      } catch { return []; }
    }

    function saveToHistory(reference, data) {
      const history = getHistory();
      const idx = history.findIndex(h => h.reference === reference);
      if (idx !== -1) history.splice(idx, 1);
      history.unshift({
        reference,
        data,
        timestamp: Date.now()
      });
      if (history.length > MAX_HISTORY) history.length = MAX_HISTORY;
      localStorage.setItem(HISTORY_KEY, JSON.stringify(history));
      updateHistoryBadge();
    }

    function updateHistoryBadge() {
      const history = getHistory();
      const countEl = document.getElementById('history-count');
      if (history.length > 0) {
        countEl.style.display = 'flex';
        countEl.textContent = history.length;
      } else {
        countEl.style.display = 'none';
      }
    }

    updateHistoryBadge();

    const historyBtn = document.getElementById('history-btn');
    const historyModal = document.getElementById('history-modal');
    const historyList = document.getElementById('history-list');
    const historyClear = document.getElementById('history-clear');

    historyBtn.addEventListener('click', () => {
      historyModal.classList.toggle('visible');
      if (historyModal.classList.contains('visible')) {
        renderHistory();
        // Hide the badge when viewing history
        const countEl = document.getElementById('history-count');
        countEl.style.display = 'none';
      }
    });

    document.addEventListener('click', (e) => {
      if (!historyModal.contains(e.target) && !historyBtn.contains(e.target)) {
        historyModal.classList.remove('visible');
      }
    });

    historyClear.addEventListener('click', () => {
      localStorage.removeItem(HISTORY_KEY);
      updateHistoryBadge();
      renderHistory();
      showToast('History cleared');
    });

    function renderHistory() {
      const history = getHistory();
      historyList.textContent = '';
      if (history.length === 0) {
        const empty = document.createElement('div');
        empty.className = 'history-empty';
        empty.textContent = 'No interpretations yet';
        historyList.appendChild(empty);
        return;
      }
      history.forEach(h => {
        const item = document.createElement('div');
        item.className = 'history-item';

        const refEl = document.createElement('div');
        refEl.className = 'history-item-ref';
        refEl.textContent = h.reference;
        item.appendChild(refEl);

        const previewEl = document.createElement('div');
        previewEl.className = 'history-item-preview';
        previewEl.textContent = (h.data.interpretation || '').substring(0, 80) + '...';
        item.appendChild(previewEl);

        const timeEl = document.createElement('div');
        timeEl.className = 'history-item-time';
        timeEl.textContent = timeAgo(h.timestamp);
        item.appendChild(timeEl);

        item.addEventListener('click', () => {
          interpretPanel.classList.remove('hidden');
          selectedTextEl.textContent = h.data.englishText || '';
          displayInterpretation(h.data);
          interpretationContent.style.display = 'block';
          panelLoading.classList.add('hidden');
          historyModal.classList.remove('visible');
          showToast('Loaded from history');
        });
        historyList.appendChild(item);
      });
    }

    function timeAgo(ts) {
      const diff = Date.now() - ts;
      const mins = Math.floor(diff / 60000);
      if (mins < 1) return 'just now';
      if (mins < 60) return mins + 'm ago';
      const hrs = Math.floor(mins / 60);
      if (hrs < 24) return hrs + 'h ago';
      const days = Math.floor(hrs / 24);
      return days + 'd ago';
    }

    // saveToHistory is called from the original interpretSelection above

    // ===== Search Keyboard Navigation =====
    let searchActiveIndex = -1;

    searchInput.addEventListener('input', () => {
      searchActiveIndex = -1;
      setTimeout(() => {
        const items = searchResults.querySelectorAll('.search-result-item');
        const existingCount = searchResults.parentElement.querySelector('.search-count');
        if (existingCount) existingCount.remove();
        if (items.length > 0 && searchInput.value.trim()) {
          const count = document.createElement('div');
          count.className = 'search-count';
          count.textContent = items.length + ' result' + (items.length > 1 ? 's' : '');
          searchResults.before(count);
        }
      }, 0);
    });

    searchInput.removeEventListener('keydown', searchInput._keyHandler);
    searchInput._keyHandler = function(e) {
      const items = searchResults.querySelectorAll('.search-result-item');
      if (e.key === 'ArrowDown') {
        e.preventDefault();
        searchActiveIndex = Math.min(searchActiveIndex + 1, items.length - 1);
        updateSearchHighlight(items);
      } else if (e.key === 'ArrowUp') {
        e.preventDefault();
        searchActiveIndex = Math.max(searchActiveIndex - 1, 0);
        updateSearchHighlight(items);
      } else if (e.key === 'Enter') {
        if (searchActiveIndex >= 0 && items[searchActiveIndex]) {
          items[searchActiveIndex].click();
        } else if (items.length > 0) {
          items[0].click();
        }
      } else if (e.key === 'Escape') {
        closeSearch();
      }
    };
    searchInput.addEventListener('keydown', searchInput._keyHandler);

    function updateSearchHighlight(items) {
      items.forEach((item, i) => {
        item.classList.toggle('keyboard-active', i === searchActiveIndex);
      });
      if (items[searchActiveIndex]) {
        items[searchActiveIndex].scrollIntoView({ block: 'nearest' });
      }
    }

    // ===== Compare Translations =====
    const compareBtn = document.getElementById('compare-btn');
    const compareModal = document.getElementById('compare-modal');
    const compareBackdrop = document.getElementById('compare-backdrop');
    const compareBody = document.getElementById('compare-body');
    const compareTitle = document.getElementById('compare-title');
    const closeCompare = document.getElementById('close-compare');

    compareBtn.addEventListener('click', async () => {
      if (selectedVerses.size === 0) {
        showToast('Select verses first');
        return;
      }

      const { startVerse, endVerse } = getSelectedRange();
      const ref = endVerse > startVerse
        ? currentBook + ' ' + currentChapter + ':' + startVerse + '-' + endVerse
        : currentBook + ' ' + currentChapter + ':' + startVerse;

      compareTitle.textContent = 'Compare: ' + ref;
      compareBody.textContent = '';
      const loadingDiv = document.createElement('div');
      loadingDiv.className = 'loading-state';
      const spinnerDiv = document.createElement('div');
      spinnerDiv.className = 'spinner';
      const loadingP = document.createElement('p');
      loadingP.textContent = 'Loading translations...';
      loadingDiv.appendChild(spinnerDiv);
      loadingDiv.appendChild(loadingP);
      compareBody.appendChild(loadingDiv);

      compareModal.classList.add('visible');
      compareBackdrop.classList.add('visible');

      try {
        const response = await fetch('/api/compare', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            book: currentBook,
            chapter: currentChapter,
            startVerse,
            endVerse,
            translations: ['ESV', 'KJV', 'NIV2011', 'NLT', 'NASB']
          })
        });

        if (!response.ok) throw new Error('Failed to compare');
        const data = await response.json();

        compareBody.textContent = '';
        const labelMap = { NIV2011: 'NIV', CSB17: 'CSB' };
        for (const [trans, verses] of Object.entries(data.translations)) {
          const row = document.createElement('div');
          row.className = 'compare-row';
          const label = document.createElement('div');
          label.className = 'compare-label';
          label.textContent = labelMap[trans] || trans;
          const text = document.createElement('div');
          text.className = 'compare-text';
          text.textContent = verses.map(v => v.text).join(' ');
          row.appendChild(label);
          row.appendChild(text);
          compareBody.appendChild(row);
        }
      } catch (err) {
        compareBody.textContent = 'Error: ' + err.message;
      }
    });

    function closeCompareModal() {
      compareModal.classList.remove('visible');
      compareBackdrop.classList.remove('visible');
    }

    closeCompare.addEventListener('click', closeCompareModal);
    compareBackdrop.addEventListener('click', closeCompareModal);

    // ===== Verse Highlights =====
    const HL_KEY = 'bible-highlights';
    const hlPalette = document.getElementById('highlight-palette');

    function getHighlights() {
      try { return JSON.parse(localStorage.getItem(HL_KEY) || '{}'); } catch { return {}; }
    }

    function saveHighlights(hl) {
      localStorage.setItem(HL_KEY, JSON.stringify(hl));
    }

    function applyHighlights() {
      const hl = getHighlights();
      const prefix = currentBookIndex + '-' + currentChapter + '-';
      document.querySelectorAll('.verse').forEach(el => {
        const key = prefix + el.dataset.verse;
        if (hl[key]) {
          el.dataset.highlight = hl[key];
        } else {
          delete el.dataset.highlight;
        }
      });
    }

    function setHighlight(color) {
      const hl = getHighlights();
      const prefix = currentBookIndex + '-' + currentChapter + '-';
      selectedVerses.forEach(v => {
        const key = prefix + v;
        if (color === 'clear') {
          delete hl[key];
        } else {
          hl[key] = color;
        }
      });
      saveHighlights(hl);
      applyHighlights();
    }

    // Show palette when verses are selected
    function updateHighlightPalette() {
      if (selectedVerses.size > 0) {
        hlPalette.classList.add('visible');
        // Mark active color
        const hl = getHighlights();
        const prefix = currentBookIndex + '-' + currentChapter + '-';
        const firstKey = prefix + [...selectedVerses][0];
        const activeColor = hl[firstKey] || '';
        hlPalette.querySelectorAll('.hl-dot').forEach(dot => {
          dot.classList.toggle('active', dot.dataset.color === activeColor);
        });
      } else {
        hlPalette.classList.remove('visible');
      }
    }

    hlPalette.addEventListener('click', (e) => {
      const dot = e.target.closest('.hl-dot');
      if (!dot) return;
      setHighlight(dot.dataset.color);
      updateHighlightPalette();
    });

    // updateHighlightPalette is called from within the original updateFab

    // ===== Personal Notes =====
    const NOTES_KEY = 'bible-notes';
    let activeNoteEditor = null;

    function getNotes() {
      try { return JSON.parse(localStorage.getItem(NOTES_KEY) || '{}'); } catch { return {}; }
    }

    function saveNotes(notes) {
      localStorage.setItem(NOTES_KEY, JSON.stringify(notes));
    }

    function noteKey(verse) {
      return currentBookIndex + '-' + currentChapter + '-' + verse;
    }

    function openNoteEditor(verseNum) {
      closeNoteEditor();
      const verseEl = document.querySelector('.verse[data-verse="' + verseNum + '"]');
      if (!verseEl) return;

      const notes = getNotes();
      const key = noteKey(verseNum);
      const existing = notes[key] || '';

      const editor = document.createElement('div');
      editor.className = 'note-editor-inline';
      editor.dataset.noteVerse = verseNum;

      const ta = document.createElement('textarea');
      ta.value = existing;
      ta.placeholder = 'Add a note for verse ' + verseNum + '...';
      editor.appendChild(ta);

      const actions = document.createElement('div');
      actions.className = 'note-editor-actions';

      if (existing) {
        const delBtn = document.createElement('button');
        delBtn.className = 'note-delete-btn';
        delBtn.textContent = 'Delete';
        delBtn.addEventListener('click', () => {
          delete notes[key];
          saveNotes(notes);
          closeNoteEditor();
          refreshNoteIndicators();
          renderNotesPanel();
          showToast('Note deleted');
        });
        actions.appendChild(delBtn);
      }

      const cancelBtn = document.createElement('button');
      cancelBtn.textContent = 'Cancel';
      cancelBtn.addEventListener('click', closeNoteEditor);
      actions.appendChild(cancelBtn);

      const saveBtn = document.createElement('button');
      saveBtn.className = 'note-save-btn';
      saveBtn.textContent = 'Save';
      saveBtn.addEventListener('click', () => {
        const text = ta.value.trim();
        if (text) {
          notes[key] = text;
          saveNotes(notes);
          showToast('Note saved');
        } else {
          delete notes[key];
          saveNotes(notes);
        }
        closeNoteEditor();
        refreshNoteIndicators();
        renderNotesPanel();
      });
      actions.appendChild(saveBtn);
      editor.appendChild(actions);

      // Insert after the verse element - find the next sibling or append
      verseEl.insertAdjacentElement('afterend', editor);
      activeNoteEditor = editor;
      ta.focus();
    }

    function closeNoteEditor() {
      if (activeNoteEditor) {
        activeNoteEditor.remove();
        activeNoteEditor = null;
      }
    }

    function refreshNoteIndicators() {
      const notes = getNotes();
      const prefix = currentBookIndex + '-' + currentChapter + '-';
      document.querySelectorAll('.verse').forEach(el => {
        const key = prefix + el.dataset.verse;
        let ind = el.querySelector('.note-indicator');
        if (notes[key]) {
          if (!ind) {
            ind = document.createElement('span');
            ind.className = 'note-indicator';
            ind.textContent = '\u270E';
            ind.title = 'View/edit note';
            el.querySelector('.verse-num').appendChild(ind);
          }
        } else if (ind) {
          ind.remove();
        }
      });
    }

    // Double-click verse to add/edit note
    document.getElementById('verses-container').addEventListener('dblclick', (e) => {
      const verseEl = e.target.closest('.verse');
      if (verseEl) {
        e.preventDefault();
        openNoteEditor(parseInt(verseEl.dataset.verse));
      }
    });

    function renderNotesPanel() {
      const notesList = document.getElementById('notes-list');
      if (!notesList) return;
      notesList.textContent = '';
      const notes = getNotes();
      const prefix = currentBookIndex + '-' + currentChapter + '-';
      const chapterNotes = [];
      for (const [key, text] of Object.entries(notes)) {
        if (key.startsWith(prefix)) {
          const verse = key.replace(prefix, '');
          chapterNotes.push({ verse: parseInt(verse), text });
        }
      }
      chapterNotes.sort((a, b) => a.verse - b.verse);
      if (chapterNotes.length === 0) {
        const empty = document.createElement('div');
        empty.className = 'notes-empty';
        empty.textContent = 'Double-click a verse to add a note';
        notesList.appendChild(empty);
        return;
      }
      chapterNotes.forEach(n => {
        const item = document.createElement('div');
        item.className = 'note-item';
        const vEl = document.createElement('span');
        vEl.className = 'note-item-verse';
        vEl.textContent = 'v.' + n.verse;
        item.appendChild(vEl);
        const tEl = document.createElement('div');
        tEl.className = 'note-item-text';
        tEl.textContent = n.text;
        item.appendChild(tEl);
        item.addEventListener('click', () => {
          const verseEl = document.querySelector('.verse[data-verse="' + n.verse + '"]');
          if (verseEl) verseEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
          openNoteEditor(n.verse);
        });
        notesList.appendChild(item);
      });
    }

    // ===== Chapter Context Card =====
    const BOOK_META = [
      ['Moses','~1446-1406 BC','Israel','Narrative','Origins and God\'s covenant'],
      ['Moses','~1446-1406 BC','Israel','Narrative/Law','Deliverance from Egypt'],
      ['Moses','~1446-1406 BC','Israel','Law','Holiness and worship'],
      ['Moses','~1446-1406 BC','Israel','Narrative/Census','Wilderness journey'],
      ['Moses','~1406 BC','Israel','Law/Sermon','Covenant renewal'],
      ['Joshua','~1400-1370 BC','Israel','Narrative','Conquest of Canaan'],
      ['Samuel/Unknown','~1050-1000 BC','Israel','Narrative','Judges cycle'],
      ['Samuel(?)','~1010 BC','Israel','Narrative','Loyalty and redemption'],
      ['Samuel/Nathan/Gad','~930 BC','Israel','Narrative','Rise of monarchy'],
      ['Samuel/Nathan/Gad','~930 BC','Israel','Narrative','David\'s reign'],
      ['Jeremiah(?)','~560 BC','Israel','Narrative','Divided kingdom'],
      ['Jeremiah(?)','~560 BC','Israel','Narrative','Fall of kingdoms'],
      ['Ezra(?)','~450 BC','Israel','Narrative','Temple worship'],
      ['Ezra(?)','~450 BC','Israel','Narrative','Southern kingdom'],
      ['Ezra','~440 BC','Returnees','Narrative','Return from exile'],
      ['Nehemiah','~430 BC','Returnees','Narrative','Rebuilding walls'],
      ['Unknown','~470 BC','Jews in Persia','Narrative','Providence and courage'],
      ['Unknown','~2000-500 BC','Sufferers','Wisdom/Poetry','Suffering and faith'],
      ['David and others','~1000-400 BC','Worshipers','Poetry/Hymns','Prayer and praise'],
      ['Solomon and others','~950-700 BC','Youth/All','Wisdom','Practical godly living'],
      ['Solomon','~935 BC','All','Wisdom','Meaning of life'],
      ['Solomon','~965 BC','Beloved','Poetry','Love and intimacy'],
      ['Isaiah','~740-680 BC','Judah','Prophecy','Judgment and hope'],
      ['Jeremiah','~627-585 BC','Judah','Prophecy','Warning and exile'],
      ['Jeremiah','~586 BC','Exiles','Poetry','Grief over Jerusalem'],
      ['Ezekiel','~593-571 BC','Exiles','Prophecy','God\'s glory and restoration'],
      ['Daniel','~536 BC','Exiles','Prophecy/Narrative','Sovereignty of God'],
      ['Hosea','~755-715 BC','Israel','Prophecy','Faithful love'],
      ['Joel','~835-800 BC','Judah','Prophecy','Day of the LORD'],
      ['Amos','~760 BC','Israel','Prophecy','Social justice'],
      ['Obadiah','~845 or 586 BC','Edom','Prophecy','Judgment on Edom'],
      ['Jonah','~780-750 BC','Nineveh','Narrative','God\'s mercy to all'],
      ['Micah','~735-700 BC','Judah/Israel','Prophecy','Justice and mercy'],
      ['Nahum','~663-612 BC','Nineveh','Prophecy','God\'s judgment'],
      ['Habakkuk','~609-605 BC','Judah','Prophecy','Living by faith'],
      ['Zephaniah','~640-621 BC','Judah','Prophecy','Coming judgment'],
      ['Haggai','~520 BC','Returnees','Prophecy','Rebuild the temple'],
      ['Zechariah','~520-480 BC','Returnees','Prophecy','Messianic hope'],
      ['Malachi','~430 BC','Israel','Prophecy','Spiritual renewal'],
      ['Matthew','~55-65 AD','Jews','Gospel','Jesus as King'],
      ['Mark (via Peter)','~55-65 AD','Romans','Gospel','Jesus as Servant'],
      ['Luke','~60-62 AD','Theophilus','Gospel','Jesus for all people'],
      ['John','~85-95 AD','Believers','Gospel','Jesus as God'],
      ['Luke','~62 AD','Theophilus','Narrative','Early church growth'],
      ['Paul','~57 AD','Rome church','Epistle','Righteousness by faith'],
      ['Paul','~55 AD','Corinth church','Epistle','Church unity'],
      ['Paul','~56 AD','Corinth church','Epistle','Ministry and comfort'],
      ['Paul','~49 AD','Galatian churches','Epistle','Freedom in Christ'],
      ['Paul','~60-62 AD','Ephesus church','Epistle','Unity in Christ'],
      ['Paul','~60-62 AD','Philippi church','Epistle','Joy in Christ'],
      ['Paul','~60-62 AD','Colossae church','Epistle','Supremacy of Christ'],
      ['Paul','~51 AD','Thessalonica','Epistle','Christ\'s return'],
      ['Paul','~51-52 AD','Thessalonica','Epistle','Perseverance'],
      ['Paul','~63-65 AD','Timothy','Epistle','Church leadership'],
      ['Paul','~66-67 AD','Timothy','Epistle','Faithful endurance'],
      ['Paul','~63-65 AD','Titus','Epistle','Sound doctrine'],
      ['Paul','~60-62 AD','Philemon','Epistle','Forgiveness'],
      ['Unknown','~60s AD','Jewish Christians','Epistle','Christ\'s superiority'],
      ['James','~45-49 AD','Jewish believers','Epistle','Faith and works'],
      ['Peter','~64-65 AD','Scattered believers','Epistle','Hope in suffering'],
      ['Peter','~66-68 AD','Believers','Epistle','True knowledge'],
      ['John','~85-95 AD','Believers','Epistle','God is love'],
      ['John','~85-95 AD','Chosen lady','Epistle','Truth and love'],
      ['John','~85-95 AD','Gaius','Epistle','Hospitality'],
      ['Jude','~65-80 AD','Believers','Epistle','Contend for faith'],
      ['John','~95 AD','Seven churches','Prophecy','Victory of God']
    ];

    function renderContextCard() {
      const rows = document.getElementById('context-rows');
      if (!rows) return;
      rows.textContent = '';
      const meta = BOOK_META[currentBookIndex];
      if (!meta) return;

      const fields = [
        ['Author', meta[0]],
        ['Written', meta[1]],
        ['Audience', meta[2]],
        ['Genre', meta[3]],
        ['Theme', meta[4]]
      ];
      fields.forEach(([label, value]) => {
        const row = document.createElement('div');
        row.className = 'context-row';
        const lbl = document.createElement('span');
        lbl.className = 'context-label';
        lbl.textContent = label;
        const val = document.createElement('span');
        val.className = 'context-value';
        val.textContent = value;
        row.appendChild(lbl);
        row.appendChild(val);
        rows.appendChild(row);
      });
    }

    // ===== Mini Table of Contents =====
    const TOC_CACHE_KEY = 'bible-toc-cache';

    function getTocCache() {
      try { return JSON.parse(localStorage.getItem(TOC_CACHE_KEY) || '{}'); } catch { return {}; }
    }

    function saveTocCache(cache) {
      localStorage.setItem(TOC_CACHE_KEY, JSON.stringify(cache));
    }

    function renderToc(sections) {
      const tocList = document.getElementById('toc-list');
      if (!tocList) return;
      tocList.textContent = '';

      if (!sections || sections.length === 0) {
        const btn = document.createElement('button');
        btn.className = 'toc-generate';
        btn.textContent = 'Generate Outline';
        btn.addEventListener('click', () => fetchToc());
        tocList.appendChild(btn);
        return;
      }

      sections.forEach(s => {
        const item = document.createElement('div');
        item.className = 'toc-item';
        const versesEl = document.createElement('span');
        versesEl.className = 'toc-item-verses';
        versesEl.textContent = 'v.' + s.verses;
        const titleEl = document.createElement('span');
        titleEl.className = 'toc-item-title';
        titleEl.textContent = s.title;
        item.appendChild(versesEl);
        item.appendChild(titleEl);
        item.addEventListener('click', () => {
          const startVerse = parseInt(s.verses);
          const verseEl = document.querySelector('.verse[data-verse="' + startVerse + '"]');
          if (verseEl) verseEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
        });
        tocList.appendChild(item);
      });
    }

    async function fetchToc() {
      const tocList = document.getElementById('toc-list');
      if (!tocList) return;

      // Check cache first
      const cache = getTocCache();
      const cacheKey = currentBookIndex + '-' + currentChapter;
      if (cache[cacheKey]) {
        renderToc(cache[cacheKey]);
        return;
      }

      tocList.textContent = '';
      const loading = document.createElement('div');
      loading.style.cssText = 'text-align:center;padding:8px;font-size:11px;color:var(--neutral-400)';
      loading.textContent = 'Generating outline...';
      tocList.appendChild(loading);

      try {
        const response = await fetch('/api/outline', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ book: currentBook, chapter: currentChapter })
        });
        if (!response.ok) throw new Error('Failed');
        const data = await response.json();
        cache[cacheKey] = data.sections;
        saveTocCache(cache);
        renderToc(data.sections);
        fetchUsage();
      } catch (err) {
        tocList.textContent = '';
        const errDiv = document.createElement('div');
        errDiv.style.cssText = 'font-size:11px;color:var(--error);text-align:center;padding:8px';
        errDiv.textContent = 'Failed to load outline';
        tocList.appendChild(errDiv);
      }
    }

    // ===== Update Sidebar on Chapter Load =====
    function updateSidebar() {
      const sidebar = document.getElementById('context-sidebar');
      if (!sidebar) return;
      sidebar.style.display = 'flex';
      renderContextCard();
      // Check TOC cache
      const cache = getTocCache();
      const cacheKey = currentBookIndex + '-' + currentChapter;
      if (cache[cacheKey]) {
        renderToc(cache[cacheKey]);
      } else {
        renderToc(null); // show "Generate" button
      }
      renderNotesPanel();
    }

    // sidebar/highlights/notes are called from within the original loadChapter
  </script>
</body>
</html>
