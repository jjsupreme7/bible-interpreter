<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Bible Interpreter</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Literata:opsz,wght@7..72,400;7..72,500;7..72,600&display=swap" rel="stylesheet">
  <style>
    /* ===== Design System ===== */
    :root {
      /* Colors - Light Mode */
      --primary-50: #EEF2FF;
      --primary-100: #E0E7FF;
      --primary-500: #6366F1;
      --primary-600: #4F46E5;
      --primary-700: #4338CA;

      --neutral-50: #FAFAFA;
      --neutral-100: #F5F5F5;
      --neutral-200: #E5E5E5;
      --neutral-300: #D4D4D4;
      --neutral-400: #A3A3A3;
      --neutral-500: #737373;
      --neutral-600: #525252;
      --neutral-700: #404040;
      --neutral-800: #262626;
      --neutral-900: #171717;

      --selection-bg: #DBEAFE;
      --selection-border: #3B82F6;
      --success: #10B981;
      --error: #EF4444;

      --scripture-bg: #F0F2F5;
      --verse-hover: #E4E7EC;

      --header-bg: #1E1B4B;
      --panel-bg: #FFFFFF;

      /* Typography */
      --font-ui: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      --font-scripture: 'Literata', Georgia, 'Times New Roman', serif;
      --font-mono: 'SF Mono', Monaco, 'Cascadia Code', Consolas, monospace;

      /* Type Scale */
      --text-xs: 0.75rem;
      --text-sm: 0.875rem;
      --text-base: 1rem;
      --text-lg: 1.125rem;
      --text-xl: 1.25rem;
      --text-2xl: 1.5rem;
      --text-3xl: 1.875rem;

      /* Spacing */
      --space-1: 0.25rem;
      --space-2: 0.5rem;
      --space-3: 0.75rem;
      --space-4: 1rem;
      --space-5: 1.25rem;
      --space-6: 1.5rem;
      --space-8: 2rem;
      --space-10: 2.5rem;
      --space-12: 3rem;

      /* Shadows */
      --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
      --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
      --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -4px rgba(0, 0, 0, 0.1);
      --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1);

      /* Transitions */
      --transition-fast: 0.15s ease;
      --transition-normal: 0.2s ease;
      --transition-slow: 0.3s ease;
    }

    /* Dark Mode */
    :root.dark {
      --primary-50: #312E81;
      --primary-100: #3730A3;
      --primary-500: #818CF8;
      --primary-600: #A5B4FC;
      --primary-700: #C7D2FE;

      --neutral-50: #0A0A0A;
      --neutral-100: #171717;
      --neutral-200: #262626;
      --neutral-300: #404040;
      --neutral-400: #525252;
      --neutral-500: #8A8A8A;
      --neutral-600: #B8B8B8;
      --neutral-700: #E0E0E0;
      --neutral-800: #F0F0F0;
      --neutral-900: #FFFFFF;

      --selection-bg: #422006;
      --selection-border: #D97706;

      --scripture-bg: #1C1917;
      --verse-hover: #292524;

      --header-bg: #0F0D1A;
      --panel-bg: #171717;
    }

    /* ===== Base Styles ===== */
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: var(--font-ui);
      line-height: 1.6;
      color: var(--neutral-700);
      background: var(--neutral-50);
      height: 100vh;
      display: flex;
      flex-direction: column;
      transition: background var(--transition-normal), color var(--transition-normal);
    }

    /* Focus styles */
    :focus-visible {
      outline: 2px solid var(--primary-500);
      outline-offset: 2px;
    }

    /* ===== Header ===== */
    header {
      background: var(--header-bg);
      color: white;
      padding: var(--space-3) var(--space-5);
      display: flex;
      align-items: center;
      gap: var(--space-4);
      position: relative;
      z-index: 100;
    }

    header h1 {
      font-size: var(--text-lg);
      font-weight: 600;
      white-space: nowrap;
    }

    .nav-controls {
      display: flex;
      gap: var(--space-2);
      align-items: center;
    }

    .nav-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 36px;
      height: 36px;
      border: none;
      border-radius: 8px;
      background: rgba(255,255,255,0.1);
      color: white;
      cursor: pointer;
      transition: background var(--transition-fast);
    }

    .nav-btn:hover:not(:disabled) {
      background: var(--primary-500);
    }

    .nav-btn:disabled {
      opacity: 0.3;
      cursor: not-allowed;
    }

    .nav-btn svg {
      width: 20px;
      height: 20px;
    }

    .nav-controls select {
      padding: var(--space-2) var(--space-3);
      font-size: var(--text-sm);
      border: none;
      border-radius: 8px;
      background: white;
      color: #262626;
      cursor: pointer;
      min-width: 120px;
    }

    .nav-controls .go-btn {
      padding: var(--space-2) var(--space-4);
      font-size: var(--text-sm);
      font-weight: 500;
      border: none;
      border-radius: 8px;
      background: var(--primary-500);
      color: white;
      cursor: pointer;
      transition: background var(--transition-fast);
    }

    .nav-controls .go-btn:hover {
      background: var(--primary-600);
    }

    .header-actions {
      margin-left: auto;
      display: flex;
      align-items: center;
      gap: var(--space-3);
    }

    .version-select {
      padding: var(--space-2) var(--space-3);
      font-size: var(--text-sm);
      font-weight: 500;
      border: none;
      border-radius: 8px;
      background: rgba(255, 255, 255, 0.15);
      color: white;
      cursor: pointer;
      min-width: 70px;
    }

    .version-select:hover {
      background: rgba(255, 255, 255, 0.25);
    }

    .version-select option {
      background: var(--header-bg);
      color: white;
    }

    .theme-toggle {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 40px;
      height: 40px;
      border: none;
      border-radius: 8px;
      background: rgba(255,255,255,0.1);
      color: white;
      cursor: pointer;
      transition: background var(--transition-fast);
    }

    .theme-toggle:hover {
      background: rgba(255,255,255,0.2);
    }

    .theme-toggle svg {
      width: 20px;
      height: 20px;
    }

    .theme-toggle .sun-icon { display: none; }
    .theme-toggle .moon-icon { display: block; }
    :root.dark .theme-toggle .sun-icon { display: block; }
    :root.dark .theme-toggle .moon-icon { display: none; }

    .usage-badge {
      background: rgba(255,255,255,0.15);
      padding: var(--space-2) var(--space-3);
      border-radius: 20px;
      font-size: var(--text-sm);
      cursor: pointer;
      transition: background var(--transition-fast);
      white-space: nowrap;
    }

    .usage-badge:hover {
      background: rgba(255,255,255,0.25);
    }

    /* ===== Usage Modal ===== */
    .usage-modal {
      display: none;
      position: fixed;
      top: 60px;
      right: var(--space-5);
      background: var(--panel-bg);
      border-radius: 12px;
      box-shadow: var(--shadow-xl);
      padding: var(--space-5);
      width: 320px;
      z-index: 1000;
      color: var(--neutral-700);
    }

    .usage-modal.visible {
      display: block;
      animation: fadeIn 0.2s ease;
    }

    .usage-modal h3 {
      margin-bottom: var(--space-4);
      font-size: var(--text-base);
      color: var(--neutral-900);
    }

    .usage-stat {
      display: flex;
      justify-content: space-between;
      padding: var(--space-2) 0;
      border-bottom: 1px solid var(--neutral-200);
    }

    .usage-stat:last-child {
      border-bottom: none;
    }

    .usage-stat-label {
      color: var(--neutral-500);
      font-size: var(--text-sm);
    }

    .usage-stat-value {
      font-weight: 600;
      color: var(--neutral-900);
    }

    .usage-cost {
      font-size: var(--text-2xl);
      font-weight: 600;
      color: var(--success);
      text-align: center;
      padding: var(--space-4) 0;
    }

    .usage-reset {
      width: 100%;
      padding: var(--space-2);
      margin-top: var(--space-4);
      background: var(--error);
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: var(--text-sm);
      font-weight: 500;
      transition: background var(--transition-fast);
    }

    .usage-reset:hover {
      background: #DC2626;
    }

    .recent-requests {
      margin-top: var(--space-4);
      max-height: 150px;
      overflow-y: auto;
    }

    .recent-request {
      font-size: var(--text-xs);
      padding: var(--space-2) 0;
      border-bottom: 1px solid var(--neutral-200);
      display: flex;
      justify-content: space-between;
    }

    .recent-request-ref {
      font-weight: 500;
      color: var(--neutral-700);
    }

    .recent-request-cost {
      color: var(--success);
    }

    /* ===== Search Modal ===== */
    .search-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 1999;
      opacity: 0;
      visibility: hidden;
      transition: opacity var(--transition-normal), visibility var(--transition-normal);
    }

    .search-backdrop.open {
      opacity: 1;
      visibility: visible;
    }

    .search-modal {
      position: fixed;
      top: 20%;
      left: 50%;
      transform: translateX(-50%);
      width: 90%;
      max-width: 500px;
      background: var(--panel-bg);
      border-radius: 12px;
      box-shadow: var(--shadow-xl);
      z-index: 2000;
      overflow: hidden;
      opacity: 0;
      visibility: hidden;
      transition: opacity var(--transition-normal), visibility var(--transition-normal);
    }

    .search-modal.open {
      opacity: 1;
      visibility: visible;
    }

    .search-input-wrapper {
      display: flex;
      align-items: center;
      padding: var(--space-4);
      border-bottom: 1px solid var(--neutral-200);
    }

    .search-input-wrapper svg {
      width: 20px;
      height: 20px;
      color: var(--neutral-400);
      margin-right: var(--space-3);
      flex-shrink: 0;
    }

    .search-input {
      flex: 1;
      border: none;
      font-size: var(--text-lg);
      outline: none;
      background: transparent;
      color: var(--neutral-900);
    }

    .search-input::placeholder {
      color: var(--neutral-400);
    }

    .search-results {
      max-height: 300px;
      overflow-y: auto;
    }

    .search-result-item {
      padding: var(--space-3) var(--space-4);
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: background var(--transition-fast);
    }

    .search-result-item:hover,
    .search-result-item.highlighted {
      background: var(--primary-50);
    }

    .search-result-ref {
      font-weight: 500;
      color: var(--neutral-900);
    }

    .search-hint {
      padding: var(--space-3) var(--space-4);
      background: var(--neutral-100);
      font-size: var(--text-sm);
      color: var(--neutral-500);
      border-top: 1px solid var(--neutral-200);
    }

    .search-hint kbd {
      background: var(--neutral-200);
      padding: 2px 6px;
      border-radius: 4px;
      font-family: var(--font-mono);
      font-size: var(--text-xs);
      margin: 0 2px;
    }

    /* ===== Main Layout ===== */
    .main-container {
      display: flex;
      flex: 1;
      overflow: hidden;
    }

    /* ===== Bible Panel ===== */
    .bible-panel {
      flex: 1;
      padding: var(--space-8) var(--space-6);
      overflow-y: auto;
      background: var(--scripture-bg);
      display: flex;
      flex-direction: column;
      align-items: center;
      transition: background var(--transition-normal);
    }

    .bible-content {
      max-width: 700px;
      width: 100%;
    }

    .chapter-header {
      font-family: var(--font-scripture);
      font-size: var(--text-3xl);
      font-weight: 600;
      margin-bottom: var(--space-6);
      color: var(--neutral-900);
      padding-bottom: var(--space-4);
      border-bottom: 1px solid var(--neutral-200);
    }

    .verses-container {
      line-height: 2;
    }

    .verse {
      display: inline;
      cursor: pointer;
      padding: 2px 4px;
      margin: 0 -2px;
      border-radius: 4px;
      transition: background var(--transition-fast), box-shadow var(--transition-fast);
    }

    .verse:hover {
      background: var(--verse-hover);
    }

    .verse.selected {
      background: var(--selection-bg);
      box-shadow: inset 0 0 0 2px var(--selection-border);
    }

    .verse-num {
      font-family: var(--font-mono);
      font-size: var(--text-xs);
      font-weight: 600;
      color: var(--primary-500);
      vertical-align: super;
      margin-right: 3px;
      user-select: none;
    }

    .verse-text {
      font-family: var(--font-scripture);
      font-size: var(--text-lg);
      color: var(--neutral-700);
    }

    .instructions {
      text-align: center;
      padding: var(--space-10);
      color: var(--neutral-500);
    }

    .instructions p {
      margin-bottom: var(--space-2);
    }

    /* ===== Interpretation Panel ===== */
    .interpretation-panel {
      width: 450px;
      background: var(--panel-bg);
      border-left: 1px solid var(--neutral-200);
      display: flex;
      flex-direction: column;
      overflow: hidden;
      transform: translateX(0);
      transition: transform var(--transition-slow), background var(--transition-normal);
    }

    .interpretation-panel.hidden {
      transform: translateX(100%);
      position: absolute;
      right: 0;
      top: 0;
      bottom: 0;
    }

    .panel-header {
      padding: var(--space-4) var(--space-5);
      background: var(--neutral-100);
      border-bottom: 1px solid var(--neutral-200);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .panel-header h2 {
      font-size: var(--text-base);
      font-weight: 600;
      color: var(--neutral-900);
    }

    .close-panel {
      background: none;
      border: none;
      font-size: var(--text-xl);
      cursor: pointer;
      color: var(--neutral-500);
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 6px;
      transition: background var(--transition-fast), color var(--transition-fast);
    }

    .close-panel:hover {
      background: var(--neutral-200);
      color: var(--neutral-700);
    }

    .panel-content {
      flex: 1;
      overflow-y: auto;
      padding: var(--space-5);
      position: relative;
    }

    .selected-text {
      background: var(--selection-bg);
      padding: var(--space-3) var(--space-4);
      border-radius: 8px;
      margin-bottom: var(--space-5);
      font-family: var(--font-scripture);
      font-style: italic;
      font-size: var(--text-sm);
      color: var(--neutral-700);
      border-left: 3px solid var(--selection-border);
    }

    .section-title {
      font-size: var(--text-xs);
      font-weight: 600;
      color: var(--neutral-500);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin: var(--space-5) 0 var(--space-3);
      display: flex;
      align-items: center;
      gap: var(--space-2);
      cursor: pointer;
      user-select: none;
    }

    .section-title svg {
      width: 16px;
      height: 16px;
      transition: transform var(--transition-fast);
    }

    .section-title.collapsed svg {
      transform: rotate(-90deg);
    }

    .section-content {
      overflow: hidden;
      transition: max-height var(--transition-slow);
      max-height: 2000px;
    }

    .section-content.collapsed {
      max-height: 0;
    }

    .word-list {
      display: flex;
      flex-direction: column;
      gap: var(--space-3);
      margin-bottom: var(--space-5);
    }

    .word-item {
      padding: var(--space-3);
      background: var(--neutral-100);
      border-radius: 8px;
      border-left: 3px solid var(--primary-500);
    }

    .word-original {
      font-size: var(--text-lg);
      color: var(--neutral-900);
      font-weight: 600;
    }

    .word-transliteration {
      font-style: italic;
      color: var(--neutral-500);
      font-size: var(--text-sm);
    }

    .word-strongs {
      display: inline-block;
      font-size: var(--text-xs);
      background: var(--primary-500);
      color: white;
      padding: 2px 8px;
      border-radius: 4px;
      margin-top: var(--space-2);
    }

    .word-strongs a {
      color: white;
      text-decoration: none;
    }

    .word-strongs a:hover {
      text-decoration: underline;
    }

    .word-definition {
      margin-top: var(--space-2);
      font-size: var(--text-sm);
      color: var(--neutral-600);
    }

    .word-verse-badge {
      display: inline-block;
      font-size: var(--text-xs);
      background: var(--neutral-200);
      color: var(--neutral-600);
      padding: 2px 6px;
      border-radius: 4px;
      margin-left: var(--space-2);
      vertical-align: middle;
    }

    .interpretation-text {
      font-size: var(--text-sm);
      line-height: 1.8;
      color: var(--neutral-700);
    }

    .interpretation-text h2 {
      font-size: var(--text-lg);
      font-weight: 600;
      margin: var(--space-5) 0 var(--space-3);
      color: var(--neutral-900);
    }

    .interpretation-text h3 {
      font-size: var(--text-base);
      font-weight: 600;
      margin: var(--space-4) 0 var(--space-2);
      color: var(--neutral-900);
    }

    .interpretation-text p {
      margin-bottom: var(--space-4);
    }

    .interpretation-text strong {
      font-weight: 600;
      color: var(--neutral-900);
    }

    .interpretation-text em {
      font-style: italic;
    }

    .interpretation-text ul,
    .interpretation-text ol {
      margin: var(--space-3) 0;
      padding-left: var(--space-6);
    }

    .interpretation-text li {
      margin-bottom: var(--space-2);
    }

    /* ===== Cross-References Section ===== */
    .crossref-section { margin-top: var(--space-4); }
    .crossref-loading {
      display: flex; align-items: center; gap: var(--space-2);
      font-size: var(--text-xs); color: var(--neutral-400); padding: var(--space-3) 0;
    }
    .crossref-loading .spinner { width: 14px; height: 14px; border-width: 2px; }
    .crossref-list { display: flex; flex-direction: column; gap: var(--space-2); }
    .crossref-item {
      padding: var(--space-3);
      background: var(--neutral-100);
      border-radius: 8px;
      cursor: pointer;
      transition: all var(--transition-fast);
      border-left: 3px solid transparent;
    }
    .crossref-item:hover { border-left-color: var(--primary-500); background: var(--neutral-50); }
    .crossref-item-header { display: flex; align-items: center; gap: var(--space-2); margin-bottom: var(--space-1); }
    .crossref-ref {
      font-weight: 600; font-size: var(--text-sm); color: var(--primary-500);
    }
    .crossref-tag {
      font-size: 10px; background: rgba(99,102,241,0.1); color: var(--primary-500);
      padding: 1px 6px; border-radius: 3px; white-space: nowrap;
    }
    .crossref-connection { font-size: var(--text-xs); color: var(--neutral-500); line-height: 1.5; }

    /* ===== Word Study Popover ===== */
    .word-popover {
      position: absolute; z-index: 1500;
      background: var(--panel-bg); border: 1px solid var(--neutral-200);
      border-radius: 10px; padding: var(--space-3); min-width: 220px; max-width: 280px;
      box-shadow: 0 8px 24px rgba(0,0,0,0.15);
    }
    .word-popover-original { font-size: var(--text-lg); font-weight: 600; color: var(--neutral-900); }
    .word-popover-translit { font-size: var(--text-xs); color: var(--neutral-500); font-style: italic; }
    .word-popover-strongs {
      display: inline-block; font-size: 10px; background: var(--primary-500); color: white;
      padding: 1px 6px; border-radius: 3px; margin-top: var(--space-1);
    }
    .word-popover-def { font-size: var(--text-xs); color: var(--neutral-600); margin-top: var(--space-2); line-height: 1.5; }
    .word-popover-dive {
      display: block; width: 100%; margin-top: var(--space-2);
      padding: var(--space-1) var(--space-2); background: var(--primary-500); color: white;
      border: none; border-radius: 6px; font-size: var(--text-xs); cursor: pointer;
      text-align: center; font-weight: 500;
    }
    .word-popover-dive:hover { background: var(--primary-600); }

    /* ===== Word Study Panel Mode ===== */
    .word-study-content { padding: var(--space-3) 0; }
    .word-study-header {
      text-align: center; padding: var(--space-4) 0; border-bottom: 1px solid var(--neutral-200);
      margin-bottom: var(--space-4);
    }
    .word-study-original { font-size: 28px; font-weight: 600; color: var(--neutral-900); }
    .word-study-translit { font-size: var(--text-sm); color: var(--neutral-500); font-style: italic; margin-top: var(--space-1); }
    .word-study-strongs-badge {
      display: inline-block; font-size: var(--text-xs); background: var(--primary-500); color: white;
      padding: 2px 10px; border-radius: 4px; margin-top: var(--space-2);
    }
    .word-study-section { margin-bottom: var(--space-4); }
    .word-study-section-title {
      font-size: var(--text-xs); font-weight: 600; text-transform: uppercase;
      letter-spacing: 0.05em; color: var(--neutral-400); margin-bottom: var(--space-2);
    }
    .word-study-section p, .word-study-section div {
      font-size: var(--text-sm); color: var(--neutral-700); line-height: 1.7;
    }
    .word-study-usage {
      padding: var(--space-2) var(--space-3); background: var(--neutral-100);
      border-radius: 6px; margin-bottom: var(--space-2); cursor: pointer;
      transition: border-left-color var(--transition-fast);
      border-left: 3px solid transparent;
    }
    .word-study-usage:hover { border-left-color: var(--primary-500); }
    .word-study-usage-ref { font-weight: 600; font-size: var(--text-xs); color: var(--primary-500); }
    .word-study-usage-snippet { font-size: var(--text-xs); color: var(--neutral-600); margin-top: 2px; }
    .word-study-usage-nuance { font-size: var(--text-xs); color: var(--neutral-500); font-style: italic; margin-top: 2px; }
    .word-study-related {
      display: inline-block; padding: var(--space-1) var(--space-2);
      background: var(--neutral-100); border-radius: 4px; font-size: var(--text-xs);
      color: var(--neutral-600); margin: 2px;
    }
    .word-study-back {
      display: flex; align-items: center; gap: var(--space-1);
      font-size: var(--text-xs); color: var(--neutral-500); background: none; border: none;
      cursor: pointer; padding: 0; margin-bottom: var(--space-3);
    }
    .word-study-back:hover { color: var(--primary-500); }

    /* Verse word clickable styling */
    .verse-word { cursor: pointer; border-radius: 2px; transition: background var(--transition-fast); }
    .verse-word:hover { background: rgba(99,102,241,0.12); }

    /* ===== Verse Cards ===== */
    .hl-card-btn {
      width: 24px; height: 24px; border-radius: 50%; cursor: pointer;
      display: flex; align-items: center; justify-content: center;
      background: var(--primary-500); border: 2px solid transparent;
      transition: transform var(--transition-fast);
    }
    .hl-card-btn:hover { transform: scale(1.15); }
    .hl-card-btn svg { width: 14px; height: 14px; stroke: white; fill: none; }

    .card-backdrop {
      position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 1999;
      opacity: 0; visibility: hidden; transition: all var(--transition-base);
    }
    .card-backdrop.open { opacity: 1; visibility: visible; }
    .card-modal {
      position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%) scale(0.95);
      background: var(--panel-bg); border-radius: 16px; width: 720px; max-width: 95vw;
      max-height: 90vh; overflow-y: auto; z-index: 2000;
      box-shadow: var(--shadow-lg); opacity: 0; visibility: hidden;
      transition: all var(--transition-base);
    }
    .card-modal.open { opacity: 1; visibility: visible; transform: translate(-50%, -50%) scale(1); }
    .card-modal-header {
      display: flex; align-items: center; justify-content: space-between;
      padding: var(--space-4) var(--space-5); border-bottom: 1px solid var(--neutral-200);
    }
    .card-modal-header h3 { font-size: var(--text-base); font-weight: 600; color: var(--neutral-900); }
    .card-modal-body { padding: var(--space-5); display: flex; flex-direction: column; align-items: center; gap: var(--space-4); }
    .card-canvas-wrap {
      border-radius: 8px; overflow: hidden; box-shadow: 0 4px 16px rgba(0,0,0,0.2);
      max-width: 100%;
    }
    .card-canvas-wrap canvas { display: block; max-width: 100%; height: auto; }
    .card-themes { display: flex; gap: var(--space-2); flex-wrap: wrap; justify-content: center; }
    .card-theme-btn {
      width: 36px; height: 36px; border-radius: 50%; border: 2px solid transparent;
      cursor: pointer; transition: all var(--transition-fast);
    }
    .card-theme-btn.active { border-color: var(--primary-500); transform: scale(1.1); }
    .card-size-toggle {
      display: flex; gap: var(--space-1); background: var(--neutral-100); border-radius: 8px; padding: 2px;
    }
    .card-size-btn {
      padding: var(--space-1) var(--space-3); border: none; background: transparent;
      border-radius: 6px; font-size: var(--text-xs); cursor: pointer; color: var(--neutral-600);
    }
    .card-size-btn.active { background: var(--panel-bg); color: var(--neutral-900); box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
    .card-actions { display: flex; gap: var(--space-2); }
    .card-actions button {
      padding: var(--space-2) var(--space-4); border-radius: 8px; font-size: var(--text-sm);
      cursor: pointer; font-weight: 500; border: 1px solid var(--neutral-200);
      background: var(--panel-bg); color: var(--neutral-700); transition: all var(--transition-fast);
    }
    .card-actions button:hover { border-color: var(--primary-500); color: var(--primary-500); }
    .card-actions .card-download-btn { background: var(--primary-500); color: white; border-color: var(--primary-500); }
    .card-actions .card-download-btn:hover { background: var(--primary-600); }

    @media (max-width: 640px) {
      .card-modal { width: 100%; max-width: 100%; border-radius: 16px 16px 0 0; top: auto; bottom: 0; transform: translateX(-50%) translateY(20px); }
      .card-modal.open { transform: translateX(-50%) translateY(0); }
    }

    /* ===== Panel Actions ===== */
    .panel-actions {
      display: flex;
      gap: var(--space-2);
      padding: var(--space-3) var(--space-5);
      border-top: 1px solid var(--neutral-200);
      background: var(--neutral-50);
    }

    .action-btn {
      display: flex;
      align-items: center;
      gap: var(--space-2);
      padding: var(--space-2) var(--space-3);
      border: 1px solid var(--neutral-200);
      border-radius: 6px;
      background: var(--panel-bg);
      color: var(--neutral-600);
      font-size: var(--text-sm);
      cursor: pointer;
      transition: all var(--transition-fast);
    }

    .action-btn:hover {
      border-color: var(--primary-500);
      color: var(--primary-600);
    }

    .action-btn svg {
      width: 16px;
      height: 16px;
    }

    .action-btn.copied {
      background: var(--success);
      border-color: var(--success);
      color: white;
    }

    /* ===== Loading State ===== */
    .loading-state {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: var(--space-10);
      color: var(--neutral-500);
    }

    .loading-state.hidden {
      display: none;
    }

    .spinner {
      width: 40px;
      height: 40px;
      border: 3px solid var(--neutral-200);
      border-top-color: var(--primary-500);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      margin-bottom: var(--space-4);
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .loading-state p {
      font-size: var(--text-sm);
    }

    /* ===== Toast ===== */
    .toast {
      position: fixed;
      bottom: var(--space-6);
      left: 50%;
      transform: translateX(-50%) translateY(100px);
      background: var(--neutral-900);
      color: white;
      padding: var(--space-3) var(--space-5);
      border-radius: 8px;
      font-size: var(--text-sm);
      box-shadow: var(--shadow-lg);
      transition: transform var(--transition-slow);
      z-index: 3000;
    }

    .toast.visible {
      transform: translateX(-50%) translateY(0);
    }

    /* ===== Floating Action Button ===== */
    .interpret-fab {
      position: fixed;
      bottom: var(--space-6);
      right: var(--space-6);
      background: var(--primary-500);
      color: white;
      border: none;
      padding: var(--space-4) var(--space-6);
      border-radius: 30px;
      font-size: var(--text-base);
      font-weight: 500;
      cursor: pointer;
      box-shadow: var(--shadow-lg);
      display: none;
      z-index: 100;
      transition: background var(--transition-fast), transform var(--transition-fast);
    }

    .interpret-fab:hover {
      background: var(--primary-600);
      transform: translateY(-2px);
    }

    .interpret-fab.visible {
      display: block;
      animation: fabBounce 0.5s ease;
    }

    @keyframes fabBounce {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-8px); }
    }

    /* ===== Keyboard Shortcuts Help ===== */
    .shortcuts-help {
      position: fixed;
      bottom: var(--space-4);
      left: var(--space-4);
      background: var(--neutral-800);
      color: var(--neutral-300);
      padding: var(--space-2) var(--space-3);
      border-radius: 6px;
      font-size: var(--text-xs);
      opacity: 0.7;
      transition: opacity var(--transition-fast);
    }

    .shortcuts-help:hover {
      opacity: 1;
    }

    .shortcuts-help kbd {
      display: inline-block;
      background: var(--neutral-600);
      padding: 2px 6px;
      border-radius: 3px;
      font-family: var(--font-mono);
      margin-right: var(--space-1);
    }

    /* ===== Loading Skeleton ===== */
    .skeleton-verse {
      display: flex;
      gap: var(--space-3);
      margin-bottom: var(--space-4);
      animation: shimmer 1.5s infinite;
    }

    .skeleton-num {
      width: 20px;
      height: 14px;
      background: var(--neutral-200);
      border-radius: 3px;
      flex-shrink: 0;
    }

    .skeleton-line {
      height: 18px;
      background: var(--neutral-200);
      border-radius: 4px;
      flex: 1;
    }

    .skeleton-line.short { width: 70%; flex: none; }
    .skeleton-line.medium { width: 85%; flex: none; }

    @keyframes shimmer {
      0%, 100% { opacity: 0.4; }
      50% { opacity: 1; }
    }

    /* ===== History Button ===== */
    .history-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 40px;
      height: 40px;
      border: none;
      border-radius: 8px;
      background: rgba(255,255,255,0.1);
      color: white;
      cursor: pointer;
      transition: background var(--transition-fast);
      position: relative;
    }

    .history-btn:hover { background: rgba(255,255,255,0.2); }
    .history-btn svg { width: 20px; height: 20px; }

    .history-btn .history-count {
      position: absolute;
      top: 2px;
      right: 2px;
      background: var(--primary-500);
      color: white;
      font-size: 10px;
      width: 16px;
      height: 16px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
    }

    /* ===== History Panel ===== */
    .history-modal {
      display: none;
      position: fixed;
      top: 60px;
      right: 100px;
      background: var(--panel-bg);
      border-radius: 12px;
      box-shadow: var(--shadow-xl);
      padding: var(--space-5);
      width: 360px;
      max-height: 500px;
      overflow-y: auto;
      z-index: 1000;
      color: var(--neutral-700);
    }

    .history-modal.visible { display: block; animation: fadeIn 0.2s ease; }

    .history-modal h3 {
      margin-bottom: var(--space-4);
      font-size: var(--text-base);
      color: var(--neutral-900);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .history-item {
      padding: var(--space-3);
      border: 1px solid var(--neutral-200);
      border-radius: 8px;
      margin-bottom: var(--space-2);
      cursor: pointer;
      transition: all var(--transition-fast);
    }

    .history-item:hover {
      border-color: var(--primary-500);
      background: var(--primary-50);
    }

    .history-item-ref {
      font-weight: 600;
      color: var(--neutral-900);
      font-size: var(--text-sm);
    }

    .history-item-preview {
      font-size: var(--text-xs);
      color: var(--neutral-500);
      margin-top: var(--space-1);
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .history-item-time {
      font-size: 10px;
      color: var(--neutral-400);
      margin-top: var(--space-1);
    }

    .history-clear {
      font-size: var(--text-xs);
      color: var(--error);
      background: none;
      border: none;
      cursor: pointer;
    }

    .history-clear:hover { text-decoration: underline; }

    .history-empty {
      text-align: center;
      color: var(--neutral-400);
      font-size: var(--text-sm);
      padding: var(--space-6) 0;
    }

    /* ===== Compare Translations Modal ===== */
    .compare-modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 1999;
      display: none;
    }

    .compare-modal-backdrop.visible { display: block; }

    .compare-modal {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 90%;
      max-width: 800px;
      max-height: 80vh;
      background: var(--panel-bg);
      border-radius: 12px;
      box-shadow: var(--shadow-xl);
      z-index: 2000;
      overflow: hidden;
      display: none;
    }

    .compare-modal.visible { display: flex; flex-direction: column; }

    .compare-header {
      padding: var(--space-4) var(--space-5);
      border-bottom: 1px solid var(--neutral-200);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .compare-header h3 {
      font-size: var(--text-base);
      font-weight: 600;
      color: var(--neutral-900);
    }

    .compare-body {
      flex: 1;
      overflow-y: auto;
      padding: var(--space-4);
    }

    .compare-row {
      display: grid;
      grid-template-columns: 80px 1fr;
      gap: var(--space-3);
      padding: var(--space-3) 0;
      border-bottom: 1px solid var(--neutral-100);
    }

    .compare-label {
      font-weight: 600;
      font-size: var(--text-sm);
      color: var(--primary-500);
    }

    .compare-text {
      font-family: var(--font-scripture);
      font-size: var(--text-sm);
      color: var(--neutral-700);
      line-height: 1.6;
    }

    /* ===== Search Count ===== */
    .search-count {
      padding: var(--space-2) var(--space-4);
      font-size: var(--text-xs);
      color: var(--neutral-400);
      border-bottom: 1px solid var(--neutral-100);
    }

    .search-result-item.keyboard-active {
      background: var(--primary-50);
      outline: 2px solid var(--primary-500);
      outline-offset: -2px;
    }

    /* ===== Compare Button in Panel ===== */
    .compare-btn {
      display: flex;
      align-items: center;
      gap: var(--space-2);
      padding: var(--space-2) var(--space-3);
      border: 1px solid var(--neutral-200);
      border-radius: 6px;
      background: var(--panel-bg);
      color: var(--neutral-600);
      font-size: var(--text-sm);
      cursor: pointer;
      transition: all var(--transition-fast);
    }

    .compare-btn:hover {
      border-color: var(--primary-500);
      color: var(--primary-600);
    }

    .compare-btn svg { width: 16px; height: 16px; }

    /* ===== Bible Content Wrapper (3-column layout) ===== */
    .bible-content-wrapper {
      display: grid;
      grid-template-columns: 1fr minmax(0, 260px);
      gap: var(--space-6);
      max-width: 1020px;
      width: 100%;
    }

    /* ===== Context Sidebar ===== */
    .context-sidebar {
      position: sticky;
      top: var(--space-4);
      align-self: start;
      display: flex;
      flex-direction: column;
      gap: var(--space-4);
    }

    .context-card, .toc-card, .notes-card {
      background: var(--panel-bg);
      border-radius: 10px;
      padding: var(--space-4);
      box-shadow: var(--shadow-sm);
      border: 1px solid var(--neutral-200);
    }

    .notes-card #notes-list {
      max-height: 300px;
      overflow-y: auto;
    }

    .context-card h4, .toc-card h4, .notes-card h4 {
      font-size: var(--text-xs);
      font-weight: 600;
      color: var(--neutral-500);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-bottom: var(--space-3);
    }

    .context-row {
      display: flex;
      justify-content: space-between;
      padding: 5px 0;
      font-size: var(--text-xs);
      border-bottom: 1px solid var(--neutral-100);
    }

    .context-row:last-child { border-bottom: none; }

    .context-label {
      color: var(--neutral-500);
      font-weight: 500;
    }

    .context-value {
      color: var(--neutral-800);
      font-weight: 500;
      text-align: right;
      max-width: 60%;
    }

    /* ===== TOC ===== */
    .toc-item {
      display: flex;
      align-items: baseline;
      gap: var(--space-2);
      padding: 6px 0;
      cursor: pointer;
      border-bottom: 1px solid var(--neutral-100);
      transition: color var(--transition-fast);
    }

    .toc-item:last-child { border-bottom: none; }
    .toc-item:hover { color: var(--primary-500); }

    .toc-item-verses {
      font-size: 10px;
      font-family: var(--font-mono);
      color: var(--primary-500);
      white-space: nowrap;
      min-width: 36px;
    }

    .toc-item-title {
      font-size: var(--text-xs);
      color: var(--neutral-700);
      line-height: 1.3;
    }

    .toc-item:hover .toc-item-title { color: var(--primary-500); }

    .toc-generate {
      width: 100%;
      padding: 6px;
      border: 1px dashed var(--neutral-300);
      border-radius: 6px;
      background: transparent;
      color: var(--neutral-500);
      font-size: var(--text-xs);
      cursor: pointer;
      transition: all var(--transition-fast);
    }

    .toc-generate:hover {
      border-color: var(--primary-500);
      color: var(--primary-500);
    }

    /* ===== Highlight Palette ===== */
    .highlight-palette {
      position: fixed;
      bottom: calc(var(--space-6) + 52px);
      right: var(--space-6);
      background: var(--panel-bg);
      border-radius: 30px;
      padding: 6px 10px;
      box-shadow: var(--shadow-lg);
      display: none;
      align-items: center;
      gap: 6px;
      z-index: 101;
      border: 1px solid var(--neutral-200);
    }

    .highlight-palette.visible { display: flex; }

    .hl-dot {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      border: 2px solid transparent;
      cursor: pointer;
      transition: transform var(--transition-fast), border-color var(--transition-fast);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 11px;
    }

    .hl-dot:hover { transform: scale(1.2); }
    .hl-dot.active { border-color: var(--neutral-900); }
    .hl-dot[data-color="yellow"] { background: rgba(250, 204, 21, 0.6); }
    .hl-dot[data-color="green"] { background: rgba(34, 197, 94, 0.5); }
    .hl-dot[data-color="blue"] { background: rgba(59, 130, 246, 0.4); }
    .hl-dot[data-color="pink"] { background: rgba(244, 114, 182, 0.5); }
    .hl-dot[data-color="clear"] {
      background: var(--neutral-200);
      font-size: 12px;
      color: var(--neutral-600);
    }

    /* Highlighted verse styles */
    .verse[data-highlight="yellow"] { background: rgba(250, 204, 21, 0.2); border-radius: 3px; }
    .verse[data-highlight="green"] { background: rgba(34, 197, 94, 0.15); border-radius: 3px; }
    .verse[data-highlight="blue"] { background: rgba(59, 130, 246, 0.15); border-radius: 3px; }
    .verse[data-highlight="pink"] { background: rgba(244, 114, 182, 0.15); border-radius: 3px; }

    /* ===== Note Indicator ===== */
    .note-indicator {
      display: inline-block;
      font-size: 9px;
      color: var(--primary-500);
      margin-left: 1px;
      vertical-align: super;
      cursor: pointer;
    }

    /* ===== Note Editor (inline below verses) ===== */
    .note-editor-inline {
      display: block;
      margin: var(--space-2) 0 var(--space-3);
      padding: var(--space-3);
      background: var(--panel-bg);
      border: 1px solid var(--neutral-200);
      border-radius: 8px;
      box-shadow: var(--shadow-sm);
    }

    .note-editor-inline textarea {
      width: 100%;
      min-height: 60px;
      border: 1px solid var(--neutral-200);
      border-radius: 6px;
      padding: var(--space-2);
      font-family: var(--font-ui);
      font-size: var(--text-xs);
      resize: vertical;
      background: var(--neutral-50);
      color: var(--neutral-800);
    }

    .note-editor-inline textarea:focus {
      outline: 2px solid var(--primary-500);
      outline-offset: -1px;
    }

    .note-editor-actions {
      display: flex;
      gap: var(--space-2);
      margin-top: var(--space-2);
      justify-content: flex-end;
    }

    .note-editor-actions button {
      padding: 4px 12px;
      border-radius: 5px;
      font-size: var(--text-xs);
      cursor: pointer;
      border: 1px solid var(--neutral-200);
      background: var(--panel-bg);
      color: var(--neutral-600);
      transition: all var(--transition-fast);
    }

    .note-editor-actions .note-save-btn {
      background: var(--primary-500);
      color: white;
      border-color: var(--primary-500);
    }

    .note-editor-actions .note-save-btn:hover { background: var(--primary-600); }
    .note-editor-actions .note-delete-btn { color: var(--error); border-color: var(--error); }

    /* ===== Notes Panel Card ===== */
    .notes-card .note-item {
      padding: 6px 0;
      border-bottom: 1px solid var(--neutral-100);
      cursor: pointer;
      transition: color var(--transition-fast);
    }

    .notes-card .note-item:last-child { border-bottom: none; }
    .notes-card .note-item:hover { color: var(--primary-500); }

    .note-item-verse {
      font-size: 10px;
      font-weight: 600;
      color: var(--primary-500);
    }

    .note-item-text {
      font-size: var(--text-xs);
      color: var(--neutral-600);
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .notes-empty {
      font-size: var(--text-xs);
      color: var(--neutral-400);
      text-align: center;
      padding: var(--space-3) 0;
    }

    .notes-tabs {
      display: flex;
      gap: 0;
      margin-bottom: var(--space-3);
      border: 1px solid var(--neutral-200);
      border-radius: 6px;
      overflow: hidden;
    }

    .notes-tab {
      flex: 1;
      padding: 5px 0;
      font-size: 10px;
      font-weight: 600;
      text-align: center;
      cursor: pointer;
      background: transparent;
      border: none;
      color: var(--neutral-500);
      transition: all var(--transition-fast);
    }

    .notes-tab.active {
      background: var(--primary-500);
      color: white;
    }

    .notes-tab:not(.active):hover {
      background: var(--neutral-100);
    }

    .note-group-header {
      font-size: 10px;
      font-weight: 600;
      color: var(--neutral-500);
      padding: 8px 0 4px;
      border-bottom: 1px solid var(--neutral-200);
      margin-top: var(--space-2);
    }

    .note-group-header:first-child { margin-top: 0; }

    .note-item-ref {
      font-size: 10px;
      color: var(--neutral-400);
    }

    /* ===== Animations ===== */
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    @keyframes slideUp {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .verse {
      animation: slideUp 0.3s ease backwards;
    }

    /* ===== Reduced Motion ===== */
    @media (prefers-reduced-motion: reduce) {
      *, *::before, *::after {
        animation-duration: 0.01ms !important;
        transition-duration: 0.01ms !important;
      }
    }

    /* ===== Mobile Responsive ===== */
    @media (max-width: 768px) {
      header {
        flex-wrap: wrap;
        padding: var(--space-3);
        gap: var(--space-3);
      }

      header h1 {
        font-size: var(--text-base);
      }

      .nav-controls {
        order: 2;
        width: 100%;
      }

      .nav-controls select {
        flex: 1;
        min-width: 0;
      }

      .header-actions {
        margin-left: auto;
      }

      .main-container {
        flex-direction: column;
      }

      .bible-panel {
        padding: var(--space-4);
      }

      .bible-content {
        max-width: 100%;
      }

      .interpretation-panel {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        width: 100%;
        height: 60vh;
        border-radius: 16px 16px 0 0;
        border-left: none;
        box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.15);
        transform: translateY(100%);
      }

      .interpretation-panel:not(.hidden) {
        transform: translateY(0);
      }

      .interpretation-panel.hidden {
        position: fixed;
      }

      .interpret-fab {
        bottom: var(--space-4);
        right: var(--space-4);
        left: var(--space-4);
        width: auto;
        text-align: center;
      }

      .shortcuts-help {
        display: none;
      }

      .bible-content-wrapper {
        grid-template-columns: 1fr;
      }

      .context-sidebar {
        position: static;
        order: -1;
      }

      .search-modal, .life-app-modal {
        top: 0;
        left: 0;
        transform: none;
        width: 100%;
        max-width: none;
        height: 100vh;
        max-height: none;
        border-radius: 0;
      }
      .life-app-categories { padding: var(--space-3); }
      .life-app-textarea {
        width: calc(100% - var(--space-3) * 2);
        margin: var(--space-2) var(--space-3);
      }
      .life-app-input-footer { padding: 0 var(--space-3) var(--space-3); }
      .life-app-cards { padding: var(--space-3); }
    }

    /* ===== Life Application Modal ===== */
    .life-app-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 1999;
      opacity: 0;
      visibility: hidden;
      transition: opacity var(--transition-normal), visibility var(--transition-normal);
    }
    .life-app-backdrop.open { opacity: 1; visibility: visible; }

    .life-app-modal {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 90%;
      max-width: 580px;
      max-height: 85vh;
      background: var(--panel-bg);
      border-radius: 12px;
      box-shadow: var(--shadow-xl);
      z-index: 2000;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      opacity: 0;
      visibility: hidden;
      transition: opacity var(--transition-normal), visibility var(--transition-normal);
    }
    .life-app-modal.open { opacity: 1; visibility: visible; }

    .life-app-header {
      padding: var(--space-4) var(--space-5);
      border-bottom: 1px solid var(--neutral-200);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .life-app-header h3 {
      font-size: var(--text-base);
      font-weight: 600;
      color: var(--neutral-900);
      margin: 0;
    }

    .life-app-categories {
      display: flex;
      flex-wrap: wrap;
      gap: var(--space-2);
      padding: var(--space-4) var(--space-5) 0;
    }
    .life-app-chip {
      padding: var(--space-1) var(--space-3);
      border: 1px solid var(--neutral-200);
      border-radius: 20px;
      font-size: var(--text-xs);
      color: var(--neutral-600);
      cursor: pointer;
      background: transparent;
      transition: all var(--transition-fast);
      white-space: nowrap;
      font-family: var(--font-ui);
    }
    .life-app-chip:hover {
      border-color: var(--primary-500);
      color: var(--primary-600);
      background: var(--primary-50);
    }
    .life-app-chip.active {
      background: var(--primary-500);
      color: white;
      border-color: var(--primary-500);
    }

    .life-app-textarea {
      width: calc(100% - var(--space-5) * 2);
      margin: var(--space-3) var(--space-5);
      padding: var(--space-3);
      border: 1px solid var(--neutral-200);
      border-radius: 8px;
      font-family: var(--font-ui);
      font-size: var(--text-sm);
      line-height: 1.6;
      color: var(--neutral-800);
      background: var(--neutral-50);
      resize: vertical;
      min-height: 100px;
      max-height: 200px;
      transition: border-color var(--transition-fast);
    }
    .life-app-textarea:focus {
      outline: none;
      border-color: var(--primary-500);
      box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
    }
    .life-app-textarea::placeholder { color: var(--neutral-400); }

    .life-app-input-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0 var(--space-5) var(--space-4);
    }
    .life-app-char-count {
      font-size: var(--text-xs);
      color: var(--neutral-400);
    }
    .life-app-submit {
      padding: var(--space-2) var(--space-5);
      background: var(--primary-500);
      color: white;
      border: none;
      border-radius: 8px;
      font-size: var(--text-sm);
      font-weight: 500;
      font-family: var(--font-ui);
      cursor: pointer;
      transition: background var(--transition-fast), opacity var(--transition-fast);
    }
    .life-app-submit:hover:not(:disabled) { background: var(--primary-600); }
    .life-app-submit:disabled { opacity: 0.4; cursor: not-allowed; }

    .life-app-loading {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: var(--space-10);
      color: var(--neutral-500);
    }
    .life-app-loading.hidden { display: none; }
    .life-app-loading p { font-size: var(--text-sm); margin-top: var(--space-4); }

    .life-app-results { overflow-y: auto; flex: 1; }
    .life-app-results.hidden { display: none; }

    .life-app-situation {
      padding: var(--space-3) var(--space-5);
      font-size: var(--text-xs);
      color: var(--neutral-500);
      font-style: italic;
      border-bottom: 1px solid var(--neutral-100);
    }

    .life-app-cards {
      padding: var(--space-4) var(--space-5);
      display: flex;
      flex-direction: column;
      gap: var(--space-4);
    }

    .life-app-card {
      border: 1px solid var(--neutral-200);
      border-radius: 10px;
      padding: var(--space-4);
      box-shadow: var(--shadow-sm);
      transition: all var(--transition-fast);
      animation: slideUp 0.3s ease backwards;
    }
    .life-app-card:hover {
      border-color: var(--primary-500);
      box-shadow: var(--shadow-md);
    }

    .life-app-card-ref {
      font-weight: 600;
      font-size: var(--text-sm);
      color: var(--primary-500);
      margin-bottom: var(--space-2);
    }

    .life-app-card-text {
      font-family: var(--font-scripture);
      font-size: var(--text-sm);
      color: var(--neutral-600);
      font-style: italic;
      line-height: 1.6;
      margin-bottom: var(--space-3);
      padding-left: var(--space-3);
      border-left: 2px solid var(--primary-100);
    }

    .life-app-card-insight {
      font-size: var(--text-sm);
      color: var(--neutral-700);
      line-height: 1.7;
      margin-bottom: var(--space-3);
    }

    .life-app-card-greek {
      font-size: var(--text-xs);
      color: var(--neutral-500);
      background: var(--neutral-100);
      padding: var(--space-2) var(--space-3);
      border-radius: 6px;
      margin-bottom: var(--space-3);
      line-height: 1.5;
    }
    .life-app-card-greek strong { color: var(--neutral-700); }

    .life-app-card-read {
      display: inline-flex;
      align-items: center;
      gap: var(--space-2);
      padding: var(--space-2) var(--space-3);
      border: 1px solid var(--neutral-200);
      border-radius: 6px;
      background: var(--panel-bg);
      color: var(--primary-500);
      font-size: var(--text-xs);
      font-weight: 500;
      font-family: var(--font-ui);
      cursor: pointer;
      transition: all var(--transition-fast);
    }
    .life-app-card-read:hover {
      background: var(--primary-50);
      border-color: var(--primary-500);
    }
    .life-app-card-read svg { width: 14px; height: 14px; }

    .life-app-back {
      display: flex;
      align-items: center;
      gap: var(--space-2);
      margin: var(--space-3) var(--space-5) var(--space-4);
      padding: var(--space-2) var(--space-3);
      border: 1px solid var(--neutral-200);
      border-radius: 6px;
      background: transparent;
      color: var(--neutral-500);
      font-size: var(--text-xs);
      font-family: var(--font-ui);
      cursor: pointer;
      transition: all var(--transition-fast);
    }
    .life-app-back:hover { color: var(--primary-500); border-color: var(--primary-500); }

    /* ===== Left Drawer ===== */
    .drawer-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 40px;
      height: 40px;
      border-radius: 8px;
      border: none;
      background: rgba(255,255,255,0.1);
      color: white;
      cursor: pointer;
      transition: background var(--transition-fast);
      flex-shrink: 0;
    }
    .drawer-btn:hover { background: rgba(255,255,255,0.2); }
    .drawer-btn svg { width: 20px; height: 20px; }

    .drawer-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.4);
      z-index: 1999;
      opacity: 0;
      visibility: hidden;
      transition: opacity var(--transition-slow), visibility var(--transition-slow);
    }
    .drawer-backdrop.open { opacity: 1; visibility: visible; }

    .drawer {
      position: fixed;
      top: 0;
      left: 0;
      bottom: 0;
      width: 300px;
      background: var(--header-bg);
      color: rgba(255,255,255,0.9);
      z-index: 2000;
      transform: translateX(-100%);
      transition: transform var(--transition-slow);
      overflow-y: auto;
      display: flex;
      flex-direction: column;
    }
    .drawer.open { transform: translateX(0); }

    .drawer-header {
      padding: var(--space-5) var(--space-5) var(--space-4);
      border-bottom: 1px solid rgba(255,255,255,0.1);
    }
    .drawer-greeting {
      font-size: var(--text-lg);
      font-weight: 600;
      margin-bottom: var(--space-1);
    }
    .drawer-date {
      font-size: var(--text-xs);
      color: rgba(255,255,255,0.5);
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .drawer-section {
      padding: var(--space-3) var(--space-3);
    }
    .drawer-section-label {
      font-size: var(--text-xs);
      color: rgba(255,255,255,0.4);
      text-transform: uppercase;
      letter-spacing: 0.08em;
      font-weight: 600;
      padding: var(--space-2) var(--space-3);
      margin-bottom: var(--space-1);
    }

    .drawer-item {
      display: flex;
      align-items: center;
      gap: var(--space-3);
      padding: var(--space-3) var(--space-3);
      border-radius: 8px;
      cursor: pointer;
      transition: background var(--transition-fast);
      border: none;
      background: transparent;
      color: rgba(255,255,255,0.85);
      font-family: var(--font-ui);
      font-size: var(--text-sm);
      font-weight: 500;
      width: 100%;
      text-align: left;
    }
    .drawer-item:hover { background: rgba(255,255,255,0.1); }
    .drawer-item svg { width: 18px; height: 18px; flex-shrink: 0; opacity: 0.7; }
    .drawer-item-label { flex: 1; }
    .drawer-item-badge {
      font-size: var(--text-xs);
      color: rgba(255,255,255,0.4);
    }

    .drawer-devotional-preview {
      margin: var(--space-1) 0 var(--space-2);
      padding: var(--space-3);
      background: rgba(255,255,255,0.05);
      border-radius: 8px;
      margin-left: var(--space-3);
      margin-right: var(--space-3);
    }
    .drawer-devotional-preview p {
      font-size: var(--text-xs);
      color: rgba(255,255,255,0.6);
      font-style: italic;
      line-height: 1.5;
      margin: 0;
    }

    .drawer-divider {
      height: 1px;
      background: rgba(255,255,255,0.08);
      margin: var(--space-1) var(--space-3);
    }

    @media (max-width: 768px) {
      .drawer { width: 100%; }
    }

    /* ===== Prayer Journal ===== */
    .prayer-item {
      padding: 6px 0;
      border-bottom: 1px solid var(--neutral-100);
      cursor: pointer;
      transition: color var(--transition-fast);
    }
    .prayer-item:last-child { border-bottom: none; }
    .prayer-item:hover { color: var(--primary-500); }
    .prayer-item.answered { opacity: 0.5; }
    .prayer-item.answered .prayer-item-text { text-decoration: line-through; }

    .prayer-item-header {
      display: flex;
      align-items: center;
      gap: var(--space-1);
    }
    .prayer-item-verse {
      font-size: 10px;
      font-weight: 600;
      color: var(--primary-500);
    }
    .prayer-item-date {
      font-size: 9px;
      color: var(--neutral-400);
      margin-left: auto;
    }
    .prayer-item-text {
      font-size: var(--text-xs);
      color: var(--neutral-600);
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .prayer-answered-check {
      width: 14px;
      height: 14px;
      border-radius: 50%;
      border: 1.5px solid var(--neutral-300);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 9px;
      flex-shrink: 0;
      transition: all var(--transition-fast);
    }
    .prayer-answered-check:hover { border-color: var(--success); }
    .prayer-answered-check.checked {
      background: var(--success);
      border-color: var(--success);
      color: white;
    }

    .prayer-editor-toggle {
      display: flex;
      gap: 0;
      margin-bottom: var(--space-2);
      border: 1px solid var(--neutral-200);
      border-radius: 5px;
      overflow: hidden;
    }
    .prayer-editor-toggle button {
      flex: 1;
      padding: 4px 0;
      font-size: 10px;
      font-weight: 600;
      text-align: center;
      cursor: pointer;
      background: transparent;
      border: none;
      color: var(--neutral-500);
      transition: all var(--transition-fast);
    }
    .prayer-editor-toggle button.active {
      background: var(--primary-500);
      color: white;
    }

    .prayer-journal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.4);
      z-index: 1999;
      opacity: 0;
      visibility: hidden;
      transition: opacity var(--transition-slow), visibility var(--transition-slow);
    }
    .prayer-journal-backdrop.open { opacity: 1; visibility: visible; }

    .prayer-journal-modal {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 90%;
      max-width: 520px;
      max-height: 85vh;
      background: var(--panel-bg);
      border-radius: 12px;
      box-shadow: var(--shadow-xl);
      z-index: 2000;
      opacity: 0;
      visibility: hidden;
      transition: opacity var(--transition-slow), visibility var(--transition-slow);
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    .prayer-journal-modal.open { opacity: 1; visibility: visible; }

    .prayer-journal-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: var(--space-4) var(--space-5);
      border-bottom: 1px solid var(--neutral-200);
    }
    .prayer-journal-header h3 {
      font-size: var(--text-lg);
      font-weight: 600;
      color: var(--neutral-900);
      margin: 0;
    }

    .prayer-journal-filters {
      display: flex;
      gap: 0;
      margin: var(--space-3) var(--space-5) 0;
      border: 1px solid var(--neutral-200);
      border-radius: 6px;
      overflow: hidden;
    }
    .prayer-filter-btn {
      flex: 1;
      padding: 5px 0;
      font-size: 10px;
      font-weight: 600;
      text-align: center;
      cursor: pointer;
      background: transparent;
      border: none;
      color: var(--neutral-500);
      transition: all var(--transition-fast);
    }
    .prayer-filter-btn.active {
      background: var(--primary-500);
      color: white;
    }
    .prayer-filter-btn:not(.active):hover { background: var(--neutral-100); }

    .prayer-journal-list {
      flex: 1;
      overflow-y: auto;
      padding: var(--space-3) var(--space-5) var(--space-5);
    }

    .prayer-full-item {
      padding: var(--space-3);
      border: 1px solid var(--neutral-200);
      border-radius: 8px;
      margin-bottom: var(--space-3);
      transition: opacity var(--transition-fast);
    }
    .prayer-full-item.answered { opacity: 0.6; }
    .prayer-full-item-header {
      display: flex;
      align-items: center;
      gap: var(--space-2);
      margin-bottom: var(--space-1);
    }
    .prayer-full-item-ref {
      font-size: var(--text-xs);
      font-weight: 600;
      color: var(--primary-500);
      cursor: pointer;
    }
    .prayer-full-item-ref:hover { text-decoration: underline; }
    .prayer-full-item-date {
      font-size: var(--text-xs);
      color: var(--neutral-400);
      margin-left: auto;
    }
    .prayer-full-item-text {
      font-size: var(--text-sm);
      color: var(--neutral-700);
      line-height: 1.6;
      margin-bottom: var(--space-2);
    }
    .prayer-full-item.answered .prayer-full-item-text { text-decoration: line-through; color: var(--neutral-400); }
    .prayer-full-actions {
      display: flex;
      align-items: center;
      gap: var(--space-2);
    }
    .prayer-full-actions button {
      font-size: var(--text-xs);
      padding: 3px 8px;
      border-radius: 4px;
      border: 1px solid var(--neutral-200);
      background: transparent;
      color: var(--neutral-500);
      cursor: pointer;
      font-family: var(--font-ui);
      transition: all var(--transition-fast);
    }
    .prayer-full-actions button:hover { border-color: var(--primary-500); color: var(--primary-500); }
    .prayer-full-actions .prayer-delete-btn:hover { border-color: var(--error); color: var(--error); }

    @media (max-width: 768px) {
      .prayer-journal-modal {
        top: 0; left: 0; transform: none;
        width: 100%; max-width: none; height: 100vh; max-height: none; border-radius: 0;
      }
    }

    /* ===== Topical Browse Modal ===== */
    .topical-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.4);
      z-index: 1999;
      opacity: 0;
      visibility: hidden;
      transition: opacity var(--transition-slow), visibility var(--transition-slow);
    }
    .topical-backdrop.open { opacity: 1; visibility: visible; }

    .topical-modal {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 90%;
      max-width: 580px;
      max-height: 85vh;
      background: var(--panel-bg);
      border-radius: 12px;
      box-shadow: var(--shadow-xl);
      z-index: 2000;
      opacity: 0;
      visibility: hidden;
      transition: opacity var(--transition-slow), visibility var(--transition-slow);
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    .topical-modal.open { opacity: 1; visibility: visible; }

    .topical-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: var(--space-4) var(--space-5);
      border-bottom: 1px solid var(--neutral-200);
    }
    .topical-header h3 {
      font-size: var(--text-lg);
      font-weight: 600;
      color: var(--neutral-900);
      margin: 0;
    }

    .topical-topics {
      display: flex;
      flex-wrap: wrap;
      gap: var(--space-2);
      padding: var(--space-4) var(--space-5);
      max-height: 200px;
      overflow-y: auto;
    }

    .topical-chip {
      padding: var(--space-2) var(--space-3);
      border-radius: 20px;
      border: 1px solid var(--neutral-200);
      background: transparent;
      color: var(--neutral-700);
      font-size: var(--text-xs);
      font-family: var(--font-ui);
      cursor: pointer;
      transition: all var(--transition-fast);
    }
    .topical-chip:hover { border-color: var(--primary-500); color: var(--primary-500); }
    .topical-chip.active { background: var(--primary-500); color: white; border-color: var(--primary-500); }

    .topical-custom {
      display: flex;
      gap: var(--space-2);
      padding: 0 var(--space-5) var(--space-3);
    }
    .topical-custom input {
      flex: 1;
      padding: var(--space-2) var(--space-3);
      border: 1px solid var(--neutral-200);
      border-radius: 6px;
      font-size: var(--text-sm);
      font-family: var(--font-ui);
      background: var(--panel-bg);
      color: var(--neutral-900);
    }
    .topical-custom input:focus { outline: none; border-color: var(--primary-500); }
    .topical-custom button {
      padding: var(--space-2) var(--space-4);
      border-radius: 6px;
      border: none;
      background: var(--primary-500);
      color: white;
      font-size: var(--text-sm);
      font-weight: 500;
      font-family: var(--font-ui);
      cursor: pointer;
      transition: background var(--transition-fast);
    }
    .topical-custom button:hover { background: var(--primary-600); }
    .topical-custom button:disabled { opacity: 0.5; cursor: not-allowed; }

    .topical-results {
      flex: 1;
      overflow-y: auto;
      padding: 0 var(--space-5) var(--space-5);
    }
    .topical-results.hidden { display: none; }
    #topical-input-view.hidden { display: none; }

    .topical-description {
      font-size: var(--text-sm);
      color: var(--neutral-600);
      line-height: 1.6;
      margin-bottom: var(--space-4);
      padding: var(--space-3);
      background: var(--neutral-50);
      border-radius: 8px;
    }

    .topical-card {
      border: 1px solid var(--neutral-200);
      border-radius: 10px;
      padding: var(--space-4);
      margin-bottom: var(--space-3);
      animation: slideUp 0.3s ease backwards;
    }
    .topical-card-ref {
      font-size: var(--text-sm);
      font-weight: 600;
      color: var(--primary-500);
      margin-bottom: var(--space-1);
    }
    .topical-card-verse {
      font-family: var(--font-scripture);
      font-style: italic;
      font-size: var(--text-sm);
      color: var(--neutral-600);
      line-height: 1.6;
      padding-left: var(--space-3);
      border-left: 2px solid var(--primary-100);
      margin-bottom: var(--space-2);
    }
    .topical-card-summary {
      font-size: var(--text-xs);
      color: var(--neutral-500);
      line-height: 1.5;
      margin-bottom: var(--space-3);
    }

    .topical-back {
      display: flex;
      align-items: center;
      gap: var(--space-2);
      margin-bottom: var(--space-4);
      padding: var(--space-2) var(--space-3);
      border: 1px solid var(--neutral-200);
      border-radius: 6px;
      background: transparent;
      color: var(--neutral-500);
      font-size: var(--text-xs);
      font-family: var(--font-ui);
      cursor: pointer;
      transition: all var(--transition-fast);
    }
    .topical-back:hover { color: var(--primary-500); border-color: var(--primary-500); }

    @media (max-width: 768px) {
      .topical-modal {
        top: 0; left: 0; transform: none;
        width: 100%; max-width: none; height: 100vh; max-height: none; border-radius: 0;
      }
    }

    /* Daily Devotional */
    .devotional-card {
      max-width: 680px;
      margin: var(--space-6) auto;
      background: var(--panel-bg);
      border-radius: 16px;
      border: 1px solid var(--neutral-200);
      overflow: hidden;
      animation: slideUp 0.4s ease;
    }
    .devotional-card-header {
      padding: var(--space-5) var(--space-6);
      background: linear-gradient(135deg, var(--primary-500), #8b5cf6);
      color: white;
    }
    .devotional-card-date {
      font-size: var(--text-xs);
      opacity: 0.85;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: var(--space-1);
    }
    .devotional-card-title {
      font-family: var(--font-scripture);
      font-size: var(--text-lg);
      font-weight: 600;
    }
    .devotional-card-body {
      padding: var(--space-5) var(--space-6);
    }
    .devotional-verse-text {
      font-family: var(--font-scripture);
      font-size: var(--text-base);
      line-height: 1.8;
      color: var(--neutral-700);
      padding: var(--space-4);
      background: var(--neutral-50);
      border-radius: 10px;
      border-left: 3px solid var(--primary-500);
      margin-bottom: var(--space-4);
    }
    .devotional-reflection {
      font-size: var(--text-sm);
      line-height: 1.7;
      color: var(--neutral-600);
      margin-bottom: var(--space-4);
    }
    .devotional-language-box {
      display: flex;
      gap: var(--space-3);
      padding: var(--space-3) var(--space-4);
      background: var(--neutral-50);
      border-radius: 8px;
      margin-bottom: var(--space-4);
      align-items: flex-start;
    }
    .devotional-language-word {
      font-family: var(--font-scripture);
      font-size: var(--text-lg);
      font-weight: 600;
      color: var(--primary-500);
      white-space: nowrap;
    }
    .devotional-language-detail {
      font-size: var(--text-xs);
      color: var(--neutral-500);
      line-height: 1.5;
    }
    .devotional-language-detail strong {
      color: var(--neutral-700);
    }
    .devotional-application {
      font-size: var(--text-sm);
      color: var(--neutral-600);
      font-style: italic;
      padding: var(--space-3) var(--space-4);
      border-top: 1px solid var(--neutral-100);
    }
    .devotional-card-actions {
      display: flex;
      gap: var(--space-2);
      padding: var(--space-3) var(--space-6) var(--space-5);
    }
    .devotional-card-actions button {
      padding: var(--space-2) var(--space-4);
      border-radius: 8px;
      font-size: var(--text-sm);
      font-family: var(--font-ui);
      cursor: pointer;
      transition: all var(--transition-fast);
      border: 1px solid var(--neutral-200);
      background: transparent;
      color: var(--neutral-600);
    }
    .devotional-card-actions button:hover {
      border-color: var(--primary-500);
      color: var(--primary-500);
    }
    .devotional-read-btn {
      background: var(--primary-500) !important;
      color: white !important;
      border-color: var(--primary-500) !important;
    }
    .devotional-read-btn:hover {
      background: var(--primary-600) !important;
    }
    .devotional-dismiss-btn {
      margin-left: auto;
    }
    @media (max-width: 768px) {
      .devotional-card { margin: var(--space-3); }
      .devotional-card-header, .devotional-card-body, .devotional-card-actions {
        padding-left: var(--space-4); padding-right: var(--space-4);
      }
    }

    /* Reading Plans */
    .plans-backdrop {
      position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 1999;
      opacity: 0; visibility: hidden; transition: all var(--transition-normal);
    }
    .plans-backdrop.open { opacity: 1; visibility: visible; }
    .plans-modal {
      position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
      width: 90%; max-width: 580px; max-height: 85vh;
      background: var(--panel-bg); border-radius: 16px;
      box-shadow: var(--shadow-xl); z-index: 2000;
      display: flex; flex-direction: column;
      opacity: 0; visibility: hidden; transition: all var(--transition-normal);
    }
    .plans-modal.open { opacity: 1; visibility: visible; }
    .plans-header {
      display: flex; justify-content: space-between; align-items: center;
      padding: var(--space-4) var(--space-5);
      border-bottom: 1px solid var(--neutral-100);
    }
    .plans-header h3 { font-size: var(--text-base); font-weight: 600; color: var(--neutral-900); }
    .plans-body { flex: 1; overflow-y: auto; padding: var(--space-4) var(--space-5); }
    .plans-body.hidden { display: none; }

    .plans-streak {
      display: flex; align-items: center; gap: var(--space-3);
      padding: var(--space-3) var(--space-4);
      background: linear-gradient(135deg, #fef3c7, #fde68a);
      border-radius: 10px; margin-bottom: var(--space-4);
    }
    .plans-streak-fire { font-size: 24px; }
    .plans-streak-info { flex: 1; }
    .plans-streak-count { font-size: var(--text-lg); font-weight: 700; color: #92400e; }
    .plans-streak-label { font-size: var(--text-xs); color: #b45309; }

    .plan-card {
      border: 1px solid var(--neutral-200); border-radius: 10px;
      padding: var(--space-4); margin-bottom: var(--space-3);
      cursor: pointer; transition: all var(--transition-fast);
    }
    .plan-card:hover { border-color: var(--primary-500); }
    .plan-card-title { font-weight: 600; font-size: var(--text-sm); color: var(--neutral-900); margin-bottom: var(--space-1); }
    .plan-card-desc { font-size: var(--text-xs); color: var(--neutral-500); margin-bottom: var(--space-2); line-height: 1.5; }
    .plan-card-meta { display: flex; gap: var(--space-3); font-size: var(--text-xs); color: var(--neutral-400); }
    .plan-card.active { border-color: var(--primary-500); background: rgba(99,102,241,0.05); }
    .plan-card.active .plan-card-title { color: var(--primary-500); }

    .plan-progress-bar {
      height: 6px; background: var(--neutral-100); border-radius: 3px;
      margin-top: var(--space-2); overflow: hidden;
    }
    .plan-progress-fill {
      height: 100%; background: var(--primary-500); border-radius: 3px;
      transition: width 0.3s ease;
    }

    .plan-detail-back {
      display: flex; align-items: center; gap: var(--space-2);
      margin-bottom: var(--space-4);
      padding: var(--space-2) var(--space-3);
      border: 1px solid var(--neutral-200); border-radius: 6px;
      background: transparent; color: var(--neutral-500);
      font-size: var(--text-xs); font-family: var(--font-ui); cursor: pointer;
    }
    .plan-detail-back:hover { color: var(--primary-500); border-color: var(--primary-500); }

    .plan-today-card {
      background: var(--neutral-50); border-radius: 10px;
      padding: var(--space-4); margin-bottom: var(--space-4);
    }
    .plan-today-label { font-size: var(--text-xs); color: var(--neutral-400); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: var(--space-1); }
    .plan-today-ref { font-size: var(--text-base); font-weight: 600; color: var(--neutral-900); margin-bottom: var(--space-1); }
    .plan-today-title { font-size: var(--text-sm); color: var(--neutral-500); margin-bottom: var(--space-3); }
    .plan-today-actions { display: flex; gap: var(--space-2); }
    .plan-today-actions button {
      padding: var(--space-2) var(--space-4); border-radius: 8px;
      font-size: var(--text-sm); font-family: var(--font-ui); cursor: pointer;
      border: 1px solid var(--neutral-200); background: transparent; color: var(--neutral-600);
      transition: all var(--transition-fast);
    }
    .plan-read-btn { background: var(--primary-500) !important; color: white !important; border-color: var(--primary-500) !important; }
    .plan-read-btn:hover { background: var(--primary-600) !important; }
    .plan-mark-btn:hover { border-color: #10b981; color: #10b981; }

    .plan-calendar {
      display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px;
      margin-top: var(--space-3);
    }
    .plan-calendar-day {
      aspect-ratio: 1; border-radius: 4px;
      background: var(--neutral-100); display: flex; align-items: center;
      justify-content: center; font-size: 10px; color: var(--neutral-400);
    }
    .plan-calendar-day.completed { background: var(--primary-500); color: white; }
    .plan-calendar-day.today { border: 2px solid var(--primary-500); }

    .plan-start-btn {
      width: 100%; padding: var(--space-2) var(--space-4); border-radius: 8px;
      border: none; background: var(--primary-500); color: white;
      font-size: var(--text-sm); font-weight: 500; font-family: var(--font-ui);
      cursor: pointer; margin-top: var(--space-2);
    }
    .plan-start-btn:hover { background: var(--primary-600); }

    @media (max-width: 768px) {
      .plans-modal {
        top: 0; left: 0; transform: none;
        width: 100%; max-width: none; height: 100vh; max-height: none; border-radius: 0;
      }
    }
    /* ===== Auth UI ===== */
    .auth-btn {
      position: relative;
    }
    .auth-btn svg { width: 20px; height: 20px; }
    .auth-avatar {
      width: 24px; height: 24px; border-radius: 50%;
      background: var(--primary-500); color: #fff;
      display: flex; align-items: center; justify-content: center;
      font-size: 12px; font-weight: 600; text-transform: uppercase;
    }
    .auth-avatar.syncing { animation: pulse-sync 1.5s ease-in-out infinite; }
    @keyframes pulse-sync { 0%,100% { opacity: 1; } 50% { opacity: 0.5; } }
    .sync-dot {
      position: absolute; top: 4px; right: 4px; width: 7px; height: 7px;
      border-radius: 50%; border: 1.5px solid var(--header-bg);
    }
    .sync-dot.green { background: #10B981; }
    .sync-dot.yellow { background: #F59E0B; }
    .sync-dot.red { background: #EF4444; }

    .auth-backdrop {
      display: none; position: fixed; inset: 0; z-index: 999;
      background: rgba(0,0,0,0.5); backdrop-filter: blur(4px);
    }
    .auth-backdrop.open { display: block; }

    .auth-modal {
      display: none; position: fixed; top: 50%; left: 50%;
      transform: translate(-50%, -50%); z-index: 1000;
      background: var(--panel-bg); border-radius: 16px;
      padding: var(--space-8); width: 380px; max-width: 92vw;
      box-shadow: var(--shadow-xl); animation: fadeIn 0.2s ease;
    }
    .auth-modal.open { display: block; }

    .auth-modal h3 {
      font-size: var(--text-xl); font-weight: 600; color: var(--neutral-900);
      margin-bottom: var(--space-6); text-align: center;
    }
    .auth-form-group {
      margin-bottom: var(--space-4);
    }
    .auth-form-group label {
      display: block; font-size: var(--text-sm); font-weight: 500;
      color: var(--neutral-600); margin-bottom: var(--space-1);
    }
    .auth-form-group input {
      width: 100%; padding: 10px 12px; border-radius: 8px;
      border: 1.5px solid var(--neutral-300); background: var(--neutral-50);
      color: var(--neutral-900); font-size: var(--text-sm);
      font-family: var(--font-ui); outline: none; box-sizing: border-box;
    }
    .auth-form-group input:focus {
      border-color: var(--primary-500);
      box-shadow: 0 0 0 3px rgba(99,102,241,0.15);
    }
    .auth-submit {
      width: 100%; padding: 10px; border-radius: 8px; border: none;
      background: var(--primary-500); color: #fff; font-weight: 600;
      font-size: var(--text-sm); cursor: pointer; margin-top: var(--space-2);
      transition: background var(--transition-fast);
    }
    .auth-submit:hover { background: var(--primary-600); }
    .auth-submit:disabled { opacity: 0.6; cursor: not-allowed; }
    .auth-toggle {
      text-align: center; margin-top: var(--space-4);
      font-size: var(--text-xs); color: var(--neutral-500);
    }
    .auth-toggle a {
      color: var(--primary-500); cursor: pointer; text-decoration: underline;
    }
    .auth-error {
      color: var(--error); font-size: var(--text-xs);
      text-align: center; margin-top: var(--space-2); min-height: 18px;
    }
    .auth-profile {
      text-align: center;
    }
    .auth-profile-avatar {
      width: 48px; height: 48px; border-radius: 50%;
      background: var(--primary-500); color: #fff;
      display: inline-flex; align-items: center; justify-content: center;
      font-size: 20px; font-weight: 600; text-transform: uppercase;
      margin-bottom: var(--space-3);
    }
    .auth-profile-email {
      font-size: var(--text-sm); color: var(--neutral-600);
      margin-bottom: var(--space-1);
    }
    .auth-profile-sync {
      font-size: var(--text-xs); color: var(--neutral-400);
      margin-bottom: var(--space-6);
    }
    .auth-signout {
      width: 100%; padding: 10px; border-radius: 8px;
      border: 1.5px solid var(--neutral-300); background: transparent;
      color: var(--neutral-700); font-weight: 500; font-size: var(--text-sm);
      cursor: pointer; transition: all var(--transition-fast);
    }
    .auth-signout:hover { border-color: var(--error); color: var(--error); }

    .auth-migration {
      text-align: center; padding: var(--space-4) 0;
    }
    .auth-migration p {
      font-size: var(--text-sm); color: var(--neutral-600);
      margin-bottom: var(--space-4); line-height: 1.5;
    }
    .auth-migration-actions {
      display: flex; gap: var(--space-3); justify-content: center;
    }
    .auth-migration-actions button {
      padding: 8px 20px; border-radius: 8px; font-weight: 500;
      font-size: var(--text-sm); cursor: pointer; border: none;
    }
    .auth-migration-actions .import-btn {
      background: var(--primary-500); color: #fff;
    }
    .auth-migration-actions .skip-btn {
      background: var(--neutral-200); color: var(--neutral-700);
    }

    @media (max-width: 600px) {
      .auth-modal { width: 100%; max-width: 100%; border-radius: 16px 16px 0 0;
        top: auto; bottom: 0; transform: translate(-50%, 0); }
    }

  </style>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
</head>
<body>
  <a href="#verses-container" class="sr-only">Skip to content</a>

  <header>
    <button class="drawer-btn" id="drawer-btn" title="Menu (`)" aria-label="Open menu">
      <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/></svg>
    </button>
    <h1>Bible Interpreter</h1>
    <div class="nav-controls">
      <button class="nav-btn" id="prev-chapter" title="Previous Chapter" aria-label="Previous chapter">
        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/></svg>
      </button>
      <select id="book-select" aria-label="Select book"></select>
      <select id="chapter-select" aria-label="Select chapter"></select>
      <button class="nav-btn" id="next-chapter" title="Next Chapter" aria-label="Next chapter">
        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg>
      </button>
      <button class="go-btn" id="load-chapter">Go</button>
    </div>
    <div class="header-actions">
      <select id="version-select" class="version-select" aria-label="Select Bible version" title="Bible version">
        <option value="NIV2011">NIV</option>
        <option value="ESV">ESV</option>
        <option value="KJV">KJV</option>
        <option value="NLT">NLT</option>
        <option value="NKJV">NKJV</option>
        <option value="CSB17">CSB</option>
        <option value="NASB">NASB</option>
        <option value="MSG">MSG</option>
        <option value="AMP">AMP</option>
      </select>
      <button class="history-btn" id="history-btn" title="Interpretation History" aria-label="View interpretation history">
        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
        <span class="history-count" id="history-count" style="display:none">0</span>
      </button>
      <button class="nav-btn auth-btn" id="auth-btn" title="Account" aria-label="Account">
        <svg id="auth-icon-loggedout" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/></svg>
        <span id="auth-icon-loggedin" style="display:none" class="auth-avatar"></span>
        <span class="sync-dot" id="sync-dot" style="display:none"></span>
      </button>
      <button class="theme-toggle" id="theme-toggle" title="Toggle dark mode" aria-label="Toggle dark mode">
        <svg class="moon-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"/></svg>
        <svg class="sun-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"/></svg>
      </button>
      <div class="usage-badge" id="usage-badge" title="Click to view API usage" role="button" tabindex="0">
        API: <span id="usage-cost">$0.00</span>
      </div>
    </div>
  </header>

  <div class="drawer-backdrop" id="drawer-backdrop"></div>
  <nav class="drawer" id="drawer" role="navigation" aria-label="Main menu">
    <div class="drawer-header">
      <div class="drawer-greeting" id="drawer-greeting"></div>
      <div class="drawer-date" id="drawer-date"></div>
    </div>

    <div class="drawer-section">
      <button class="drawer-item" id="drawer-devotional">
        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"/></svg>
        <span class="drawer-item-label">Daily Devotional</span>
      </button>
      <div class="drawer-devotional-preview" id="drawer-devotional-preview" style="display:none">
        <p id="drawer-devotional-verse"></p>
      </div>
    </div>

    <div class="drawer-divider"></div>

    <div class="drawer-section">
      <div class="drawer-section-label">Study</div>
      <button class="drawer-item" id="drawer-topical">
        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z"/></svg>
        <span class="drawer-item-label">Topical Browse</span>
        <span class="drawer-item-badge">T</span>
      </button>
      <button class="drawer-item" id="drawer-plans">
        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg>
        <span class="drawer-item-label">Reading Plans</span>
        <span class="drawer-item-badge">P</span>
      </button>
    </div>

    <div class="drawer-divider"></div>

    <div class="drawer-section">
      <div class="drawer-section-label">Personal</div>
      <button class="drawer-item" id="drawer-prayers">
        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"/></svg>
        <span class="drawer-item-label">Prayer Journal</span>
      </button>
      <button class="drawer-item" id="drawer-life-app">
        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 5.636l-3.536 3.536m0 5.656l3.536 3.536M9.172 9.172L5.636 5.636m3.536 9.192l-3.536 3.536M21 12a9 9 0 11-18 0 9 9 0 0118 0zm-5 0a4 4 0 11-8 0 4 4 0 018 0z"/></svg>
        <span class="drawer-item-label">Life Application</span>
        <span class="drawer-item-badge">L</span>
      </button>
    </div>

    <div class="drawer-divider"></div>

    <div class="drawer-section">
      <button class="drawer-item" id="drawer-shortcuts">
        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4"/></svg>
        <span class="drawer-item-label">Keyboard Shortcuts</span>
      </button>
    </div>
    <div class="drawer-divider"></div>
    <div class="drawer-section">
      <button class="drawer-item" id="drawer-account">
        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/></svg>
        <span class="drawer-item-label" id="drawer-account-label">Sign In</span>
      </button>
    </div>
  </nav>

  <div class="auth-backdrop" id="auth-backdrop"></div>
  <div class="auth-modal" id="auth-modal">
    <div id="auth-view-login">
      <h3 id="auth-modal-title">Sign In</h3>
      <div class="auth-form-group">
        <label for="auth-email">Email</label>
        <input type="email" id="auth-email" placeholder="you@example.com" autocomplete="email">
      </div>
      <div class="auth-form-group">
        <label for="auth-password">Password</label>
        <input type="password" id="auth-password" placeholder="Password" autocomplete="current-password">
      </div>
      <div class="auth-form-group" id="auth-confirm-group" style="display:none">
        <label for="auth-confirm">Confirm Password</label>
        <input type="password" id="auth-confirm" placeholder="Confirm password" autocomplete="new-password">
      </div>
      <button class="auth-submit" id="auth-submit">Sign In</button>
      <div class="auth-error" id="auth-error"></div>
      <div class="auth-toggle">
        <span id="auth-toggle-text">Don't have an account?</span>
        <a id="auth-toggle-link">Create Account</a>
      </div>
    </div>
    <div id="auth-view-profile" style="display:none">
      <h3>Account</h3>
      <div class="auth-profile">
        <div class="auth-profile-avatar" id="auth-profile-avatar"></div>
        <div class="auth-profile-email" id="auth-profile-email"></div>
        <div class="auth-profile-sync" id="auth-profile-sync">Synced</div>
      </div>
      <button class="auth-signout" id="auth-signout">Sign Out</button>
    </div>
    <div id="auth-view-migrate" style="display:none">
      <h3>Import Your Data?</h3>
      <div class="auth-migration">
        <p>We found highlights, notes, and other data saved on this device. Would you like to import it to your new account so it syncs across devices?</p>
        <div class="auth-migration-actions">
          <button class="import-btn" id="auth-import-btn">Import Data</button>
          <button class="skip-btn" id="auth-skip-btn">Start Fresh</button>
        </div>
      </div>
    </div>
  </div>

  <div class="usage-modal" id="usage-modal" role="dialog" aria-labelledby="usage-modal-title">
    <h3 id="usage-modal-title">API Usage</h3>
    <div class="usage-cost" id="usage-total-cost">$0.0000</div>
    <div class="usage-stat">
      <span class="usage-stat-label">Total Requests</span>
      <span class="usage-stat-value" id="usage-requests">0</span>
    </div>
    <div class="usage-stat">
      <span class="usage-stat-label">Input Tokens</span>
      <span class="usage-stat-value" id="usage-input">0</span>
    </div>
    <div class="usage-stat">
      <span class="usage-stat-label">Output Tokens</span>
      <span class="usage-stat-value" id="usage-output">0</span>
    </div>
    <div class="recent-requests" id="recent-requests">
      <div class="usage-stat"><span class="usage-stat-label">Recent Requests</span></div>
    </div>
    <button class="usage-reset" id="usage-reset">Reset Usage Stats</button>
  </div>

  <div class="history-modal" id="history-modal" role="dialog" aria-label="Interpretation history">
    <h3>History <button class="history-clear" id="history-clear">Clear All</button></h3>
    <div id="history-list"></div>
  </div>

  <div class="compare-modal-backdrop" id="compare-backdrop"></div>
  <div class="compare-modal" id="compare-modal" role="dialog" aria-label="Compare translations">
    <div class="compare-header">
      <h3 id="compare-title">Compare Translations</h3>
      <button class="close-panel" id="close-compare" aria-label="Close">&times;</button>
    </div>
    <div class="compare-body" id="compare-body"></div>
  </div>

  <div class="search-backdrop" id="search-backdrop"></div>
  <div class="search-modal" id="search-modal" role="dialog" aria-labelledby="search-title">
    <div class="search-input-wrapper">
      <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>
      <input type="text" class="search-input" id="search-input" placeholder="Jump to reference (e.g., John 3:16)" aria-label="Search for a Bible reference">
    </div>
    <div class="search-results" id="search-results"></div>
    <div class="search-hint">
      Press <kbd>Enter</kbd> to go, <kbd>Esc</kbd> to close
    </div>
  </div>

  <div class="life-app-backdrop" id="life-app-backdrop"></div>
  <div class="life-app-modal" id="life-app-modal" role="dialog" aria-label="Life Application">
    <div class="life-app-header">
      <h3>What's going on in your life?</h3>
      <button class="close-panel" id="close-life-app" aria-label="Close">&times;</button>
    </div>
    <div id="life-app-input-view">
      <div class="life-app-categories" id="life-app-categories"></div>
      <textarea id="life-app-textarea" class="life-app-textarea" placeholder="Tell me what you're going through..." rows="4" maxlength="500"></textarea>
      <div class="life-app-input-footer">
        <span class="life-app-char-count" id="life-app-char-count">0/500</span>
        <button class="life-app-submit" id="life-app-submit" disabled>Find Passages</button>
      </div>
    </div>
    <div class="life-app-loading hidden" id="life-app-loading">
      <div class="spinner"></div>
      <p>Searching Scripture for your situation...</p>
    </div>
    <div class="life-app-results hidden" id="life-app-results">
      <div class="life-app-situation" id="life-app-situation"></div>
      <div class="life-app-cards" id="life-app-cards"></div>
      <button class="life-app-back" id="life-app-back">
        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width:16px;height:16px"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/></svg>
        Ask another question
      </button>
    </div>
  </div>

  <div class="topical-backdrop" id="topical-backdrop"></div>
  <div class="topical-modal" id="topical-modal" role="dialog" aria-label="Topical Browse">
    <div class="topical-header">
      <h3>Browse by Topic</h3>
      <button class="close-panel" id="close-topical" aria-label="Close">&times;</button>
    </div>
    <div id="topical-input-view">
      <div class="topical-topics" id="topical-topics"></div>
      <div class="topical-custom">
        <input type="text" id="topical-custom-input" placeholder="Or type a custom topic..." maxlength="100">
        <button id="topical-custom-btn" disabled>Search</button>
      </div>
    </div>
    <div class="life-app-loading hidden" id="topical-loading">
      <div class="spinner"></div>
      <p>Finding passages about this topic...</p>
    </div>
    <div class="topical-results hidden" id="topical-results">
      <button class="topical-back" id="topical-back">
        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width:14px;height:14px"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/></svg>
        Browse more topics
      </button>
      <div class="topical-description" id="topical-description"></div>
      <div id="topical-cards"></div>
    </div>
  </div>

  <div class="plans-backdrop" id="plans-backdrop"></div>
  <div class="plans-modal" id="plans-modal" role="dialog" aria-label="Reading Plans">
    <div class="plans-header">
      <h3 id="plans-title">Reading Plans</h3>
      <button class="close-panel" id="close-plans" aria-label="Close">&times;</button>
    </div>
    <div class="plans-body" id="plans-browse"></div>
    <div class="plans-body hidden" id="plans-detail"></div>
  </div>

  <div class="prayer-journal-backdrop" id="prayer-journal-backdrop"></div>
  <div class="prayer-journal-modal" id="prayer-journal-modal" role="dialog" aria-label="Prayer Journal">
    <div class="prayer-journal-header">
      <h3>Prayer Journal</h3>
      <button class="close-panel" id="close-prayer-journal" aria-label="Close">&times;</button>
    </div>
    <div class="prayer-journal-filters">
      <button class="prayer-filter-btn active" data-filter="all">All</button>
      <button class="prayer-filter-btn" data-filter="active">Active</button>
      <button class="prayer-filter-btn" data-filter="answered">Answered</button>
    </div>
    <div class="prayer-journal-list" id="prayer-journal-list"></div>
  </div>

  <main class="main-container" role="main">
    <div class="bible-panel" id="bible-panel" aria-label="Bible text">
      <div class="bible-content-wrapper">
        <div class="bible-content">
          <div class="instructions" id="instructions">
            <p>Select a book and chapter above to start reading.</p>
            <p>Click on verses to select them, then interpret.</p>
            <p style="margin-top: var(--space-4); font-size: var(--text-sm);">
              Press <kbd style="background: var(--neutral-200); padding: 2px 6px; border-radius: 4px; font-family: var(--font-mono);">/</kbd> to search
            </p>
          </div>
          <h2 class="chapter-header" id="chapter-header" style="display:none;"></h2>
          <div class="verses-container" id="verses-container" role="list" aria-label="Bible verses"></div>
        </div>
        <div class="context-sidebar" id="context-sidebar" style="display:none">
          <div class="context-card" id="context-card">
            <h4>Book Context</h4>
            <div id="context-rows"></div>
          </div>
          <div class="toc-card" id="toc-card">
            <h4>Chapter Outline</h4>
            <div id="toc-list"></div>
          </div>
          <div class="notes-card" id="notes-card">
            <h4>My Notes</h4>
            <div class="notes-tabs">
              <button class="notes-tab active" id="notes-tab-chapter">This Chapter</button>
              <button class="notes-tab" id="notes-tab-all">All Notes</button>
              <button class="notes-tab" id="notes-tab-prayers">Prayers</button>
            </div>
            <div id="notes-list"></div>
          </div>
        </div>
      </div>
    </div>

    <aside class="interpretation-panel hidden" id="interpretation-panel" aria-label="Interpretation results" aria-live="polite">
      <div class="panel-header">
        <h2>Interpretation</h2>
        <button class="close-panel" id="close-panel" aria-label="Close panel">&times;</button>
      </div>
      <div class="panel-content" id="panel-content">
        <div class="loading-state hidden" id="panel-loading">
          <div class="spinner"></div>
          <p>Analyzing Greek and Hebrew roots...</p>
        </div>
        <div id="interpretation-content">
          <div class="selected-text" id="selected-text"></div>
          <div class="section-title" id="words-toggle">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
            Key Words
          </div>
          <div class="section-content" id="words-section">
            <div class="word-list" id="word-list"></div>
          </div>
          <div class="section-title" id="interpretation-toggle">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
            Interpretation
          </div>
          <div class="section-content" id="interpretation-section">
            <div class="interpretation-text" id="interpretation-text"></div>
          </div>
          <div class="crossref-section" id="crossref-section" style="display:none;">
            <div class="section-title" id="crossref-toggle">
              <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
              Related Passages
            </div>
            <div class="section-content" id="crossref-content"></div>
          </div>
        </div>
      </div>
      <div class="panel-actions">
        <button class="action-btn" id="copy-btn" title="Copy to clipboard">
          <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/></svg>
          <span>Copy</span>
        </button>
        <button class="action-btn compare-btn" id="compare-btn" title="Compare translations">
          <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17V7m0 10a2 2 0 01-2 2H5a2 2 0 01-2-2V7a2 2 0 012-2h2a2 2 0 012 2m0 10a2 2 0 002 2h2a2 2 0 002-2M9 7a2 2 0 012-2h2a2 2 0 012 2m0 10V7m0 10a2 2 0 002 2h2a2 2 0 002-2V7a2 2 0 00-2-2h-2a2 2 0 00-2 2"/></svg>
          <span>Compare</span>
        </button>
        <button class="action-btn" id="share-btn" title="Share">
          <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z"/></svg>
          <span>Share</span>
        </button>
      </div>
    </aside>
  </main>

  <div class="highlight-palette" id="highlight-palette">
    <span class="hl-dot" data-color="yellow" title="Yellow"></span>
    <span class="hl-dot" data-color="green" title="Green"></span>
    <span class="hl-dot" data-color="blue" title="Blue"></span>
    <span class="hl-dot" data-color="pink" title="Pink"></span>
    <span class="hl-dot" data-color="clear" title="Clear">&#10005;</span>
    <span class="hl-card-btn" id="create-card-btn" title="Create Verse Card">
      <svg viewBox="0 0 24 24" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2"/><line x1="9" y1="3" x2="9" y2="21"/></svg>
    </span>
  </div>
  <div class="card-backdrop" id="card-backdrop"></div>
  <div class="card-modal" id="card-modal">
    <div class="card-modal-header">
      <h3>Create Verse Card</h3>
      <button class="close-panel" id="close-card">&times;</button>
    </div>
    <div class="card-modal-body" id="card-modal-body">
      <div class="card-canvas-wrap"><canvas id="card-canvas" width="1080" height="1080"></canvas></div>
      <div class="card-size-toggle">
        <button class="card-size-btn active" data-size="square">Square</button>
        <button class="card-size-btn" data-size="landscape">Landscape</button>
      </div>
      <div class="card-themes" id="card-themes"></div>
      <div class="card-actions">
        <button class="card-download-btn" id="card-download">Download PNG</button>
        <button id="card-copy">Copy to Clipboard</button>
      </div>
    </div>
  </div>
  <button class="interpret-fab" id="interpret-fab" aria-describedby="fab-description">Interpret Selection</button>
  <span id="fab-description" class="sr-only">Analyze selected verses with Greek and Hebrew insights</span>

  <div class="toast" id="toast"></div>

  <div class="shortcuts-help">
    <kbd>`</kbd> Menu &nbsp; <kbd>/</kbd> Search &nbsp; <kbd>T</kbd> Topics &nbsp; <kbd>L</kbd> Life App &nbsp; <kbd>D</kbd> Dark mode &nbsp; <kbd>Esc</kbd> Close
  </div>

  <style>.sr-only { position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0,0,0,0); white-space: nowrap; border: 0; }</style>

  <script>
    // ===== Book Data =====
    const BOOKS = [
      { name: 'Genesis', chapters: 50 }, { name: 'Exodus', chapters: 40 },
      { name: 'Leviticus', chapters: 27 }, { name: 'Numbers', chapters: 36 },
      { name: 'Deuteronomy', chapters: 34 }, { name: 'Joshua', chapters: 24 },
      { name: 'Judges', chapters: 21 }, { name: 'Ruth', chapters: 4 },
      { name: '1 Samuel', chapters: 31 }, { name: '2 Samuel', chapters: 24 },
      { name: '1 Kings', chapters: 22 }, { name: '2 Kings', chapters: 25 },
      { name: '1 Chronicles', chapters: 29 }, { name: '2 Chronicles', chapters: 36 },
      { name: 'Ezra', chapters: 10 }, { name: 'Nehemiah', chapters: 13 },
      { name: 'Esther', chapters: 10 }, { name: 'Job', chapters: 42 },
      { name: 'Psalms', chapters: 150 }, { name: 'Proverbs', chapters: 31 },
      { name: 'Ecclesiastes', chapters: 12 }, { name: 'Song of Solomon', chapters: 8 },
      { name: 'Isaiah', chapters: 66 }, { name: 'Jeremiah', chapters: 52 },
      { name: 'Lamentations', chapters: 5 }, { name: 'Ezekiel', chapters: 48 },
      { name: 'Daniel', chapters: 12 }, { name: 'Hosea', chapters: 14 },
      { name: 'Joel', chapters: 3 }, { name: 'Amos', chapters: 9 },
      { name: 'Obadiah', chapters: 1 }, { name: 'Jonah', chapters: 4 },
      { name: 'Micah', chapters: 7 }, { name: 'Nahum', chapters: 3 },
      { name: 'Habakkuk', chapters: 3 }, { name: 'Zephaniah', chapters: 3 },
      { name: 'Haggai', chapters: 2 }, { name: 'Zechariah', chapters: 14 },
      { name: 'Malachi', chapters: 4 },
      { name: 'Matthew', chapters: 28 }, { name: 'Mark', chapters: 16 },
      { name: 'Luke', chapters: 24 }, { name: 'John', chapters: 21 },
      { name: 'Acts', chapters: 28 }, { name: 'Romans', chapters: 16 },
      { name: '1 Corinthians', chapters: 16 }, { name: '2 Corinthians', chapters: 13 },
      { name: 'Galatians', chapters: 6 }, { name: 'Ephesians', chapters: 6 },
      { name: 'Philippians', chapters: 4 }, { name: 'Colossians', chapters: 4 },
      { name: '1 Thessalonians', chapters: 5 }, { name: '2 Thessalonians', chapters: 3 },
      { name: '1 Timothy', chapters: 6 }, { name: '2 Timothy', chapters: 4 },
      { name: 'Titus', chapters: 3 }, { name: 'Philemon', chapters: 1 },
      { name: 'Hebrews', chapters: 13 }, { name: 'James', chapters: 5 },
      { name: '1 Peter', chapters: 5 }, { name: '2 Peter', chapters: 3 },
      { name: '1 John', chapters: 5 }, { name: '2 John', chapters: 1 },
      { name: '3 John', chapters: 1 }, { name: 'Jude', chapters: 1 },
      { name: 'Revelation', chapters: 22 }
    ];

    // Book aliases for search
    const BOOK_ALIASES = {
      'gen': 0, 'ex': 1, 'lev': 2, 'num': 3, 'deut': 4, 'josh': 5, 'judg': 6, 'ru': 7,
      '1sam': 8, '2sam': 9, '1ki': 10, '2ki': 11, '1chr': 12, '2chr': 13,
      'ezr': 14, 'neh': 15, 'est': 16, 'ps': 18, 'psa': 18, 'prov': 19, 'eccl': 20,
      'song': 21, 'isa': 22, 'jer': 23, 'lam': 24, 'ezek': 25, 'dan': 26,
      'hos': 27, 'am': 29, 'ob': 30, 'jon': 31, 'mic': 32, 'nah': 33, 'hab': 34,
      'zeph': 35, 'hag': 36, 'zech': 37, 'mal': 38,
      'matt': 39, 'mt': 39, 'mk': 40, 'lk': 41, 'jn': 42, 'jhn': 42,
      'rom': 45, '1cor': 46, '2cor': 47, 'gal': 48, 'eph': 49, 'phil': 50, 'php': 50,
      'col': 51, '1thess': 52, '2thess': 53, '1tim': 54, '2tim': 55, 'tit': 56,
      'phlm': 57, 'heb': 58, 'jas': 59, '1pet': 60, '2pet': 61,
      '1jn': 62, '2jn': 63, '3jn': 64, 'rev': 65
    };

    // ===== DOM Elements =====
    const bookSelect = document.getElementById('book-select');
    const chapterSelect = document.getElementById('chapter-select');
    const loadChapterBtn = document.getElementById('load-chapter');
    const prevChapterBtn = document.getElementById('prev-chapter');
    const nextChapterBtn = document.getElementById('next-chapter');
    const versesContainer = document.getElementById('verses-container');
    const chapterHeader = document.getElementById('chapter-header');
    const instructions = document.getElementById('instructions');
    const interpretPanel = document.getElementById('interpretation-panel');
    const closePanel = document.getElementById('close-panel');
    const panelLoading = document.getElementById('panel-loading');
    const interpretationContent = document.getElementById('interpretation-content');
    const selectedTextEl = document.getElementById('selected-text');
    const wordList = document.getElementById('word-list');
    const interpretationText = document.getElementById('interpretation-text');
    const interpretFab = document.getElementById('interpret-fab');
    const themeToggle = document.getElementById('theme-toggle');
    const searchModal = document.getElementById('search-modal');
    const searchBackdrop = document.getElementById('search-backdrop');
    const searchInput = document.getElementById('search-input');
    const searchResults = document.getElementById('search-results');
    const toast = document.getElementById('toast');
    const versionSelect = document.getElementById('version-select');

	    // ===== State =====
	    let selectedVerses = new Set();
	    let currentBook = '';
	    let currentChapter = 0;
	    let currentBookIndex = 0;

	    function getSelectedRange() {
	      const sortedVerses = [...selectedVerses].sort((a, b) => a - b);
	      return {
	        sortedVerses,
	        startVerse: sortedVerses[0],
	        endVerse: sortedVerses[sortedVerses.length - 1],
	      };
	    }

	    async function getResponseError(response, fallback) {
	      try {
	        const data = await response.json();
	        if (data && data.error) return data.error;
	      } catch (e) {
	        // ignore
	      }
	      return fallback;
	    }

    // ===== DataStore  Central data abstraction layer =====
    const DataStore = {
      _cache: {
        highlights: {},
        notes: {},
        prayers: [],
        plansProgress: {},
        activePlan: '',
        streak: { current: 0, lastRead: '', longest: 0 },
        interpHistory: [],
        lifeAppHistory: [],
        theme: 'light',
        version: 'ESV'
      },
      _supabase: null,
      _user: null,
      _syncQueue: [],
      _syncTimer: null,
      _lastSynced: null,
      _isSignUp: false,

      _LS_MAP: {
        highlights: 'bible-highlights',
        notes: 'bible-notes',
        prayers: 'bible-prayers',
        plansProgress: 'bible-reading-plans',
        activePlan: 'bible-active-plan',
        streak: 'bible-reading-streak',
        interpHistory: 'bible-interp-history',
        lifeAppHistory: 'bible-life-app-history',
        theme: 'bible-theme',
        version: 'bible-version'
      },

      async init() {
        this._loadFromLocalStorage();
        // Fetch Supabase config
        try {
          const res = await fetch('/api/config');
          const cfg = await res.json();
          if (cfg.supabaseUrl && cfg.supabaseAnonKey && typeof supabase !== 'undefined') {
            this._supabase = supabase.createClient(cfg.supabaseUrl, cfg.supabaseAnonKey);
            this._supabase.auth.onAuthStateChange((event, session) => {
              this._onAuthChange(event, session);
            });
            // Check existing session
            const { data } = await this._supabase.auth.getSession();
            if (data.session) {
              this._user = data.session.user;
              this._updateAuthUI();
              await this._loadFromSupabase();
            }
          }
        } catch (e) {
          console.log('Supabase not configured, using localStorage only');
        }
      },

      _loadFromLocalStorage() {
        const parse = (key, fallback) => {
          try {
            const v = localStorage.getItem(key);
            return v ? JSON.parse(v) : fallback;
          } catch { return fallback; }
        };
        this._cache.highlights = parse('bible-highlights', {});
        this._cache.notes = parse('bible-notes', {});
        this._cache.prayers = parse('bible-prayers', []);
        this._cache.plansProgress = parse('bible-reading-plans', {});
        this._cache.activePlan = localStorage.getItem('bible-active-plan') || '';
        this._cache.streak = parse('bible-reading-streak', { current: 0, lastRead: '', longest: 0 });
        this._cache.interpHistory = parse('bible-interp-history', []);
        this._cache.lifeAppHistory = parse('bible-life-app-history', []);
        this._cache.theme = localStorage.getItem('bible-theme') || 'light';
        this._cache.version = localStorage.getItem('bible-version') || 'ESV';
      },

      async _loadFromSupabase() {
        if (!this._supabase || !this._user) return;
        const uid = this._user.id;
        try {
          // Load all data in parallel
          const [hlRes, notesRes, prayersRes, progressRes, histRes, prefRes] = await Promise.all([
            this._supabase.from('user_highlights').select('verse_key, color').eq('user_id', uid),
            this._supabase.from('user_notes').select('verse_key, text').eq('user_id', uid),
            this._supabase.from('user_prayers').select('*').eq('user_id', uid).order('date', { ascending: false }),
            this._supabase.from('user_reading_progress').select('*').eq('user_id', uid).single(),
            this._supabase.from('user_history').select('*').eq('user_id', uid).order('timestamp', { ascending: false }),
            this._supabase.from('user_preferences').select('*').eq('user_id', uid).single()
          ]);

          // Highlights
          if (hlRes.data && hlRes.data.length > 0) {
            const hl = {};
            hlRes.data.forEach(r => { hl[r.verse_key] = r.color; });
            this._cache.highlights = hl;
            localStorage.setItem('bible-highlights', JSON.stringify(hl));
          }

          // Notes
          if (notesRes.data && notesRes.data.length > 0) {
            const notes = {};
            notesRes.data.forEach(r => { notes[r.verse_key] = r.text; });
            this._cache.notes = notes;
            localStorage.setItem('bible-notes', JSON.stringify(notes));
          }

          // Prayers
          if (prayersRes.data && prayersRes.data.length > 0) {
            const prayers = prayersRes.data.map(r => ({
              id: r.prayer_id, text: r.text, bookIndex: r.book_index,
              chapter: r.chapter, verse: r.verse, reference: r.reference,
              date: r.date, answered: r.answered
            }));
            this._cache.prayers = prayers;
            localStorage.setItem('bible-prayers', JSON.stringify(prayers));
          }

          // Reading progress
          if (progressRes.data) {
            this._cache.plansProgress = progressRes.data.plans_progress || {};
            this._cache.activePlan = progressRes.data.active_plan || '';
            this._cache.streak = progressRes.data.streak || { current: 0, lastRead: '', longest: 0 };
            localStorage.setItem('bible-reading-plans', JSON.stringify(this._cache.plansProgress));
            localStorage.setItem('bible-active-plan', this._cache.activePlan);
            localStorage.setItem('bible-reading-streak', JSON.stringify(this._cache.streak));
          }

          // History
          if (histRes.data && histRes.data.length > 0) {
            const interp = histRes.data.filter(h => h.history_type === 'interpretation')
              .map(h => ({ reference: h.reference, data: h.data, timestamp: h.timestamp }));
            const lifeApp = histRes.data.filter(h => h.history_type === 'life_app')
              .map(h => ({ situation: h.situation, data: h.data, timestamp: h.timestamp }));
            if (interp.length > 0) {
              this._cache.interpHistory = interp;
              localStorage.setItem('bible-interp-history', JSON.stringify(interp));
            }
            if (lifeApp.length > 0) {
              this._cache.lifeAppHistory = lifeApp;
              localStorage.setItem('bible-life-app-history', JSON.stringify(lifeApp));
            }
          }

          // Preferences
          if (prefRes.data) {
            if (prefRes.data.theme) {
              this._cache.theme = prefRes.data.theme;
              localStorage.setItem('bible-theme', prefRes.data.theme);
              const isDark = prefRes.data.theme === 'dark';
              document.documentElement.classList.toggle('dark', isDark);
            }
            if (prefRes.data.bible_version) {
              this._cache.version = prefRes.data.bible_version;
              localStorage.setItem('bible-version', prefRes.data.bible_version);
              if (versionSelect.querySelector(`option[value="${prefRes.data.bible_version}"]`)) {
                versionSelect.value = prefRes.data.bible_version;
              }
            }
          }

          this._lastSynced = new Date();
          this._updateSyncDot('green');
          // Refresh UI if chapter is loaded
          if (typeof applyHighlights === 'function' && typeof currentBook !== 'undefined' && currentBook) {
            applyHighlights();
            refreshNoteIndicators();
            if (typeof updateSidebar === 'function') updateSidebar();
          }
          if (typeof updateHistoryBadge === 'function') updateHistoryBadge();
        } catch (e) {
          console.error('Failed to load from Supabase:', e);
          this._updateSyncDot('red');
        }
      },

      _save(key, value) {
        this._cache[key] = value;
        const lsKey = this._LS_MAP[key];
        if (lsKey) {
          const val = typeof value === 'string' ? value : JSON.stringify(value);
          localStorage.setItem(lsKey, val);
        }
        if (this._user) {
          this._queueSync({ key, value, timestamp: Date.now() });
        }
      },

      _queueSync(operation) {
        this._syncQueue = this._syncQueue.filter(op => op.key !== operation.key);
        this._syncQueue.push(operation);
        this._updateSyncDot('yellow');
        clearTimeout(this._syncTimer);
        this._syncTimer = setTimeout(() => this._flushSync(), 1000);
      },

      async _flushSync() {
        if (!this._user || !this._supabase || this._syncQueue.length === 0) return;
        const queue = [...this._syncQueue];
        this._syncQueue = [];
        for (const op of queue) {
          try {
            await this._syncToSupabase(op.key, op.value);
          } catch (err) {
            console.error('Sync failed for', op.key, err);
            if (!op.retries || op.retries < 3) {
              op.retries = (op.retries || 0) + 1;
              this._syncQueue.push(op);
            }
          }
        }
        if (this._syncQueue.length > 0) {
          this._syncTimer = setTimeout(() => this._flushSync(), 5000);
        } else {
          this._lastSynced = new Date();
          this._updateSyncDot('green');
          const syncEl = document.getElementById('auth-profile-sync');
          if (syncEl) syncEl.textContent = 'Synced just now';
        }
      },

      async _syncToSupabase(key, value) {
        const uid = this._user.id;
        switch (key) {
          case 'highlights': {
            await this._supabase.from('user_highlights').delete().eq('user_id', uid);
            const rows = Object.entries(value).map(([k, v]) => ({
              user_id: uid, verse_key: k, color: v
            }));
            if (rows.length > 0) await this._supabase.from('user_highlights').insert(rows);
            break;
          }
          case 'notes': {
            await this._supabase.from('user_notes').delete().eq('user_id', uid);
            const rows = Object.entries(value).map(([k, v]) => ({
              user_id: uid, verse_key: k, text: v
            }));
            if (rows.length > 0) await this._supabase.from('user_notes').insert(rows);
            break;
          }
          case 'prayers': {
            await this._supabase.from('user_prayers').delete().eq('user_id', uid);
            const rows = value.map(p => ({
              user_id: uid, prayer_id: p.id, text: p.text,
              book_index: p.bookIndex, chapter: p.chapter, verse: p.verse,
              reference: p.reference, date: p.date, answered: p.answered
            }));
            if (rows.length > 0) await this._supabase.from('user_prayers').insert(rows);
            break;
          }
          case 'plansProgress':
          case 'activePlan':
          case 'streak': {
            await this._supabase.from('user_reading_progress').upsert({
              user_id: uid,
              active_plan: this._cache.activePlan,
              plans_progress: this._cache.plansProgress,
              streak: this._cache.streak,
              updated_at: new Date().toISOString()
            }, { onConflict: 'user_id' });
            break;
          }
          case 'interpHistory': {
            await this._supabase.from('user_history').delete().eq('user_id', uid).eq('history_type', 'interpretation');
            const rows = value.map(h => ({
              user_id: uid, history_type: 'interpretation',
              reference: h.reference, data: h.data, timestamp: h.timestamp
            }));
            if (rows.length > 0) await this._supabase.from('user_history').insert(rows);
            break;
          }
          case 'lifeAppHistory': {
            await this._supabase.from('user_history').delete().eq('user_id', uid).eq('history_type', 'life_app');
            const rows = value.map(h => ({
              user_id: uid, history_type: 'life_app',
              situation: h.situation, data: h.data, timestamp: h.timestamp
            }));
            if (rows.length > 0) await this._supabase.from('user_history').insert(rows);
            break;
          }
          case 'theme':
          case 'version': {
            await this._supabase.from('user_preferences').upsert({
              user_id: uid,
              theme: this._cache.theme,
              bible_version: this._cache.version,
              updated_at: new Date().toISOString()
            }, { onConflict: 'user_id' });
            break;
          }
        }
      },

      async _onAuthChange(event, session) {
        if (event === 'SIGNED_IN' && session) {
          this._user = session.user;
          this._updateAuthUI();
          if (this._isSignUp) {
            this._isSignUp = false;
            if (this._hasExistingLocalData()) {
              this._showMigrationPrompt();
            } else {
              await this._loadFromSupabase();
              showToast('Account created! Your data will sync across devices.');
            }
          } else {
            await this._loadFromSupabase();
            showToast('Signed in! Data synced.');
          }
        } else if (event === 'SIGNED_OUT') {
          this._user = null;
          this._syncQueue = [];
          clearTimeout(this._syncTimer);
          this._updateAuthUI();
          this._loadFromLocalStorage();
        }
      },

      _hasExistingLocalData() {
        const keys = ['bible-highlights', 'bible-notes', 'bible-prayers',
          'bible-reading-plans', 'bible-interp-history', 'bible-life-app-history'];
        return keys.some(k => {
          const v = localStorage.getItem(k);
          return v && v !== '{}' && v !== '[]' && v !== '""';
        });
      },

      _showMigrationPrompt() {
        document.getElementById('auth-view-login').style.display = 'none';
        document.getElementById('auth-view-profile').style.display = 'none';
        document.getElementById('auth-view-migrate').style.display = '';
      },

      async importLocalData() {
        this._updateSyncDot('yellow');
        const keys = ['highlights', 'notes', 'prayers', 'plansProgress', 'activePlan',
          'streak', 'interpHistory', 'lifeAppHistory', 'theme', 'version'];
        for (const key of keys) {
          try {
            await this._syncToSupabase(key, this._cache[key]);
          } catch (e) {
            console.error('Import failed for', key, e);
          }
        }
        this._lastSynced = new Date();
        this._updateSyncDot('green');
        this._closeAuthModal();
        showToast('Data imported successfully!');
      },

      async skipImport() {
        // Load fresh from Supabase (will be empty for new user)
        await this._loadFromSupabase();
        this._closeAuthModal();
        showToast('Starting with a clean slate');
      },

      _updateAuthUI() {
        const loggedOut = document.getElementById('auth-icon-loggedout');
        const loggedIn = document.getElementById('auth-icon-loggedin');
        const syncDot = document.getElementById('sync-dot');
        const drawerLabel = document.getElementById('drawer-account-label');

        if (this._user) {
          const initial = (this._user.email || '?')[0];
          loggedOut.style.display = 'none';
          loggedIn.style.display = 'flex';
          loggedIn.textContent = initial;
          syncDot.style.display = '';
          this._updateSyncDot('green');
          drawerLabel.textContent = this._user.email || 'Account';
        } else {
          loggedOut.style.display = '';
          loggedIn.style.display = 'none';
          syncDot.style.display = 'none';
          drawerLabel.textContent = 'Sign In';
        }
      },

      _updateSyncDot(color) {
        const dot = document.getElementById('sync-dot');
        if (!dot) return;
        dot.className = 'sync-dot ' + color;
      },

      _openAuthModal() {
        const modal = document.getElementById('auth-modal');
        const backdrop = document.getElementById('auth-backdrop');
        if (this._user) {
          document.getElementById('auth-view-login').style.display = 'none';
          document.getElementById('auth-view-migrate').style.display = 'none';
          document.getElementById('auth-view-profile').style.display = '';
          const avatar = document.getElementById('auth-profile-avatar');
          avatar.textContent = (this._user.email || '?')[0];
          document.getElementById('auth-profile-email').textContent = this._user.email;
          const syncText = this._lastSynced
            ? 'Last synced: ' + this._lastSynced.toLocaleTimeString()
            : 'Synced';
          document.getElementById('auth-profile-sync').textContent = syncText;
        } else {
          document.getElementById('auth-view-login').style.display = '';
          document.getElementById('auth-view-profile').style.display = 'none';
          document.getElementById('auth-view-migrate').style.display = 'none';
          this._setAuthMode('signin');
        }
        modal.classList.add('open');
        backdrop.classList.add('open');
      },

      _closeAuthModal() {
        document.getElementById('auth-modal').classList.remove('open');
        document.getElementById('auth-backdrop').classList.remove('open');
        document.getElementById('auth-error').textContent = '';
      },

      _setAuthMode(mode) {
        const title = document.getElementById('auth-modal-title');
        const submit = document.getElementById('auth-submit');
        const toggleText = document.getElementById('auth-toggle-text');
        const toggleLink = document.getElementById('auth-toggle-link');
        const confirmGroup = document.getElementById('auth-confirm-group');
        if (mode === 'signup') {
          title.textContent = 'Create Account';
          submit.textContent = 'Create Account';
          toggleText.textContent = 'Already have an account?';
          toggleLink.textContent = 'Sign In';
          confirmGroup.style.display = '';
          submit.dataset.mode = 'signup';
        } else {
          title.textContent = 'Sign In';
          submit.textContent = 'Sign In';
          toggleText.textContent = "Don't have an account?";
          toggleLink.textContent = 'Create Account';
          confirmGroup.style.display = 'none';
          submit.dataset.mode = 'signin';
        }
        document.getElementById('auth-error').textContent = '';
      },

      async signIn(email, password) {
        if (!this._supabase) { showToast('Account system not available'); return; }
        const { error } = await this._supabase.auth.signInWithPassword({ email, password });
        if (error) throw error;
      },

      async signUp(email, password) {
        if (!this._supabase) { showToast('Account system not available'); return; }
        this._isSignUp = true;
        const { error } = await this._supabase.auth.signUp({ email, password });
        if (error) { this._isSignUp = false; throw error; }
      },

      async signOut() {
        if (!this._supabase) return;
        await this._supabase.auth.signOut();
      },

      // === Public API ===
      getHighlights() { return this._cache.highlights; },
      saveHighlights(hl) { this._save('highlights', hl); },
      getNotes() { return this._cache.notes; },
      saveNotes(notes) { this._save('notes', notes); },
      getPrayers() { return this._cache.prayers; },
      savePrayers(prayers) { this._save('prayers', prayers); },
      getPlansProgress() { return this._cache.plansProgress; },
      savePlansProgress(p) { this._save('plansProgress', p); },
      getActivePlan() { return this._cache.activePlan; },
      setActivePlan(id) { this._save('activePlan', id); },
      getStreak() { return this._cache.streak; },
      saveStreak(s) { this._save('streak', s); },
      getHistory() { return this._cache.interpHistory; },
      saveHistory(history) { this._save('interpHistory', history); },
      getLifeAppHistory() { return this._cache.lifeAppHistory; },
      saveLifeAppHistoryArr(history) { this._save('lifeAppHistory', history); },
      getTheme() { return this._cache.theme; },
      setTheme(t) { this._save('theme', t); },
      getVersion() { return this._cache.version; },
      setVersion(v) { this._save('version', v); },
      isLoggedIn() { return !!this._user; },
      getUser() { return this._user; }
    };

    // Initialize DataStore (async, non-blocking)
    DataStore.init();

    // Online/offline sync recovery
    window.addEventListener('online', () => {
      if (DataStore._user && DataStore._syncQueue.length > 0) {
        DataStore._flushSync();
      }
    });

	    // ===== Theme =====
	    function initTheme() {
	      const stored = DataStore.getTheme();
      const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
      if (stored === 'dark' || (!stored && prefersDark)) {
        document.documentElement.classList.add('dark');
      }
    }

    function toggleDarkMode() {
      const isDark = document.documentElement.classList.toggle('dark');
      DataStore.setTheme(isDark ? 'dark' : 'light');
      showToast(isDark ? 'Dark mode enabled' : 'Light mode enabled');
    }

    themeToggle.addEventListener('click', toggleDarkMode);
    initTheme();

    // ===== Version Selection =====
    function initVersion() {
      const stored = DataStore.getVersion();
      if (stored && versionSelect.querySelector(`option[value="${stored}"]`)) {
        versionSelect.value = stored;
      }
    }

    versionSelect.addEventListener('change', () => {
      DataStore.setVersion(versionSelect.value);
      showToast(`Switched to ${versionSelect.options[versionSelect.selectedIndex].text}`);
      // Reload current chapter if one is loaded
      if (currentBook) {
        loadChapter();
      }
    });

    initVersion();

    // ===== Book/Chapter Navigation =====
    BOOKS.forEach((book, index) => {
      const option = document.createElement('option');
      option.value = index;
      option.textContent = book.name;
      bookSelect.appendChild(option);
    });

    bookSelect.addEventListener('change', () => {
      const bookIndex = parseInt(bookSelect.value);
      const book = BOOKS[bookIndex];
      chapterSelect.textContent = '';
      for (let i = 1; i <= book.chapters; i++) {
        const option = document.createElement('option');
        option.value = i;
        option.textContent = i;
        chapterSelect.appendChild(option);
      }
      updateNavButtons();
    });

    function updateNavButtons() {
      const bookIndex = parseInt(bookSelect.value);
      const chapter = parseInt(chapterSelect.value);
      prevChapterBtn.disabled = (bookIndex === 0 && chapter === 1);
      nextChapterBtn.disabled = (bookIndex === BOOKS.length - 1 && chapter === BOOKS[bookIndex].chapters);
    }

    chapterSelect.addEventListener('change', updateNavButtons);

    prevChapterBtn.addEventListener('click', () => {
      let bookIndex = parseInt(bookSelect.value);
      let chapter = parseInt(chapterSelect.value);
      if (chapter > 1) {
        chapterSelect.value = chapter - 1;
      } else if (bookIndex > 0) {
        bookIndex--;
        bookSelect.value = bookIndex;
        bookSelect.dispatchEvent(new Event('change'));
        chapterSelect.value = BOOKS[bookIndex].chapters;
      }
      loadChapter();
    });

    nextChapterBtn.addEventListener('click', () => {
      let bookIndex = parseInt(bookSelect.value);
      let chapter = parseInt(chapterSelect.value);
      if (chapter < BOOKS[bookIndex].chapters) {
        chapterSelect.value = chapter + 1;
      } else if (bookIndex < BOOKS.length - 1) {
        bookIndex++;
        bookSelect.value = bookIndex;
        bookSelect.dispatchEvent(new Event('change'));
        chapterSelect.value = 1;
      }
      loadChapter();
    });

    // Initialize with John 3
    bookSelect.value = 42;
    bookSelect.dispatchEvent(new Event('change'));
    chapterSelect.value = 3;
    updateNavButtons();

    loadChapterBtn.addEventListener('click', loadChapter);

	    async function loadChapter() {
	      const bookIndex = parseInt(bookSelect.value);
	      const book = BOOKS[bookIndex];
	      const chapter = parseInt(chapterSelect.value);

      currentBook = book.name;
      currentChapter = chapter;
      currentBookIndex = bookIndex;

      instructions.style.display = 'none';
      chapterHeader.style.display = 'block';
      chapterHeader.textContent = book.name + ' ' + chapter;
      if (typeof showLoadingSkeleton === 'function') showLoadingSkeleton(); else versesContainer.textContent = 'Loading...';

      updateNavButtons();

	      try {
	        const translation = versionSelect.value;
	        const response = await fetch('/api/chapter', {
	          method: 'POST',
	          headers: { 'Content-Type': 'application/json' },
	          body: JSON.stringify({ book: book.name, chapter, translation })
	        });

	        if (!response.ok) {
	          throw new Error(await getResponseError(response, 'Failed to load chapter'));
	        }

	        const data = await response.json();
	        displayVerses(data.verses);
	        if (typeof applyHighlights === 'function') applyHighlights();
	        if (typeof refreshNoteIndicators === 'function') refreshNoteIndicators();
	        if (typeof updateSidebar === 'function') updateSidebar();
	      } catch (err) {
	        versesContainer.textContent = 'Error loading chapter: ' + err.message;
      }
    }

    function displayVerses(verses) {
      versesContainer.textContent = '';
      selectedVerses.clear();
      updateFab();

      verses.forEach((v, i) => {
        const verseSpan = document.createElement('span');
        verseSpan.className = 'verse';
        verseSpan.dataset.verse = v.verse;
        verseSpan.setAttribute('role', 'listitem');
        verseSpan.style.animationDelay = `${Math.min(i * 0.02, 0.5)}s`;

        const numSpan = document.createElement('sup');
        numSpan.className = 'verse-num';
        numSpan.textContent = v.verse;

	        const textSpan = document.createElement('span');
	        textSpan.className = 'verse-text';
	        // Wrap each word in a clickable span for word study
	        const words = v.text.split(/(\s+)/);
	        words.forEach(w => {
	          if (/^\s+$/.test(w)) {
	            textSpan.appendChild(document.createTextNode(w));
	          } else if (w.length > 0) {
	            const ws = document.createElement('span');
	            ws.className = 'verse-word';
	            ws.textContent = w;
	            ws.addEventListener('click', (e) => {
	              e.stopPropagation();
	              showWordPopover(w.replace(/[^\w'-]/g, ''), v.verse, e);
	            });
	            textSpan.appendChild(ws);
	          }
	        });
	        textSpan.appendChild(document.createTextNode(' '));

	        verseSpan.appendChild(numSpan);
	        verseSpan.appendChild(textSpan);
	        verseSpan.addEventListener('click', () => toggleVerse(v.verse));

	        versesContainer.appendChild(verseSpan);
	      });
	    }

	    function syncVerseSelectionUI() {
	      document.querySelectorAll('.verse').forEach(el => {
	        const verseNum = parseInt(el.dataset.verse);
	        el.classList.toggle('selected', selectedVerses.has(verseNum));
	      });
	    }

	    function toggleVerse(verseNum) {
	      if (selectedVerses.size === 0) {
	        selectedVerses.add(verseNum);
	        syncVerseSelectionUI();
	        updateFab();
	        return;
	      }

	      const { startVerse, endVerse } = getSelectedRange();

	      // Keep selection as a contiguous range, since analysis is range-based.
	      if (verseNum >= startVerse && verseNum <= endVerse) {
	        if (startVerse === endVerse) {
	          selectedVerses.clear();
	        } else {
	          selectedVerses = new Set([verseNum]);
	        }
	      } else {
	        const min = Math.min(startVerse, verseNum);
	        const max = Math.max(endVerse, verseNum);
	        selectedVerses = new Set();
	        for (let v = min; v <= max; v++) selectedVerses.add(v);
	      }

	      syncVerseSelectionUI();
	      updateFab();
	    }

	    function clearSelection() {
	      selectedVerses.clear();
	      syncVerseSelectionUI();
	      updateFab();
	    }

    function updateFab() {
      if (selectedVerses.size > 0) {
        interpretFab.classList.add('visible');
        const sorted = [...selectedVerses].sort((a, b) => a - b);
        interpretFab.textContent = sorted.length === 1
          ? 'Interpret Verse ' + sorted[0]
          : 'Interpret ' + sorted.length + ' Verses';
      } else {
        interpretFab.classList.remove('visible');
      }
      if (typeof updateHighlightPalette === 'function') updateHighlightPalette();
    }

    // ===== Interpretation =====
    interpretFab.addEventListener('click', interpretSelection);

	    async function interpretSelection() {
	      if (selectedVerses.size === 0) return;

	      const { sortedVerses, startVerse, endVerse } = getSelectedRange();

	      const reference = endVerse > startVerse
	        ? currentBook + ' ' + currentChapter + ':' + startVerse + '-' + endVerse
	        : currentBook + ' ' + currentChapter + ':' + startVerse;

      const selectedText = sortedVerses.map(v => {
        const el = document.querySelector('.verse[data-verse="' + v + '"] .verse-text');
        return v + ' ' + (el ? el.textContent.trim() : '');
      }).join(' ');

      interpretPanel.classList.remove('hidden');
      selectedTextEl.textContent = selectedText;
      panelLoading.classList.remove('hidden');
      interpretationContent.style.display = 'none';
      wordList.textContent = '';
      interpretationText.textContent = '';
      document.getElementById('crossref-section').style.display = 'none';
      document.getElementById('crossref-content').textContent = '';
      // Reset word study mode
      const wsC = document.getElementById('word-study-container');
      if (wsC) wsC.style.display = 'none';
      document.getElementById('words-toggle').style.display = '';
      document.getElementById('words-section').style.display = '';
      document.getElementById('interpretation-toggle').style.display = '';
      document.getElementById('interpretation-section').style.display = '';
      selectedTextEl.style.display = '';

	      try {
	        const translation = versionSelect.value;
	        const response = await fetch('/api/analyze', {
	          method: 'POST',
	          headers: { 'Content-Type': 'application/json' },
	          body: JSON.stringify({ reference, translation })
	        });

	        if (!response.ok) {
	          throw new Error(await getResponseError(response, 'Failed to analyze'));
	        }

	        const data = await response.json();
	        displayInterpretation(data);
	        fetchUsage();
	        if (typeof saveToHistory === 'function') saveToHistory(reference, data);
	        // Auto-fetch cross-references
	        fetchCrossReferences(currentBook, currentChapter, startVerse, endVerse);
	      } catch (err) {
        interpretationText.textContent = 'Error: ' + err.message;
        interpretationContent.style.display = 'block';
      } finally {
        panelLoading.classList.add('hidden');
      }
    }

	    function escapeHtml(text) {
	      return String(text)
	        .replace(/&/g, '&amp;')
	        .replace(/</g, '&lt;')
	        .replace(/>/g, '&gt;')
	        .replace(/"/g, '&quot;')
	        .replace(/'/g, '&#39;');
	    }

	    function renderMarkdown(text) {
	      if (!text) return '';
	      return escapeHtml(text)
	        .replace(/^### (.*$)/gm, '<h4>$1</h4>')
	        .replace(/^## (.*$)/gm, '<h3>$1</h3>')
	        .replace(/^# (.*$)/gm, '<h2>$1</h2>')
	        .replace(/\*\*\*(.*?)\*\*\*/g, '<strong><em>$1</em></strong>')
        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
        .replace(/\*(.*?)\*/g, '<em>$1</em>')
        .replace(/\n\n/g, '</p><p>')
        .replace(/^/, '<p>')
        .replace(/$/, '</p>');
    }

    function displayInterpretation(data) {
      wordList.textContent = '';
      if (data.words && data.words.length > 0) {
        data.words.forEach(word => {
          const item = document.createElement('div');
          item.className = 'word-item';

          const original = document.createElement('div');
          original.className = 'word-original';
          original.textContent = word.original || '';
          item.appendChild(original);

          if (word.transliteration) {
            const translit = document.createElement('div');
            translit.className = 'word-transliteration';
            translit.textContent = word.transliteration;
            item.appendChild(translit);
          }

          if (word.strongs) {
            const strongs = document.createElement('span');
            strongs.className = 'word-strongs';
            const link = document.createElement('a');
            const isHebrew = word.strongs.toUpperCase().startsWith('H');
            const strongsNum = word.strongs.replace(/[^\d]/g, '');
            link.href = isHebrew
              ? 'https://biblehub.com/hebrew/' + strongsNum + '.htm'
              : 'https://biblehub.com/greek/' + strongsNum + '.htm';
            link.target = '_blank';
            link.rel = 'noopener';
            link.textContent = "Strong's " + word.strongs;
            strongs.appendChild(link);
            item.appendChild(strongs);
          }

          if (word.verse) {
            const verseBadge = document.createElement('span');
            verseBadge.className = 'word-verse-badge';
            verseBadge.textContent = 'v.' + word.verse;
            item.appendChild(verseBadge);
          }

          if (word.definition) {
            const def = document.createElement('div');
            def.className = 'word-definition';
            def.textContent = word.definition;
            item.appendChild(def);
          }

          wordList.appendChild(item);
        });
      } else {
        const noWords = document.createElement('div');
        noWords.textContent = 'Word-level data analyzed by AI below.';
        noWords.style.color = 'var(--neutral-500)';
        noWords.style.fontStyle = 'italic';
        noWords.style.fontSize = 'var(--text-sm)';
        wordList.appendChild(noWords);
      }

      interpretationText.innerHTML = renderMarkdown(data.interpretation || 'No interpretation available.');
      interpretationContent.style.display = 'block';
    }

    closePanel.addEventListener('click', () => {
      interpretPanel.classList.add('hidden');
    });

    // ===== Collapsible Sections =====
    document.getElementById('words-toggle').addEventListener('click', function() {
      this.classList.toggle('collapsed');
      document.getElementById('words-section').classList.toggle('collapsed');
    });

    document.getElementById('interpretation-toggle').addEventListener('click', function() {
      this.classList.toggle('collapsed');
      document.getElementById('interpretation-section').classList.toggle('collapsed');
    });

    document.getElementById('crossref-toggle').addEventListener('click', function() {
      this.classList.toggle('collapsed');
      document.getElementById('crossref-content').classList.toggle('collapsed');
    });

    // ===== Cross-References =====
    const CROSSREF_CACHE_KEY = 'bible-crossref-cache';
    function getCrossRefCache() {
      try { return JSON.parse(localStorage.getItem(CROSSREF_CACHE_KEY)) || {}; } catch(e) { return {}; }
    }

    async function fetchCrossReferences(book, chapter, startVerse, endVerse) {
      const crossrefSection = document.getElementById('crossref-section');
      const crossrefContent = document.getElementById('crossref-content');
      const cacheKey = book + ':' + chapter + ':' + startVerse + '-' + (endVerse || startVerse);

      // Check cache
      const cache = getCrossRefCache();
      if (cache[cacheKey]) {
        crossrefSection.style.display = '';
        displayCrossReferences(cache[cacheKey]);
        return;
      }

      // Show loading
      crossrefSection.style.display = '';
      crossrefContent.innerHTML = '<div class="crossref-loading"><div class="spinner"></div> Finding related passages...</div>';

      try {
        const resp = await fetch('/api/cross-references', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ book, chapter, startVerse, endVerse: endVerse || startVerse })
        });
        if (!resp.ok) throw new Error('Failed to fetch');
        const data = await resp.json();

        // Cache it
        cache[cacheKey] = data;
        // Keep cache manageable
        const keys = Object.keys(cache);
        if (keys.length > 50) delete cache[keys[0]];
        localStorage.setItem(CROSSREF_CACHE_KEY, JSON.stringify(cache));

        displayCrossReferences(data);
        fetchUsage();
      } catch (err) {
        crossrefContent.innerHTML = '<div style="font-size:var(--text-xs);color:var(--neutral-400);padding:var(--space-2) 0;">Could not load cross-references.</div>';
      }
    }

    function displayCrossReferences(data) {
      const crossrefContent = document.getElementById('crossref-content');
      if (!data.crossReferences || data.crossReferences.length === 0) {
        crossrefContent.innerHTML = '<div style="font-size:var(--text-xs);color:var(--neutral-400);padding:var(--space-2) 0;">No cross-references found.</div>';
        return;
      }
      const list = document.createElement('div');
      list.className = 'crossref-list';
      data.crossReferences.forEach(cr => {
        const item = document.createElement('div');
        item.className = 'crossref-item';
        item.addEventListener('click', () => {
          navigateToPassage(cr);
        });

        const header = document.createElement('div');
        header.className = 'crossref-item-header';
        const ref = document.createElement('span');
        ref.className = 'crossref-ref';
        ref.textContent = cr.reference;
        header.appendChild(ref);
        if (cr.thematicLink) {
          const tag = document.createElement('span');
          tag.className = 'crossref-tag';
          tag.textContent = cr.thematicLink;
          header.appendChild(tag);
        }
        item.appendChild(header);

        const conn = document.createElement('div');
        conn.className = 'crossref-connection';
        conn.textContent = cr.connection;
        item.appendChild(conn);

        list.appendChild(item);
      });
      crossrefContent.textContent = '';
      crossrefContent.appendChild(list);
    }

    // ===== Word Study =====
    let activePopover = null;
    const WORDSTUDY_CACHE_KEY = 'bible-wordstudy-cache';
    function getWordStudyCache() {
      try { return JSON.parse(localStorage.getItem(WORDSTUDY_CACHE_KEY)) || {}; } catch(e) { return {}; }
    }

    function closeWordPopover() {
      if (activePopover) { activePopover.remove(); activePopover = null; }
    }

    document.addEventListener('click', (e) => {
      if (activePopover && !activePopover.contains(e.target) && !e.target.classList.contains('verse-word')) {
        closeWordPopover();
      }
    });

    function showWordPopover(word, verseNum, event) {
      closeWordPopover();
      if (!word || word.length < 2) return;

      const rect = event.target.getBoundingClientRect();
      const pop = document.createElement('div');
      pop.className = 'word-popover';

      // Position near the word
      pop.style.left = Math.min(rect.left, window.innerWidth - 300) + 'px';
      pop.style.top = (rect.bottom + window.scrollY + 4) + 'px';

      pop.innerHTML = '<div style="font-size:var(--text-sm);color:var(--neutral-500);">Loading...</div>';
      document.body.appendChild(pop);
      activePopover = pop;

      // Quick popover: just show the word and a Deep Dive button
      const reference = currentBook + ' ' + currentChapter + ':' + verseNum;
      pop.innerHTML = '';

      const wordEl = document.createElement('div');
      wordEl.className = 'word-popover-original';
      wordEl.textContent = '"' + word + '"';
      pop.appendChild(wordEl);

      const refEl = document.createElement('div');
      refEl.className = 'word-popover-translit';
      refEl.textContent = reference;
      pop.appendChild(refEl);

      const defEl = document.createElement('div');
      defEl.className = 'word-popover-def';
      defEl.textContent = 'Tap "Deep Dive" to explore the original Greek or Hebrew behind this word.';
      pop.appendChild(defEl);

      const diveBtn = document.createElement('button');
      diveBtn.className = 'word-popover-dive';
      diveBtn.textContent = 'Deep Dive';
      diveBtn.addEventListener('click', () => {
        closeWordPopover();
        openWordStudy(word, verseNum, reference);
      });
      pop.appendChild(diveBtn);
    }

    async function openWordStudy(word, verseNum, reference) {
      // Open interpretation panel in word study mode
      interpretPanel.classList.remove('hidden');
      const content = document.getElementById('interpretation-content');
      content.style.display = 'block';

      // Hide normal sections, show word study
      document.getElementById('words-toggle').parentElement.querySelector('#words-toggle').style.display = 'none';
      document.getElementById('words-section').style.display = 'none';
      document.getElementById('interpretation-toggle').style.display = 'none';
      document.getElementById('interpretation-section').style.display = 'none';
      document.getElementById('crossref-section').style.display = 'none';
      selectedTextEl.style.display = 'none';

      // Create word study container
      let wsContainer = document.getElementById('word-study-container');
      if (!wsContainer) {
        wsContainer = document.createElement('div');
        wsContainer.id = 'word-study-container';
        wsContainer.className = 'word-study-content';
        content.appendChild(wsContainer);
      }
      wsContainer.style.display = '';
      wsContainer.innerHTML = '<div class="crossref-loading"><div class="spinner"></div> Analyzing "' + word + '" in the original language...</div>';

      // Get verse context
      const verseEl = document.querySelector('.verse[data-verse="' + verseNum + '"] .verse-text');
      const context = verseEl ? verseEl.textContent.trim() : '';

      // Check cache
      const cacheKey = word.toLowerCase() + ':' + reference;
      const cache = getWordStudyCache();
      if (cache[cacheKey]) {
        displayWordStudy(cache[cacheKey], wsContainer);
        return;
      }

      try {
        const resp = await fetch('/api/word-study', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ word, reference, context })
        });
        if (!resp.ok) throw new Error('Failed to fetch');
        const data = await resp.json();

        // Cache
        cache[cacheKey] = data;
        const keys = Object.keys(cache);
        if (keys.length > 30) delete cache[keys[0]];
        localStorage.setItem(WORDSTUDY_CACHE_KEY, JSON.stringify(cache));

        displayWordStudy(data, wsContainer);
        fetchUsage();
      } catch (err) {
        wsContainer.innerHTML = '<div style="color:var(--neutral-400);font-size:var(--text-sm);">Could not load word study. Please try again.</div>';
      }
    }

    function displayWordStudy(data, container) {
      container.innerHTML = '';

      // Back button
      const back = document.createElement('button');
      back.className = 'word-study-back';
      back.innerHTML = '<svg fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width:12px;height:12px"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/></svg> Back to Interpretation';
      back.addEventListener('click', () => {
        container.style.display = 'none';
        document.getElementById('words-toggle').style.display = '';
        document.getElementById('words-section').style.display = '';
        document.getElementById('interpretation-toggle').style.display = '';
        document.getElementById('interpretation-section').style.display = '';
        selectedTextEl.style.display = '';
        // Show crossref if it has content
        const crs = document.getElementById('crossref-section');
        if (crs.querySelector('.crossref-list')) crs.style.display = '';
      });
      container.appendChild(back);

      // Header
      const header = document.createElement('div');
      header.className = 'word-study-header';
      header.innerHTML = '<div class="word-study-original">' + escapeHtml(data.original || '') + '</div>'
        + '<div class="word-study-translit">' + escapeHtml(data.transliteration || '') + ' (' + escapeHtml(data.language || '') + ')</div>'
        + (data.strongsNumber ? '<div class="word-study-strongs-badge">Strong\'s ' + escapeHtml(data.strongsNumber) + '</div>' : '')
        + '<div style="margin-top:var(--space-2);font-size:var(--text-sm);color:var(--neutral-600);">English: "' + escapeHtml(data.english || '') + '"</div>';
      container.appendChild(header);

      // Definition
      if (data.definition) {
        const sec = makeWsSection('Definition', data.definition);
        container.appendChild(sec);
      }

      // Etymology
      if (data.etymology) {
        const sec = makeWsSection('Etymology', data.etymology);
        container.appendChild(sec);
      }

      // Usage Examples
      if (data.usageExamples && data.usageExamples.length > 0) {
        const sec = document.createElement('div');
        sec.className = 'word-study-section';
        const title = document.createElement('div');
        title.className = 'word-study-section-title';
        title.textContent = 'Usage in Scripture';
        sec.appendChild(title);

        data.usageExamples.forEach(ex => {
          const usage = document.createElement('div');
          usage.className = 'word-study-usage';
          usage.innerHTML = '<div class="word-study-usage-ref">' + escapeHtml(ex.reference || '') + '</div>'
            + '<div class="word-study-usage-snippet">"' + escapeHtml(ex.snippet || '') + '"</div>'
            + '<div class="word-study-usage-nuance">' + escapeHtml(ex.nuance || '') + '</div>';
          usage.addEventListener('click', () => {
            navigateToPassage(ex);
          });
          sec.appendChild(usage);
        });
        container.appendChild(sec);
      }

      // Theological Significance
      if (data.theologicalSignificance) {
        const sec = makeWsSection('Theological Significance', data.theologicalSignificance);
        container.appendChild(sec);
      }

      // Related Words
      if (data.relatedWords && data.relatedWords.length > 0) {
        const sec = document.createElement('div');
        sec.className = 'word-study-section';
        const title = document.createElement('div');
        title.className = 'word-study-section-title';
        title.textContent = 'Related Words';
        sec.appendChild(title);
        const wrap = document.createElement('div');
        data.relatedWords.forEach(rw => {
          const chip = document.createElement('span');
          chip.className = 'word-study-related';
          chip.textContent = (rw.transliteration || rw.word) + (rw.strongs ? ' (' + rw.strongs + ')' : '') + '  ' + (rw.relation || '');
          wrap.appendChild(chip);
        });
        sec.appendChild(wrap);
        container.appendChild(sec);
      }

      // Occurrence count
      if (data.occurrenceCount) {
        const occ = document.createElement('div');
        occ.style.cssText = 'font-size:var(--text-xs);color:var(--neutral-400);margin-top:var(--space-3);text-align:center;';
        occ.textContent = 'Appears ~' + data.occurrenceCount + ' times in the Bible';
        container.appendChild(occ);
      }
    }

    function makeWsSection(titleText, bodyText) {
      const sec = document.createElement('div');
      sec.className = 'word-study-section';
      const title = document.createElement('div');
      title.className = 'word-study-section-title';
      title.textContent = titleText;
      sec.appendChild(title);
      const body = document.createElement('div');
      body.textContent = bodyText;
      sec.appendChild(body);
      return sec;
    }

    // ===== Verse Cards =====
    const CARD_THEMES = [
      { name: 'Warm Gradient', bg: ['#FF6B6B', '#FFA07A'], text: '#FFFFFF', accent: '#FFD93D', sub: 'rgba(255,255,255,0.8)' },
      { name: 'Dark Elegant', bg: ['#1a1a2e', '#16213e'], text: '#E0E0E0', accent: '#E94560', sub: 'rgba(224,224,224,0.6)' },
      { name: 'Nature Green', bg: ['#2D6A4F', '#40916C'], text: '#FFFFFF', accent: '#B7E4C7', sub: 'rgba(255,255,255,0.7)' },
      { name: 'Minimal Light', bg: ['#F8F9FA', '#E9ECEF'], text: '#212529', accent: '#6366F1', sub: 'rgba(33,37,41,0.5)' },
      { name: 'Sunset', bg: ['#F97316', '#EC4899'], text: '#FFFFFF', accent: '#FDE68A', sub: 'rgba(255,255,255,0.8)' },
      { name: 'Ocean Blue', bg: ['#0077B6', '#00B4D8'], text: '#FFFFFF', accent: '#90E0EF', sub: 'rgba(255,255,255,0.7)' }
    ];
    let cardThemeIdx = parseInt(localStorage.getItem('bible-card-last-theme') || '0');
    let cardSize = 'square'; // 'square' or 'landscape'
    const cardCanvas = document.getElementById('card-canvas');
    const cardModal = document.getElementById('card-modal');
    const cardBackdrop = document.getElementById('card-backdrop');

    // Render theme selector chips
    const cardThemesEl = document.getElementById('card-themes');
    CARD_THEMES.forEach((theme, i) => {
      const btn = document.createElement('button');
      btn.className = 'card-theme-btn' + (i === cardThemeIdx ? ' active' : '');
      btn.style.background = 'linear-gradient(135deg, ' + theme.bg[0] + ', ' + theme.bg[1] + ')';
      btn.title = theme.name;
      btn.addEventListener('click', () => {
        cardThemeIdx = i;
        localStorage.setItem('bible-card-last-theme', i);
        cardThemesEl.querySelectorAll('.card-theme-btn').forEach((b, j) => b.classList.toggle('active', j === i));
        renderVerseCard();
      });
      cardThemesEl.appendChild(btn);
    });

    // Size toggle
    document.querySelectorAll('.card-size-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        cardSize = btn.dataset.size;
        document.querySelectorAll('.card-size-btn').forEach(b => b.classList.toggle('active', b.dataset.size === cardSize));
        renderVerseCard();
      });
    });

    function openVerseCard() {
      cardModal.classList.add('open');
      cardBackdrop.classList.add('open');
      renderVerseCard();
    }

    function closeVerseCard() {
      cardModal.classList.remove('open');
      cardBackdrop.classList.remove('open');
    }

    document.getElementById('close-card').addEventListener('click', closeVerseCard);
    cardBackdrop.addEventListener('click', closeVerseCard);
    document.getElementById('create-card-btn').addEventListener('click', openVerseCard);

    function wrapText(ctx, text, maxWidth) {
      const words = text.split(' ');
      const lines = [];
      let line = '';
      for (const w of words) {
        const test = line ? line + ' ' + w : w;
        if (ctx.measureText(test).width > maxWidth && line) {
          lines.push(line);
          line = w;
        } else {
          line = test;
        }
      }
      if (line) lines.push(line);
      return lines;
    }

    function renderVerseCard() {
      const theme = CARD_THEMES[cardThemeIdx];
      const W = cardSize === 'square' ? 1080 : 1200;
      const H = cardSize === 'square' ? 1080 : 628;
      cardCanvas.width = W;
      cardCanvas.height = H;
      const ctx = cardCanvas.getContext('2d');

      // Background gradient
      const grad = ctx.createLinearGradient(0, 0, W, H);
      grad.addColorStop(0, theme.bg[0]);
      grad.addColorStop(1, theme.bg[1]);
      ctx.fillStyle = grad;
      ctx.fillRect(0, 0, W, H);

      // Decorative accent line
      ctx.strokeStyle = theme.accent;
      ctx.lineWidth = 3;
      const pad = W * 0.1;
      ctx.beginPath();
      ctx.moveTo(pad, H * 0.15);
      ctx.lineTo(W - pad, H * 0.15);
      ctx.stroke();

      // Get verse text and reference
      const { sortedVerses, startVerse, endVerse } = getSelectedRange();
      if (sortedVerses.length === 0) return;
      const reference = endVerse > startVerse
        ? currentBook + ' ' + currentChapter + ':' + startVerse + '-' + endVerse
        : currentBook + ' ' + currentChapter + ':' + startVerse;
      const verseText = sortedVerses.map(v => {
        const el = document.querySelector('.verse[data-verse="' + v + '"] .verse-text');
        return el ? el.textContent.trim() : '';
      }).join(' ');

      // Verse text
      const fontSize = Math.min(W * 0.042, 44);
      ctx.font = 'italic ' + fontSize + 'px Georgia, "Times New Roman", serif';
      ctx.fillStyle = theme.text;
      ctx.textAlign = 'center';
      const maxTextW = W - pad * 2;
      const lines = wrapText(ctx, '"' + verseText + '"', maxTextW);
      const lineH = fontSize * 1.6;
      const totalTextH = lines.length * lineH;
      let startY = (H - totalTextH) / 2 - 10;
      if (startY < H * 0.2) startY = H * 0.2;

      lines.forEach((line, i) => {
        ctx.fillText(line, W / 2, startY + i * lineH);
      });

      // Bottom accent line
      const bottomLineY = startY + totalTextH + 30;
      ctx.strokeStyle = theme.accent;
      ctx.lineWidth = 2;
      ctx.beginPath();
      ctx.moveTo(W * 0.35, bottomLineY);
      ctx.lineTo(W * 0.65, bottomLineY);
      ctx.stroke();

      // Reference
      const refFontSize = Math.min(W * 0.028, 28);
      ctx.font = '600 ' + refFontSize + 'px system-ui, -apple-system, sans-serif';
      ctx.fillStyle = theme.sub;
      ctx.fillText(' ' + reference, W / 2, bottomLineY + 40);

      // Watermark
      ctx.font = '500 ' + (W * 0.014) + 'px system-ui, sans-serif';
      ctx.fillStyle = theme.sub;
      ctx.globalAlpha = 0.4;
      ctx.fillText('Bible Interpreter', W / 2, H - 30);
      ctx.globalAlpha = 1;
    }

    // Download
    document.getElementById('card-download').addEventListener('click', () => {
      cardCanvas.toBlob(blob => {
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'verse-card-' + currentBook + '-' + currentChapter + '.png';
        a.click();
        URL.revokeObjectURL(url);
        showToast('Card downloaded!');
      }, 'image/png');
    });

    // Copy to clipboard
    document.getElementById('card-copy').addEventListener('click', async () => {
      try {
        const blob = await new Promise(r => cardCanvas.toBlob(r, 'image/png'));
        await navigator.clipboard.write([new ClipboardItem({ 'image/png': blob })]);
        showToast('Copied to clipboard!');
      } catch (err) {
        showToast('Could not copy to clipboard');
      }
    });

	    // ===== Panel Actions =====
	    document.getElementById('copy-btn').addEventListener('click', async () => {
	      const { startVerse, endVerse } = getSelectedRange();
	      const reference = endVerse > startVerse
	        ? `${currentBook} ${currentChapter}:${startVerse}-${endVerse}`
	        : `${currentBook} ${currentChapter}:${startVerse}`;
	      const text = `${reference}\n\n${selectedTextEl.textContent}\n\n${interpretationText.textContent}`;
	      try {
	        await navigator.clipboard.writeText(text);
	        const btn = document.getElementById('copy-btn');
	        btn.classList.add('copied');
	        btn.querySelector('span').textContent = 'Copied!';
        setTimeout(() => {
          btn.classList.remove('copied');
          btn.querySelector('span').textContent = 'Copy';
        }, 2000);
        showToast('Copied to clipboard');
      } catch (err) {
        showToast('Failed to copy');
      }
    });

    document.getElementById('share-btn').addEventListener('click', async () => {
      const shareData = {
        title: `${currentBook} ${currentChapter}`,
        text: interpretationText.textContent.substring(0, 200) + '...',
        url: window.location.href
      };

      if (navigator.share) {
        try {
          await navigator.share(shareData);
        } catch (err) {
          if (err.name !== 'AbortError') {
            await navigator.clipboard.writeText(window.location.href);
            showToast('Link copied');
          }
        }
      } else {
        await navigator.clipboard.writeText(window.location.href);
        showToast('Link copied to clipboard');
      }
    });

    // ===== Toast =====
    function showToast(message) {
      toast.textContent = message;
      toast.classList.add('visible');
      setTimeout(() => toast.classList.remove('visible'), 3000);
    }

    // ===== Search Modal =====
    function openSearch() {
      searchModal.classList.add('open');
      searchBackdrop.classList.add('open');
      searchInput.value = '';
      searchResults.textContent = '';
      searchInput.focus();
    }

    function closeSearch() {
      searchModal.classList.remove('open');
      searchBackdrop.classList.remove('open');
    }

    searchBackdrop.addEventListener('click', closeSearch);

	    searchInput.addEventListener('input', () => {
	      const query = searchInput.value.trim().toLowerCase();
	      searchResults.textContent = '';

	      if (!query) return;

	      // Parse reference
	      const match = query.match(/^(.+?)\s*(\d+)?(?::(\d+))?/i);
	      if (match) {
	        const [, bookPart, chapter, verse] = match;
	        const bookName = bookPart.replace(/\s+/g, '').toLowerCase();

        // Find matching books
        const matches = [];
        BOOKS.forEach((book, index) => {
          const name = book.name.toLowerCase().replace(/\s+/g, '');
          if (name.startsWith(bookName) || (BOOK_ALIASES[bookName] === index)) {
            matches.push({ book, index, chapter: chapter || 1, verse });
          }
        });

        matches.slice(0, 5).forEach(m => {
          const item = document.createElement('div');
          item.className = 'search-result-item';

          const ref = document.createElement('span');
          ref.className = 'search-result-ref';
          ref.textContent = m.book.name + (m.chapter ? ' ' + m.chapter : '') + (m.verse ? ':' + m.verse : '');

          item.appendChild(ref);
          item.addEventListener('click', () => {
            bookSelect.value = m.index;
            bookSelect.dispatchEvent(new Event('change'));
            chapterSelect.value = m.chapter;
            loadChapter();
            closeSearch();
          });

          searchResults.appendChild(item);
        });
      }
    });

    searchInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        const firstResult = searchResults.querySelector('.search-result-item');
        if (firstResult) firstResult.click();
      } else if (e.key === 'Escape') {
        closeSearch();
      }
    });

    // ===== Keyboard Shortcuts =====
    document.addEventListener('keydown', (e) => {
      if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;

      switch(e.code) {
        case 'ArrowLeft':
          if (!prevChapterBtn.disabled) prevChapterBtn.click();
          break;
        case 'ArrowRight':
          if (!nextChapterBtn.disabled) nextChapterBtn.click();
          break;
        case 'Escape':
          if (document.getElementById('auth-modal').classList.contains('open')) {
            DataStore._closeAuthModal();
          } else if (activePopover) {
            closeWordPopover();
          } else if (cardModal.classList.contains('open')) {
            closeVerseCard();
          } else if (drawerEl.classList.contains('open')) {
            closeDrawer();
          } else if (topicalModal.classList.contains('open')) {
            closeTopicalBrowse();
          } else if (plansModal.classList.contains('open')) {
            closeReadingPlans();
          } else if (prayerJournalModal.classList.contains('open')) {
            closePrayerJournal();
          } else if (lifeAppModal.classList.contains('open')) {
            closeLifeApp();
          } else if (searchModal.classList.contains('open')) {
            closeSearch();
          } else {
            clearSelection();
            interpretPanel.classList.add('hidden');
          }
          break;
        case 'Enter':
          if (selectedVerses.size > 0) interpretSelection();
          break;
        case 'Backquote':
          e.preventDefault();
          if (drawerEl.classList.contains('open')) closeDrawer();
          else openDrawer();
          break;
        case 'KeyD':
          toggleDarkMode();
          break;
        case 'KeyT':
          openTopicalBrowse();
          break;
        case 'KeyP':
          openReadingPlans();
          break;
        case 'KeyL':
          openLifeApp();
          break;
        case 'Slash':
          e.preventDefault();
          openSearch();
          break;
      }
    });

    // Cmd/Ctrl+F for search
    document.addEventListener('keydown', (e) => {
      if ((e.metaKey || e.ctrlKey) && e.key === 'f') {
        e.preventDefault();
        openSearch();
      }
    });

    // ===== Usage Tracking =====
    const usageBadge = document.getElementById('usage-badge');
    const usageModal = document.getElementById('usage-modal');
    const usageCost = document.getElementById('usage-cost');
    const usageTotalCost = document.getElementById('usage-total-cost');
    const usageRequests = document.getElementById('usage-requests');
    const usageInput = document.getElementById('usage-input');
    const usageOutput = document.getElementById('usage-output');
    const recentRequestsEl = document.getElementById('recent-requests');
    const usageReset = document.getElementById('usage-reset');

    usageBadge.addEventListener('click', () => {
      usageModal.classList.toggle('visible');
      if (usageModal.classList.contains('visible')) fetchUsage();
    });

    usageBadge.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' || e.key === ' ') {
        e.preventDefault();
        usageBadge.click();
      }
    });

    document.addEventListener('click', (e) => {
      if (!usageModal.contains(e.target) && !usageBadge.contains(e.target)) {
        usageModal.classList.remove('visible');
      }
    });

    usageReset.addEventListener('click', async () => {
      if (confirm('Reset all usage stats? This cannot be undone.')) {
        await fetch('/api/usage/reset', { method: 'POST' });
        fetchUsage();
        showToast('Usage stats reset');
      }
    });

    async function fetchUsage() {
      try {
        const response = await fetch('/api/usage');
        const data = await response.json();
        updateUsageDisplay(data);
      } catch (err) {
        console.error('Error fetching usage:', err);
      }
    }

    function updateUsageDisplay(data) {
      usageCost.textContent = data.formattedCost;
      usageTotalCost.textContent = data.formattedCost;
      usageRequests.textContent = data.totalRequests.toLocaleString();
      usageInput.textContent = data.totalInputTokens.toLocaleString();
      usageOutput.textContent = data.totalOutputTokens.toLocaleString();

      recentRequestsEl.textContent = '';
      const header = document.createElement('div');
      header.className = 'usage-stat';
      const headerLabel = document.createElement('span');
      headerLabel.className = 'usage-stat-label';
      headerLabel.textContent = 'Recent Requests';
      header.appendChild(headerLabel);
      recentRequestsEl.appendChild(header);

      if (data.recentRequests && data.recentRequests.length > 0) {
        data.recentRequests.forEach(req => {
          const div = document.createElement('div');
          div.className = 'recent-request';
          const refSpan = document.createElement('span');
          refSpan.className = 'recent-request-ref';
          refSpan.textContent = req.reference;
          const costSpan = document.createElement('span');
          costSpan.className = 'recent-request-cost';
          costSpan.textContent = '$' + req.estimatedCost.toFixed(4);
          div.appendChild(refSpan);
          div.appendChild(costSpan);
          recentRequestsEl.appendChild(div);
        });
      } else {
        const noReqs = document.createElement('div');
        noReqs.className = 'recent-request';
        noReqs.textContent = 'No requests yet';
        recentRequestsEl.appendChild(noReqs);
      }
    }

    fetchUsage();

    // ===== Loading Skeleton =====
    function showLoadingSkeleton() {
      versesContainer.textContent = '';
      for (let i = 0; i < 12; i++) {
        const sk = document.createElement('div');
        sk.className = 'skeleton-verse';
        const numEl = document.createElement('div');
        numEl.className = 'skeleton-num';
        const lineEl = document.createElement('div');
        lineEl.className = 'skeleton-line' + (i % 3 === 2 ? ' short' : i % 3 === 1 ? ' medium' : '');
        sk.appendChild(numEl);
        sk.appendChild(lineEl);
        versesContainer.appendChild(sk);
      }
    }

    // showLoadingSkeleton is called from the original loadChapter above

    // ===== Interpretation History =====
    const HISTORY_KEY = 'bible-interp-history';
    const MAX_HISTORY = 25;

    function getHistory() {
      return DataStore.getHistory();
    }

    function saveToHistory(reference, data) {
      const history = getHistory();
      const idx = history.findIndex(h => h.reference === reference);
      if (idx !== -1) history.splice(idx, 1);
      history.unshift({
        reference,
        data,
        timestamp: Date.now()
      });
      if (history.length > MAX_HISTORY) history.length = MAX_HISTORY;
      DataStore.saveHistory(history);
      updateHistoryBadge();
    }

    function updateHistoryBadge() {
      const history = getHistory();
      const countEl = document.getElementById('history-count');
      if (history.length > 0) {
        countEl.style.display = 'flex';
        countEl.textContent = history.length;
      } else {
        countEl.style.display = 'none';
      }
    }

    updateHistoryBadge();

    const historyBtn = document.getElementById('history-btn');
    const historyModal = document.getElementById('history-modal');
    const historyList = document.getElementById('history-list');
    const historyClear = document.getElementById('history-clear');

    historyBtn.addEventListener('click', () => {
      historyModal.classList.toggle('visible');
      if (historyModal.classList.contains('visible')) {
        renderHistory();
        // Hide the badge when viewing history
        const countEl = document.getElementById('history-count');
        countEl.style.display = 'none';
      }
    });

    document.addEventListener('click', (e) => {
      if (!historyModal.contains(e.target) && !historyBtn.contains(e.target)) {
        historyModal.classList.remove('visible');
      }
    });

    historyClear.addEventListener('click', () => {
      DataStore.saveHistory([]);
      updateHistoryBadge();
      renderHistory();
      showToast('History cleared');
    });

    function renderHistory() {
      const history = getHistory();
      historyList.textContent = '';
      if (history.length === 0) {
        const empty = document.createElement('div');
        empty.className = 'history-empty';
        empty.textContent = 'No interpretations yet';
        historyList.appendChild(empty);
        return;
      }
      history.forEach(h => {
        const item = document.createElement('div');
        item.className = 'history-item';

        const refEl = document.createElement('div');
        refEl.className = 'history-item-ref';
        refEl.textContent = h.reference;
        item.appendChild(refEl);

        const previewEl = document.createElement('div');
        previewEl.className = 'history-item-preview';
        previewEl.textContent = (h.data.interpretation || '').substring(0, 80) + '...';
        item.appendChild(previewEl);

        const timeEl = document.createElement('div');
        timeEl.className = 'history-item-time';
        timeEl.textContent = timeAgo(h.timestamp);
        item.appendChild(timeEl);

        item.addEventListener('click', () => {
          interpretPanel.classList.remove('hidden');
          selectedTextEl.textContent = h.data.englishText || '';
          displayInterpretation(h.data);
          interpretationContent.style.display = 'block';
          panelLoading.classList.add('hidden');
          historyModal.classList.remove('visible');
          showToast('Loaded from history');
        });
        historyList.appendChild(item);
      });
    }

    function timeAgo(ts) {
      const diff = Date.now() - ts;
      const mins = Math.floor(diff / 60000);
      if (mins < 1) return 'just now';
      if (mins < 60) return mins + 'm ago';
      const hrs = Math.floor(mins / 60);
      if (hrs < 24) return hrs + 'h ago';
      const days = Math.floor(hrs / 24);
      return days + 'd ago';
    }

    // saveToHistory is called from the original interpretSelection above

    // ===== Search Keyboard Navigation =====
    let searchActiveIndex = -1;

    searchInput.addEventListener('input', () => {
      searchActiveIndex = -1;
      setTimeout(() => {
        const items = searchResults.querySelectorAll('.search-result-item');
        const existingCount = searchResults.parentElement.querySelector('.search-count');
        if (existingCount) existingCount.remove();
        if (items.length > 0 && searchInput.value.trim()) {
          const count = document.createElement('div');
          count.className = 'search-count';
          count.textContent = items.length + ' result' + (items.length > 1 ? 's' : '');
          searchResults.before(count);
        }
      }, 0);
    });

    searchInput.removeEventListener('keydown', searchInput._keyHandler);
    searchInput._keyHandler = function(e) {
      const items = searchResults.querySelectorAll('.search-result-item');
      if (e.key === 'ArrowDown') {
        e.preventDefault();
        searchActiveIndex = Math.min(searchActiveIndex + 1, items.length - 1);
        updateSearchHighlight(items);
      } else if (e.key === 'ArrowUp') {
        e.preventDefault();
        searchActiveIndex = Math.max(searchActiveIndex - 1, 0);
        updateSearchHighlight(items);
      } else if (e.key === 'Enter') {
        if (searchActiveIndex >= 0 && items[searchActiveIndex]) {
          items[searchActiveIndex].click();
        } else if (items.length > 0) {
          items[0].click();
        }
      } else if (e.key === 'Escape') {
        closeSearch();
      }
    };
    searchInput.addEventListener('keydown', searchInput._keyHandler);

    function updateSearchHighlight(items) {
      items.forEach((item, i) => {
        item.classList.toggle('keyboard-active', i === searchActiveIndex);
      });
      if (items[searchActiveIndex]) {
        items[searchActiveIndex].scrollIntoView({ block: 'nearest' });
      }
    }

    // ===== Compare Translations =====
    const compareBtn = document.getElementById('compare-btn');
    const compareModal = document.getElementById('compare-modal');
    const compareBackdrop = document.getElementById('compare-backdrop');
    const compareBody = document.getElementById('compare-body');
    const compareTitle = document.getElementById('compare-title');
    const closeCompare = document.getElementById('close-compare');

    compareBtn.addEventListener('click', async () => {
      if (selectedVerses.size === 0) {
        showToast('Select verses first');
        return;
      }

      const { startVerse, endVerse } = getSelectedRange();
      const ref = endVerse > startVerse
        ? currentBook + ' ' + currentChapter + ':' + startVerse + '-' + endVerse
        : currentBook + ' ' + currentChapter + ':' + startVerse;

      compareTitle.textContent = 'Compare: ' + ref;
      compareBody.textContent = '';
      const loadingDiv = document.createElement('div');
      loadingDiv.className = 'loading-state';
      const spinnerDiv = document.createElement('div');
      spinnerDiv.className = 'spinner';
      const loadingP = document.createElement('p');
      loadingP.textContent = 'Loading translations...';
      loadingDiv.appendChild(spinnerDiv);
      loadingDiv.appendChild(loadingP);
      compareBody.appendChild(loadingDiv);

      compareModal.classList.add('visible');
      compareBackdrop.classList.add('visible');

      try {
        const response = await fetch('/api/compare', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            book: currentBook,
            chapter: currentChapter,
            startVerse,
            endVerse,
            translations: ['ESV', 'KJV', 'NIV2011', 'NLT', 'NASB']
          })
        });

        if (!response.ok) throw new Error('Failed to compare');
        const data = await response.json();

        compareBody.textContent = '';
        const labelMap = { NIV2011: 'NIV', CSB17: 'CSB' };
        for (const [trans, verses] of Object.entries(data.translations)) {
          const row = document.createElement('div');
          row.className = 'compare-row';
          const label = document.createElement('div');
          label.className = 'compare-label';
          label.textContent = labelMap[trans] || trans;
          const text = document.createElement('div');
          text.className = 'compare-text';
          text.textContent = verses.map(v => v.text).join(' ');
          row.appendChild(label);
          row.appendChild(text);
          compareBody.appendChild(row);
        }
      } catch (err) {
        compareBody.textContent = 'Error: ' + err.message;
      }
    });

    function closeCompareModal() {
      compareModal.classList.remove('visible');
      compareBackdrop.classList.remove('visible');
    }

    closeCompare.addEventListener('click', closeCompareModal);
    compareBackdrop.addEventListener('click', closeCompareModal);

    // ===== Verse Highlights =====
    const HL_KEY = 'bible-highlights';
    const hlPalette = document.getElementById('highlight-palette');

    function getHighlights() {
      return DataStore.getHighlights();
    }

    function saveHighlights(hl) {
      DataStore.saveHighlights(hl);
    }

    function applyHighlights() {
      const hl = getHighlights();
      const prefix = currentBookIndex + '-' + currentChapter + '-';
      document.querySelectorAll('.verse').forEach(el => {
        const key = prefix + el.dataset.verse;
        if (hl[key]) {
          el.dataset.highlight = hl[key];
        } else {
          delete el.dataset.highlight;
        }
      });
    }

    function setHighlight(color) {
      const hl = getHighlights();
      const prefix = currentBookIndex + '-' + currentChapter + '-';
      selectedVerses.forEach(v => {
        const key = prefix + v;
        if (color === 'clear') {
          delete hl[key];
        } else {
          hl[key] = color;
        }
      });
      saveHighlights(hl);
      applyHighlights();
    }

    // Show palette when verses are selected
    function updateHighlightPalette() {
      if (selectedVerses.size > 0) {
        hlPalette.classList.add('visible');
        // Mark active color
        const hl = getHighlights();
        const prefix = currentBookIndex + '-' + currentChapter + '-';
        const firstKey = prefix + [...selectedVerses][0];
        const activeColor = hl[firstKey] || '';
        hlPalette.querySelectorAll('.hl-dot').forEach(dot => {
          dot.classList.toggle('active', dot.dataset.color === activeColor);
        });
      } else {
        hlPalette.classList.remove('visible');
      }
    }

    hlPalette.addEventListener('click', (e) => {
      const dot = e.target.closest('.hl-dot');
      if (!dot) return;
      setHighlight(dot.dataset.color);
      updateHighlightPalette();
    });

    // updateHighlightPalette is called from within the original updateFab

    // ===== Personal Notes =====
    const NOTES_KEY = 'bible-notes';
    let activeNoteEditor = null;

    function getNotes() {
      return DataStore.getNotes();
    }

    function saveNotes(notes) {
      DataStore.saveNotes(notes);
    }

    function noteKey(verse) {
      return currentBookIndex + '-' + currentChapter + '-' + verse;
    }

    function openNoteEditor(verseNum) {
      closeNoteEditor();
      const verseEl = document.querySelector('.verse[data-verse="' + verseNum + '"]');
      if (!verseEl) return;

      const notes = getNotes();
      const key = noteKey(verseNum);
      const existing = notes[key] || '';

      const editor = document.createElement('div');
      editor.className = 'note-editor-inline';
      editor.dataset.noteVerse = verseNum;

      const ta = document.createElement('textarea');
      ta.value = existing;
      ta.placeholder = 'Add a note for verse ' + verseNum + '...';
      editor.appendChild(ta);

      const actions = document.createElement('div');
      actions.className = 'note-editor-actions';

      if (existing) {
        const delBtn = document.createElement('button');
        delBtn.className = 'note-delete-btn';
        delBtn.textContent = 'Delete';
        delBtn.addEventListener('click', () => {
          delete notes[key];
          saveNotes(notes);
          closeNoteEditor();
          refreshNoteIndicators();
          renderNotesPanel();
          showToast('Note deleted');
        });
        actions.appendChild(delBtn);
      }

      const cancelBtn = document.createElement('button');
      cancelBtn.textContent = 'Cancel';
      cancelBtn.addEventListener('click', closeNoteEditor);
      actions.appendChild(cancelBtn);

      const saveBtn = document.createElement('button');
      saveBtn.className = 'note-save-btn';
      saveBtn.textContent = 'Save';
      saveBtn.addEventListener('click', () => {
        const text = ta.value.trim();
        if (text) {
          notes[key] = text;
          saveNotes(notes);
          showToast('Note saved');
        } else {
          delete notes[key];
          saveNotes(notes);
        }
        closeNoteEditor();
        refreshNoteIndicators();
        renderNotesPanel();
      });
      actions.appendChild(saveBtn);
      editor.appendChild(actions);

      // Insert after the verse element - find the next sibling or append
      verseEl.insertAdjacentElement('afterend', editor);
      activeNoteEditor = editor;
      ta.focus();
    }

    function closeNoteEditor() {
      if (activeNoteEditor) {
        activeNoteEditor.remove();
        activeNoteEditor = null;
      }
    }

    function refreshNoteIndicators() {
      const notes = getNotes();
      const prefix = currentBookIndex + '-' + currentChapter + '-';
      document.querySelectorAll('.verse').forEach(el => {
        const key = prefix + el.dataset.verse;
        let ind = el.querySelector('.note-indicator');
        if (notes[key]) {
          if (!ind) {
            ind = document.createElement('span');
            ind.className = 'note-indicator';
            ind.textContent = '\u270E';
            ind.title = 'View/edit note';
            el.querySelector('.verse-num').appendChild(ind);
          }
        } else if (ind) {
          ind.remove();
        }
      });
    }

    // Double-click verse to add/edit note
    document.getElementById('verses-container').addEventListener('dblclick', (e) => {
      const verseEl = e.target.closest('.verse');
      if (verseEl) {
        e.preventDefault();
        openNoteEditor(parseInt(verseEl.dataset.verse));
      }
    });

    let notesViewMode = 'chapter'; // 'chapter' or 'all'

    const notesTabChapter = document.getElementById('notes-tab-chapter');
    const notesTabAll = document.getElementById('notes-tab-all');

    notesTabChapter.addEventListener('click', () => {
      notesViewMode = 'chapter';
      notesTabChapter.classList.add('active');
      notesTabAll.classList.remove('active');
      renderNotesPanel();
    });

    notesTabAll.addEventListener('click', () => {
      notesViewMode = 'all';
      notesTabAll.classList.add('active');
      notesTabChapter.classList.remove('active');
      renderNotesPanel();
    });

    function renderNotesPanel() {
      const notesList = document.getElementById('notes-list');
      if (!notesList) return;
      notesList.textContent = '';
      const notes = getNotes();

      if (notesViewMode === 'all') {
        renderAllNotes(notesList, notes);
      } else {
        renderChapterNotes(notesList, notes);
      }
    }

    function renderChapterNotes(notesList, notes) {
      const prefix = currentBookIndex + '-' + currentChapter + '-';
      const chapterNotes = [];
      for (const [key, text] of Object.entries(notes)) {
        if (key.startsWith(prefix)) {
          const verse = key.replace(prefix, '');
          chapterNotes.push({ verse: parseInt(verse), text });
        }
      }
      chapterNotes.sort((a, b) => a.verse - b.verse);
      if (chapterNotes.length === 0) {
        const empty = document.createElement('div');
        empty.className = 'notes-empty';
        empty.textContent = 'Double-click a verse to add a note';
        notesList.appendChild(empty);
        return;
      }
      chapterNotes.forEach(n => {
        const item = document.createElement('div');
        item.className = 'note-item';
        const vEl = document.createElement('span');
        vEl.className = 'note-item-verse';
        vEl.textContent = 'v.' + n.verse;
        item.appendChild(vEl);
        const tEl = document.createElement('div');
        tEl.className = 'note-item-text';
        tEl.textContent = n.text;
        item.appendChild(tEl);
        item.addEventListener('click', () => {
          const verseEl = document.querySelector('.verse[data-verse="' + n.verse + '"]');
          if (verseEl) verseEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
          openNoteEditor(n.verse);
        });
        notesList.appendChild(item);
      });
    }

    function renderAllNotes(notesList, notes) {
      const allEntries = Object.entries(notes);
      if (allEntries.length === 0) {
        const empty = document.createElement('div');
        empty.className = 'notes-empty';
        empty.textContent = 'No notes yet';
        notesList.appendChild(empty);
        return;
      }

      // Group by book-chapter
      const groups = {};
      for (const [key, text] of allEntries) {
        const parts = key.split('-');
        if (parts.length !== 3) continue;
        const bookIdx = parseInt(parts[0]);
        const ch = parseInt(parts[1]);
        const verse = parseInt(parts[2]);
        const groupKey = bookIdx + '-' + ch;
        if (!groups[groupKey]) {
          groups[groupKey] = { bookIdx, ch, notes: [] };
        }
        groups[groupKey].notes.push({ verse, text });
      }

      // Sort groups by book then chapter
      const sortedGroups = Object.values(groups).sort((a, b) =>
        a.bookIdx !== b.bookIdx ? a.bookIdx - b.bookIdx : a.ch - b.ch
      );

      sortedGroups.forEach(g => {
        const bookName = BOOKS[g.bookIdx] ? BOOKS[g.bookIdx].name : 'Unknown';
        const header = document.createElement('div');
        header.className = 'note-group-header';
        header.textContent = bookName + ' ' + g.ch;
        notesList.appendChild(header);

        g.notes.sort((a, b) => a.verse - b.verse);
        g.notes.forEach(n => {
          const item = document.createElement('div');
          item.className = 'note-item';
          const vEl = document.createElement('span');
          vEl.className = 'note-item-verse';
          vEl.textContent = 'v.' + n.verse;
          item.appendChild(vEl);
          const tEl = document.createElement('div');
          tEl.className = 'note-item-text';
          tEl.textContent = n.text;
          item.appendChild(tEl);
          item.addEventListener('click', () => {
            // Navigate to the chapter if different
            if (g.bookIdx !== currentBookIndex || g.ch !== currentChapter) {
              bookSelect.value = g.bookIdx;
              bookSelect.dispatchEvent(new Event('change'));
              chapterSelect.value = g.ch;
              loadChapter();
              // Wait for chapter to load then scroll
              setTimeout(() => {
                const verseEl = document.querySelector('.verse[data-verse="' + n.verse + '"]');
                if (verseEl) verseEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
              }, 1000);
            } else {
              const verseEl = document.querySelector('.verse[data-verse="' + n.verse + '"]');
              if (verseEl) verseEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
              openNoteEditor(n.verse);
            }
          });
          notesList.appendChild(item);
        });
      });
    }

    // ===== Chapter Context Card =====
    const BOOK_META = [
      ['Moses','~1446-1406 BC','Israel','Narrative','Origins and God\'s covenant'],
      ['Moses','~1446-1406 BC','Israel','Narrative/Law','Deliverance from Egypt'],
      ['Moses','~1446-1406 BC','Israel','Law','Holiness and worship'],
      ['Moses','~1446-1406 BC','Israel','Narrative/Census','Wilderness journey'],
      ['Moses','~1406 BC','Israel','Law/Sermon','Covenant renewal'],
      ['Joshua','~1400-1370 BC','Israel','Narrative','Conquest of Canaan'],
      ['Samuel/Unknown','~1050-1000 BC','Israel','Narrative','Judges cycle'],
      ['Samuel(?)','~1010 BC','Israel','Narrative','Loyalty and redemption'],
      ['Samuel/Nathan/Gad','~930 BC','Israel','Narrative','Rise of monarchy'],
      ['Samuel/Nathan/Gad','~930 BC','Israel','Narrative','David\'s reign'],
      ['Jeremiah(?)','~560 BC','Israel','Narrative','Divided kingdom'],
      ['Jeremiah(?)','~560 BC','Israel','Narrative','Fall of kingdoms'],
      ['Ezra(?)','~450 BC','Israel','Narrative','Temple worship'],
      ['Ezra(?)','~450 BC','Israel','Narrative','Southern kingdom'],
      ['Ezra','~440 BC','Returnees','Narrative','Return from exile'],
      ['Nehemiah','~430 BC','Returnees','Narrative','Rebuilding walls'],
      ['Unknown','~470 BC','Jews in Persia','Narrative','Providence and courage'],
      ['Unknown','~2000-500 BC','Sufferers','Wisdom/Poetry','Suffering and faith'],
      ['David and others','~1000-400 BC','Worshipers','Poetry/Hymns','Prayer and praise'],
      ['Solomon and others','~950-700 BC','Youth/All','Wisdom','Practical godly living'],
      ['Solomon','~935 BC','All','Wisdom','Meaning of life'],
      ['Solomon','~965 BC','Beloved','Poetry','Love and intimacy'],
      ['Isaiah','~740-680 BC','Judah','Prophecy','Judgment and hope'],
      ['Jeremiah','~627-585 BC','Judah','Prophecy','Warning and exile'],
      ['Jeremiah','~586 BC','Exiles','Poetry','Grief over Jerusalem'],
      ['Ezekiel','~593-571 BC','Exiles','Prophecy','God\'s glory and restoration'],
      ['Daniel','~536 BC','Exiles','Prophecy/Narrative','Sovereignty of God'],
      ['Hosea','~755-715 BC','Israel','Prophecy','Faithful love'],
      ['Joel','~835-800 BC','Judah','Prophecy','Day of the LORD'],
      ['Amos','~760 BC','Israel','Prophecy','Social justice'],
      ['Obadiah','~845 or 586 BC','Edom','Prophecy','Judgment on Edom'],
      ['Jonah','~780-750 BC','Nineveh','Narrative','God\'s mercy to all'],
      ['Micah','~735-700 BC','Judah/Israel','Prophecy','Justice and mercy'],
      ['Nahum','~663-612 BC','Nineveh','Prophecy','God\'s judgment'],
      ['Habakkuk','~609-605 BC','Judah','Prophecy','Living by faith'],
      ['Zephaniah','~640-621 BC','Judah','Prophecy','Coming judgment'],
      ['Haggai','~520 BC','Returnees','Prophecy','Rebuild the temple'],
      ['Zechariah','~520-480 BC','Returnees','Prophecy','Messianic hope'],
      ['Malachi','~430 BC','Israel','Prophecy','Spiritual renewal'],
      ['Matthew','~55-65 AD','Jews','Gospel','Jesus as King'],
      ['Mark (via Peter)','~55-65 AD','Romans','Gospel','Jesus as Servant'],
      ['Luke','~60-62 AD','Theophilus','Gospel','Jesus for all people'],
      ['John','~85-95 AD','Believers','Gospel','Jesus as God'],
      ['Luke','~62 AD','Theophilus','Narrative','Early church growth'],
      ['Paul','~57 AD','Rome church','Epistle','Righteousness by faith'],
      ['Paul','~55 AD','Corinth church','Epistle','Church unity'],
      ['Paul','~56 AD','Corinth church','Epistle','Ministry and comfort'],
      ['Paul','~49 AD','Galatian churches','Epistle','Freedom in Christ'],
      ['Paul','~60-62 AD','Ephesus church','Epistle','Unity in Christ'],
      ['Paul','~60-62 AD','Philippi church','Epistle','Joy in Christ'],
      ['Paul','~60-62 AD','Colossae church','Epistle','Supremacy of Christ'],
      ['Paul','~51 AD','Thessalonica','Epistle','Christ\'s return'],
      ['Paul','~51-52 AD','Thessalonica','Epistle','Perseverance'],
      ['Paul','~63-65 AD','Timothy','Epistle','Church leadership'],
      ['Paul','~66-67 AD','Timothy','Epistle','Faithful endurance'],
      ['Paul','~63-65 AD','Titus','Epistle','Sound doctrine'],
      ['Paul','~60-62 AD','Philemon','Epistle','Forgiveness'],
      ['Unknown','~60s AD','Jewish Christians','Epistle','Christ\'s superiority'],
      ['James','~45-49 AD','Jewish believers','Epistle','Faith and works'],
      ['Peter','~64-65 AD','Scattered believers','Epistle','Hope in suffering'],
      ['Peter','~66-68 AD','Believers','Epistle','True knowledge'],
      ['John','~85-95 AD','Believers','Epistle','God is love'],
      ['John','~85-95 AD','Chosen lady','Epistle','Truth and love'],
      ['John','~85-95 AD','Gaius','Epistle','Hospitality'],
      ['Jude','~65-80 AD','Believers','Epistle','Contend for faith'],
      ['John','~95 AD','Seven churches','Prophecy','Victory of God']
    ];

    function renderContextCard() {
      const rows = document.getElementById('context-rows');
      if (!rows) return;
      rows.textContent = '';
      const meta = BOOK_META[currentBookIndex];
      if (!meta) return;

      const fields = [
        ['Author', meta[0]],
        ['Written', meta[1]],
        ['Audience', meta[2]],
        ['Genre', meta[3]],
        ['Theme', meta[4]]
      ];
      fields.forEach(([label, value]) => {
        const row = document.createElement('div');
        row.className = 'context-row';
        const lbl = document.createElement('span');
        lbl.className = 'context-label';
        lbl.textContent = label;
        const val = document.createElement('span');
        val.className = 'context-value';
        val.textContent = value;
        row.appendChild(lbl);
        row.appendChild(val);
        rows.appendChild(row);
      });
    }

    // ===== Mini Table of Contents =====
    const TOC_CACHE_KEY = 'bible-toc-cache';

    function getTocCache() {
      try { return JSON.parse(localStorage.getItem(TOC_CACHE_KEY) || '{}'); } catch { return {}; }
    }

    function saveTocCache(cache) {
      localStorage.setItem(TOC_CACHE_KEY, JSON.stringify(cache));
    }

    function renderToc(sections) {
      const tocList = document.getElementById('toc-list');
      if (!tocList) return;
      tocList.textContent = '';

      if (!sections || sections.length === 0) {
        const btn = document.createElement('button');
        btn.className = 'toc-generate';
        btn.textContent = 'Generate Outline';
        btn.addEventListener('click', () => fetchToc());
        tocList.appendChild(btn);
        return;
      }

      sections.forEach(s => {
        const item = document.createElement('div');
        item.className = 'toc-item';
        const versesEl = document.createElement('span');
        versesEl.className = 'toc-item-verses';
        versesEl.textContent = 'v.' + s.verses;
        const titleEl = document.createElement('span');
        titleEl.className = 'toc-item-title';
        titleEl.textContent = s.title;
        item.appendChild(versesEl);
        item.appendChild(titleEl);
        item.addEventListener('click', () => {
          const startVerse = parseInt(s.verses);
          const verseEl = document.querySelector('.verse[data-verse="' + startVerse + '"]');
          if (verseEl) verseEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
        });
        tocList.appendChild(item);
      });
    }

    async function fetchToc() {
      const tocList = document.getElementById('toc-list');
      if (!tocList) return;

      // Check cache first
      const cache = getTocCache();
      const cacheKey = currentBookIndex + '-' + currentChapter;
      if (cache[cacheKey]) {
        renderToc(cache[cacheKey]);
        return;
      }

      tocList.textContent = '';
      const loading = document.createElement('div');
      loading.style.cssText = 'text-align:center;padding:8px;font-size:11px;color:var(--neutral-400)';
      loading.textContent = 'Generating outline...';
      tocList.appendChild(loading);

      try {
        const response = await fetch('/api/outline', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ book: currentBook, chapter: currentChapter })
        });
        if (!response.ok) throw new Error('Failed');
        const data = await response.json();
        cache[cacheKey] = data.sections;
        saveTocCache(cache);
        renderToc(data.sections);
        fetchUsage();
      } catch (err) {
        tocList.textContent = '';
        const errDiv = document.createElement('div');
        errDiv.style.cssText = 'font-size:11px;color:var(--error);text-align:center;padding:8px';
        errDiv.textContent = 'Failed to load outline';
        tocList.appendChild(errDiv);
      }
    }

    // ===== Update Sidebar on Chapter Load =====
    function updateSidebar() {
      const sidebar = document.getElementById('context-sidebar');
      if (!sidebar) return;
      sidebar.style.display = 'flex';
      renderContextCard();
      // Check TOC cache
      const cache = getTocCache();
      const cacheKey = currentBookIndex + '-' + currentChapter;
      if (cache[cacheKey]) {
        renderToc(cache[cacheKey]);
      } else {
        renderToc(null); // show "Generate" button
      }
      renderNotesPanel();
    }

    // sidebar/highlights/notes are called from within the original loadChapter

    // ===== Life Application =====
    const LIFE_HISTORY_KEY = 'bible-life-app-history';
    const MAX_LIFE_HISTORY = 10;

    const LIFE_CATEGORIES = [
      { label: 'Anxiety', prompt: "I've been feeling really anxious about " },
      { label: 'Grief', prompt: "I'm grieving because " },
      { label: 'Relationships', prompt: "I'm struggling in my relationship with " },
      { label: 'Work & Career', prompt: "I'm facing a career decision about " },
      { label: 'Fear', prompt: "I'm afraid of " },
      { label: 'Loneliness', prompt: "I've been feeling lonely and " },
      { label: 'Doubt', prompt: "I'm struggling to believe that " },
      { label: 'Anger', prompt: "I'm angry because " },
      { label: 'Forgiveness', prompt: "I'm having trouble forgiving " },
      { label: 'Direction', prompt: "I don't know what to do about " },
      { label: 'Gratitude', prompt: "I want to grow in thankfulness for " },
      { label: 'Patience', prompt: "I'm finding it hard to wait for " },
    ];

    const lifeAppModal = document.getElementById('life-app-modal');
    const lifeAppBackdrop = document.getElementById('life-app-backdrop');
    const lifeAppTextarea = document.getElementById('life-app-textarea');
    const lifeAppSubmit = document.getElementById('life-app-submit');
    const lifeAppCharCount = document.getElementById('life-app-char-count');
    const lifeAppInputView = document.getElementById('life-app-input-view');
    const lifeAppLoading = document.getElementById('life-app-loading');
    const lifeAppResults = document.getElementById('life-app-results');
    const lifeAppCards = document.getElementById('life-app-cards');
    const lifeAppSituation = document.getElementById('life-app-situation');
    const lifeAppBack = document.getElementById('life-app-back');
    const closeLifeAppBtn = document.getElementById('close-life-app');
    let activeLifeCategory = null;

    function renderLifeCategories() {
      const container = document.getElementById('life-app-categories');
      container.textContent = '';
      LIFE_CATEGORIES.forEach(cat => {
        const chip = document.createElement('button');
        chip.className = 'life-app-chip';
        chip.textContent = cat.label;
        chip.addEventListener('click', () => {
          if (activeLifeCategory === cat.label) {
            activeLifeCategory = null;
            chip.classList.remove('active');
            lifeAppTextarea.value = '';
          } else {
            container.querySelectorAll('.life-app-chip').forEach(c => c.classList.remove('active'));
            activeLifeCategory = cat.label;
            chip.classList.add('active');
            lifeAppTextarea.value = cat.prompt;
            lifeAppTextarea.focus();
            lifeAppTextarea.selectionStart = lifeAppTextarea.value.length;
          }
          updateLifeAppSubmitState();
          updateLifeAppCharCount();
        });
        container.appendChild(chip);
      });
    }

    function openLifeApp() {
      lifeAppModal.classList.add('open');
      lifeAppBackdrop.classList.add('open');
      showLifeAppView('input');
      lifeAppTextarea.value = '';
      activeLifeCategory = null;
      renderLifeCategories();
      updateLifeAppSubmitState();
      updateLifeAppCharCount();
      setTimeout(() => lifeAppTextarea.focus(), 100);
    }

    function closeLifeApp() {
      lifeAppModal.classList.remove('open');
      lifeAppBackdrop.classList.remove('open');
    }

    function showLifeAppView(view) {
      lifeAppInputView.style.display = view === 'input' ? 'block' : 'none';
      lifeAppLoading.classList.toggle('hidden', view !== 'loading');
      lifeAppResults.classList.toggle('hidden', view !== 'results');
    }

    function updateLifeAppSubmitState() {
      lifeAppSubmit.disabled = lifeAppTextarea.value.trim().length < 10;
    }

    function updateLifeAppCharCount() {
      const len = lifeAppTextarea.value.length;
      lifeAppCharCount.textContent = len + '/500';
      lifeAppCharCount.style.color = len > 450 ? 'var(--error)' : 'var(--neutral-400)';
    }

    closeLifeAppBtn.addEventListener('click', closeLifeApp);
    lifeAppBackdrop.addEventListener('click', closeLifeApp);

    lifeAppTextarea.addEventListener('input', () => {
      updateLifeAppSubmitState();
      updateLifeAppCharCount();
    });

    lifeAppTextarea.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && (e.metaKey || e.ctrlKey)) {
        e.preventDefault();
        if (!lifeAppSubmit.disabled) submitLifeApp();
      }
      if (e.key === 'Escape') closeLifeApp();
    });

    lifeAppSubmit.addEventListener('click', submitLifeApp);

    lifeAppBack.addEventListener('click', () => {
      showLifeAppView('input');
      lifeAppTextarea.focus();
    });

    async function submitLifeApp() {
      const situation = lifeAppTextarea.value.trim();
      if (situation.length < 10) return;

      showLifeAppView('loading');

      try {
        const response = await fetch('/api/life-application', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ situation })
        });

        if (!response.ok) {
          const errMsg = await getResponseError(response, 'Failed to find passages');
          throw new Error(errMsg);
        }

        const data = await response.json();
        displayLifeAppResults(situation, data);
        saveLifeAppHistory(situation, data);
        fetchUsage();
      } catch (err) {
        showToast('Error: ' + err.message);
        showLifeAppView('input');
      }
    }

    function displayLifeAppResults(situation, data) {
      lifeAppSituation.textContent = '\u201C' + situation + '\u201D';
      lifeAppCards.textContent = '';

      data.passages.forEach((passage, i) => {
        const card = document.createElement('div');
        card.className = 'life-app-card';
        card.style.animationDelay = (i * 0.1) + 's';

        const refEl = document.createElement('div');
        refEl.className = 'life-app-card-ref';
        refEl.textContent = passage.reference;
        card.appendChild(refEl);

        const textEl = document.createElement('div');
        textEl.className = 'life-app-card-text';
        textEl.textContent = passage.verseText;
        card.appendChild(textEl);

        const insightEl = document.createElement('div');
        insightEl.className = 'life-app-card-insight';
        insightEl.textContent = passage.connection;
        card.appendChild(insightEl);

        if (passage.greekHebrew) {
          const ghEl = document.createElement('div');
          ghEl.className = 'life-app-card-greek';
          const strong = document.createElement('strong');
          strong.textContent = passage.greekHebrew.language + ':';
          const em = document.createElement('em');
          em.textContent = ' ' + passage.greekHebrew.word;
          ghEl.appendChild(strong);
          ghEl.appendChild(em);
          ghEl.appendChild(document.createTextNode(
            ' (' + passage.greekHebrew.transliteration + ') \u2014 ' + passage.greekHebrew.insight
          ));
          card.appendChild(ghEl);
        }

        const readBtn = document.createElement('button');
        readBtn.className = 'life-app-card-read';
        const bookSvg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
        bookSvg.setAttribute('fill', 'none');
        bookSvg.setAttribute('stroke', 'currentColor');
        bookSvg.setAttribute('viewBox', '0 0 24 24');
        const bookPath = document.createElementNS('http://www.w3.org/2000/svg', 'path');
        bookPath.setAttribute('stroke-linecap', 'round');
        bookPath.setAttribute('stroke-linejoin', 'round');
        bookPath.setAttribute('stroke-width', '2');
        bookPath.setAttribute('d', 'M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253');
        bookSvg.appendChild(bookPath);
        readBtn.appendChild(bookSvg);
        readBtn.appendChild(document.createTextNode(' Read in context'));
        readBtn.addEventListener('click', () => navigateToPassage(passage));
        card.appendChild(readBtn);

        lifeAppCards.appendChild(card);
      });

      if (data.encouragement) {
        const encEl = document.createElement('div');
        encEl.style.cssText =
          'padding: var(--space-4) var(--space-5); text-align: center; font-size: var(--text-sm); color: var(--neutral-500); font-style: italic; border-top: 1px solid var(--neutral-100); margin-top: var(--space-2);';
        encEl.textContent = data.encouragement;
        lifeAppCards.appendChild(encEl);
      }

      showLifeAppView('results');
    }

    function navigateToPassage(passage) {
      const bookName = passage.book;
      const bookIndex = BOOKS.findIndex(b =>
        b.name.toLowerCase() === bookName.toLowerCase()
      );

      if (bookIndex === -1) {
        showToast('Could not find book: ' + bookName);
        return;
      }

      closeLifeApp();
      if (typeof closeDrawer === 'function') closeDrawer();

      bookSelect.value = bookIndex;
      bookSelect.dispatchEvent(new Event('change'));
      chapterSelect.value = passage.chapter;

      loadChapter().then(() => {
        setTimeout(() => {
          selectedVerses.clear();
          const start = passage.startVerse;
          const end = passage.endVerse || passage.startVerse;
          for (let v = start; v <= end; v++) {
            selectedVerses.add(v);
          }
          syncVerseSelectionUI();
          updateFab();

          const firstVerse = document.querySelector('.verse[data-verse="' + start + '"]');
          if (firstVerse) {
            firstVerse.scrollIntoView({ behavior: 'smooth', block: 'center' });
          }
        }, 300);
      });
    }

    function getLifeAppHistory() {
      return DataStore.getLifeAppHistory();
    }

    function saveLifeAppHistory(situation, data) {
      const history = getLifeAppHistory();
      history.unshift({ situation, data, timestamp: Date.now() });
      if (history.length > MAX_LIFE_HISTORY) history.length = MAX_LIFE_HISTORY;
      DataStore.saveLifeAppHistoryArr(history);
    }

    // ===== Prayer Journal =====
    const PRAYERS_KEY = 'bible-prayers';
    let prayerFilter = 'all';
    let notesTabPrayers;

    function getPrayers() {
      return DataStore.getPrayers();
    }

    function savePrayers(prayers) {
      DataStore.savePrayers(prayers);
    }

    function addPrayer(verseNum, text) {
      const prayers = getPrayers();
      prayers.unshift({
        id: Date.now().toString(36) + Math.random().toString(36).slice(2, 6),
        text: text,
        bookIndex: currentBookIndex,
        chapter: currentChapter,
        verse: verseNum,
        reference: BOOKS[currentBookIndex].name + ' ' + currentChapter + ':' + verseNum,
        date: new Date().toISOString(),
        answered: false
      });
      savePrayers(prayers);
    }

    function togglePrayerAnswered(id) {
      const prayers = getPrayers();
      const prayer = prayers.find(p => p.id === id);
      if (prayer) {
        prayer.answered = !prayer.answered;
        savePrayers(prayers);
      }
    }

    function deletePrayer(id) {
      const prayers = getPrayers().filter(p => p.id !== id);
      savePrayers(prayers);
    }

    // Sidebar prayers tab
    function initPrayerTab() {
      notesTabPrayers = document.getElementById('notes-tab-prayers');
      if (!notesTabPrayers) return;

      notesTabPrayers.addEventListener('click', () => {
        notesViewMode = 'prayers';
        notesTabChapter.classList.remove('active');
        notesTabAll.classList.remove('active');
        notesTabPrayers.classList.add('active');
        renderNotesPanel();
      });
    }

    // Override renderNotesPanel to handle prayers mode
    const _origRenderNotesPanel = renderNotesPanel;
    renderNotesPanel = function() {
      if (notesViewMode === 'prayers') {
        renderPrayersSidebar();
      } else {
        if (notesTabPrayers) notesTabPrayers.classList.remove('active');
        _origRenderNotesPanel();
      }
    };

    function renderPrayersSidebar() {
      const notesList = document.getElementById('notes-list');
      if (!notesList) return;
      notesList.textContent = '';

      const prayers = getPrayers();
      const prefix = currentBookIndex + '-' + currentChapter;
      const chapterPrayers = prayers.filter(p =>
        p.bookIndex === currentBookIndex && p.chapter === currentChapter
      );

      if (chapterPrayers.length === 0) {
        const empty = document.createElement('div');
        empty.className = 'notes-empty';
        empty.textContent = 'Double-click a verse to add a prayer';
        notesList.appendChild(empty);
        return;
      }

      chapterPrayers.forEach(p => {
        const item = document.createElement('div');
        item.className = 'prayer-item' + (p.answered ? ' answered' : '');

        const header = document.createElement('div');
        header.className = 'prayer-item-header';

        const check = document.createElement('span');
        check.className = 'prayer-answered-check' + (p.answered ? ' checked' : '');
        check.textContent = p.answered ? '\u2713' : '';
        check.title = p.answered ? 'Mark as active' : 'Mark as answered';
        check.addEventListener('click', (e) => {
          e.stopPropagation();
          togglePrayerAnswered(p.id);
          renderPrayersSidebar();
        });
        header.appendChild(check);

        const vEl = document.createElement('span');
        vEl.className = 'prayer-item-verse';
        vEl.textContent = 'v.' + p.verse;
        header.appendChild(vEl);

        item.appendChild(header);

        const tEl = document.createElement('div');
        tEl.className = 'prayer-item-text';
        tEl.textContent = p.text;
        item.appendChild(tEl);

        item.addEventListener('click', () => {
          const verseEl = document.querySelector('.verse[data-verse="' + p.verse + '"]');
          if (verseEl) verseEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
        });

        notesList.appendChild(item);
      });
    }

    // Extend note editor to support prayer mode
    const _origOpenNoteEditor = openNoteEditor;
    openNoteEditor = function(verseNum) {
      closeNoteEditor();
      const verseEl = document.querySelector('.verse[data-verse="' + verseNum + '"]');
      if (!verseEl) return;

      const notes = getNotes();
      const key = noteKey(verseNum);
      const existingNote = notes[key] || '';
      let editorMode = 'note';

      const editor = document.createElement('div');
      editor.className = 'note-editor-inline';
      editor.dataset.noteVerse = verseNum;

      // Mode toggle
      const toggle = document.createElement('div');
      toggle.className = 'prayer-editor-toggle';
      const noteBtn = document.createElement('button');
      noteBtn.textContent = 'Note';
      noteBtn.className = 'active';
      const prayerBtn = document.createElement('button');
      prayerBtn.textContent = 'Prayer';
      toggle.appendChild(noteBtn);
      toggle.appendChild(prayerBtn);
      editor.appendChild(toggle);

      const ta = document.createElement('textarea');
      ta.value = existingNote;
      ta.placeholder = 'Add a note for verse ' + verseNum + '...';
      editor.appendChild(ta);

      noteBtn.addEventListener('click', () => {
        editorMode = 'note';
        noteBtn.classList.add('active');
        prayerBtn.classList.remove('active');
        ta.placeholder = 'Add a note for verse ' + verseNum + '...';
      });
      prayerBtn.addEventListener('click', () => {
        editorMode = 'prayer';
        prayerBtn.classList.add('active');
        noteBtn.classList.remove('active');
        ta.placeholder = 'Write a prayer for verse ' + verseNum + '...';
        ta.value = '';
      });

      const actions = document.createElement('div');
      actions.className = 'note-editor-actions';

      if (existingNote) {
        const delBtn = document.createElement('button');
        delBtn.className = 'note-delete-btn';
        delBtn.textContent = 'Delete';
        delBtn.addEventListener('click', () => {
          delete notes[key];
          saveNotes(notes);
          closeNoteEditor();
          refreshNoteIndicators();
          renderNotesPanel();
          showToast('Note deleted');
        });
        actions.appendChild(delBtn);
      }

      const cancelBtn = document.createElement('button');
      cancelBtn.textContent = 'Cancel';
      cancelBtn.addEventListener('click', closeNoteEditor);
      actions.appendChild(cancelBtn);

      const saveBtn = document.createElement('button');
      saveBtn.className = 'note-save-btn';
      saveBtn.textContent = 'Save';
      saveBtn.addEventListener('click', () => {
        const text = ta.value.trim();
        if (!text) {
          closeNoteEditor();
          return;
        }

        if (editorMode === 'prayer') {
          addPrayer(verseNum, text);
          showToast('Prayer saved');
        } else {
          notes[key] = text;
          saveNotes(notes);
          showToast('Note saved');
        }
        closeNoteEditor();
        refreshNoteIndicators();
        renderNotesPanel();
      });
      actions.appendChild(saveBtn);
      editor.appendChild(actions);

      verseEl.insertAdjacentElement('afterend', editor);
      activeNoteEditor = editor;
      ta.focus();
    };

    // Prayer Journal full view (modal)
    const prayerJournalModal = document.getElementById('prayer-journal-modal');
    const prayerJournalBackdrop = document.getElementById('prayer-journal-backdrop');
    const prayerJournalList = document.getElementById('prayer-journal-list');
    const closePrayerJournalBtn = document.getElementById('close-prayer-journal');

    function openPrayerJournal() {
      prayerJournalModal.classList.add('open');
      prayerJournalBackdrop.classList.add('open');
      renderPrayerJournalFull();
    }

    function closePrayerJournal() {
      prayerJournalModal.classList.remove('open');
      prayerJournalBackdrop.classList.remove('open');
    }

    closePrayerJournalBtn.addEventListener('click', closePrayerJournal);
    prayerJournalBackdrop.addEventListener('click', closePrayerJournal);

    // Filter buttons
    document.querySelectorAll('.prayer-filter-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.prayer-filter-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        prayerFilter = btn.dataset.filter;
        renderPrayerJournalFull();
      });
    });

    function renderPrayerJournalFull() {
      prayerJournalList.textContent = '';
      let prayers = getPrayers();

      if (prayerFilter === 'active') prayers = prayers.filter(p => !p.answered);
      else if (prayerFilter === 'answered') prayers = prayers.filter(p => p.answered);

      if (prayers.length === 0) {
        const empty = document.createElement('div');
        empty.className = 'notes-empty';
        empty.style.padding = 'var(--space-8) 0';
        empty.textContent = prayerFilter === 'all' ? 'No prayers yet. Double-click a verse to add one.' :
          prayerFilter === 'active' ? 'No active prayers' : 'No answered prayers';
        prayerJournalList.appendChild(empty);
        return;
      }

      prayers.forEach(p => {
        const item = document.createElement('div');
        item.className = 'prayer-full-item' + (p.answered ? ' answered' : '');

        const header = document.createElement('div');
        header.className = 'prayer-full-item-header';

        const ref = document.createElement('span');
        ref.className = 'prayer-full-item-ref';
        ref.textContent = p.reference;
        ref.addEventListener('click', () => {
          closePrayerJournal();
          navigateToPassage({
            book: BOOKS[p.bookIndex] ? BOOKS[p.bookIndex].name : '',
            chapter: p.chapter,
            startVerse: p.verse,
            endVerse: p.verse
          });
        });
        header.appendChild(ref);

        const date = document.createElement('span');
        date.className = 'prayer-full-item-date';
        const d = new Date(p.date);
        date.textContent = d.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
        header.appendChild(date);
        item.appendChild(header);

        const text = document.createElement('div');
        text.className = 'prayer-full-item-text';
        text.textContent = p.text;
        item.appendChild(text);

        const actionsDiv = document.createElement('div');
        actionsDiv.className = 'prayer-full-actions';

        const answerBtn = document.createElement('button');
        answerBtn.textContent = p.answered ? 'Mark Active' : 'Mark Answered';
        answerBtn.addEventListener('click', () => {
          togglePrayerAnswered(p.id);
          renderPrayerJournalFull();
          renderNotesPanel();
        });
        actionsDiv.appendChild(answerBtn);

        const delBtn = document.createElement('button');
        delBtn.className = 'prayer-delete-btn';
        delBtn.textContent = 'Delete';
        delBtn.addEventListener('click', () => {
          deletePrayer(p.id);
          renderPrayerJournalFull();
          renderNotesPanel();
          showToast('Prayer deleted');
        });
        actionsDiv.appendChild(delBtn);

        item.appendChild(actionsDiv);
        prayerJournalList.appendChild(item);
      });
    }

    initPrayerTab();

    // ===== Topical Browse =====
    const TOPICAL_TOPICS = [
      'Love', 'Faith', 'Hope', 'Suffering', 'Wisdom', 'Forgiveness',
      'Prayer', 'Courage', 'Peace', 'Joy', 'Justice', 'Mercy',
      'Grace', 'Salvation', 'Holiness', 'Humility', 'Trust', 'Patience',
      'Community', 'Rest'
    ];
    const TOPICAL_CACHE_KEY = 'bible-topical-cache';

    const topicalModal = document.getElementById('topical-modal');
    const topicalBackdrop = document.getElementById('topical-backdrop');
    const topicalTopicsEl = document.getElementById('topical-topics');
    const topicalInputView = document.getElementById('topical-input-view');
    const topicalLoading = document.getElementById('topical-loading');
    const topicalResults = document.getElementById('topical-results');
    const topicalDescription = document.getElementById('topical-description');
    const topicalCards = document.getElementById('topical-cards');
    const topicalCustomInput = document.getElementById('topical-custom-input');
    const topicalCustomBtn = document.getElementById('topical-custom-btn');
    const closeTopicalBtn = document.getElementById('close-topical');
    const topicalBackBtn = document.getElementById('topical-back');

    function getTopicalCache() {
      try { return JSON.parse(localStorage.getItem(TOPICAL_CACHE_KEY) || '{}'); } catch { return {}; }
    }

    function saveTopicalCache(cache) {
      localStorage.setItem(TOPICAL_CACHE_KEY, JSON.stringify(cache));
    }

    function renderTopicChips() {
      topicalTopicsEl.textContent = '';
      TOPICAL_TOPICS.forEach(topic => {
        const chip = document.createElement('button');
        chip.className = 'topical-chip';
        chip.textContent = topic;
        chip.addEventListener('click', () => submitTopical(topic));
        topicalTopicsEl.appendChild(chip);
      });
    }

    function openTopicalBrowse() {
      topicalModal.classList.add('open');
      topicalBackdrop.classList.add('open');
      showTopicalView('input');
      renderTopicChips();
      topicalCustomInput.value = '';
      topicalCustomBtn.disabled = true;
    }

    function closeTopicalBrowse() {
      topicalModal.classList.remove('open');
      topicalBackdrop.classList.remove('open');
    }

    function showTopicalView(view) {
      topicalInputView.classList.toggle('hidden', view !== 'input');
      topicalLoading.classList.toggle('hidden', view !== 'loading');
      topicalResults.classList.toggle('hidden', view !== 'results');
    }

    async function submitTopical(topic) {
      const cache = getTopicalCache();
      if (cache[topic.toLowerCase()]) {
        displayTopicalResults(cache[topic.toLowerCase()]);
        return;
      }

      showTopicalView('loading');

      try {
        const resp = await fetch('/api/topical', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ topic })
        });

        if (!resp.ok) {
          const err = await resp.json().catch(() => ({ error: 'Request failed' }));
          throw new Error(err.error || 'Failed to fetch passages');
        }

        const data = await resp.json();
        cache[topic.toLowerCase()] = data;
        saveTopicalCache(cache);
        displayTopicalResults(data);
      } catch (err) {
        showToast(err.message || 'Something went wrong');
        showTopicalView('input');
      }
    }

    function displayTopicalResults(data) {
      topicalCards.textContent = '';
      topicalDescription.textContent = data.description || '';
      showTopicalView('results');

      if (!data.passages || data.passages.length === 0) {
        const empty = document.createElement('div');
        empty.className = 'notes-empty';
        empty.textContent = 'No passages found for this topic.';
        topicalCards.appendChild(empty);
        return;
      }

      data.passages.forEach((passage, i) => {
        const card = document.createElement('div');
        card.className = 'topical-card';
        card.style.animationDelay = (i * 0.08) + 's';

        const ref = document.createElement('div');
        ref.className = 'topical-card-ref';
        ref.textContent = passage.reference;
        card.appendChild(ref);

        if (passage.keyVerse) {
          const verse = document.createElement('div');
          verse.className = 'topical-card-verse';
          verse.textContent = passage.keyVerse;
          card.appendChild(verse);
        }

        if (passage.summary) {
          const summary = document.createElement('div');
          summary.className = 'topical-card-summary';
          summary.textContent = passage.summary;
          card.appendChild(summary);
        }

        const readBtn = document.createElement('button');
        readBtn.className = 'life-app-card-read';
        const bookSvg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
        bookSvg.setAttribute('fill', 'none');
        bookSvg.setAttribute('stroke', 'currentColor');
        bookSvg.setAttribute('viewBox', '0 0 24 24');
        const bookPath = document.createElementNS('http://www.w3.org/2000/svg', 'path');
        bookPath.setAttribute('stroke-linecap', 'round');
        bookPath.setAttribute('stroke-linejoin', 'round');
        bookPath.setAttribute('stroke-width', '2');
        bookPath.setAttribute('d', 'M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253');
        bookSvg.appendChild(bookPath);
        readBtn.appendChild(bookSvg);
        readBtn.appendChild(document.createTextNode(' Read in context'));
        readBtn.addEventListener('click', () => {
          closeTopicalBrowse();
          navigateToPassage(passage);
        });
        card.appendChild(readBtn);

        topicalCards.appendChild(card);
      });
    }

    // Event listeners
    closeTopicalBtn.addEventListener('click', closeTopicalBrowse);
    topicalBackdrop.addEventListener('click', closeTopicalBrowse);
    topicalBackBtn.addEventListener('click', () => showTopicalView('input'));

    topicalCustomInput.addEventListener('input', () => {
      topicalCustomBtn.disabled = topicalCustomInput.value.trim().length < 2;
    });

    topicalCustomInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && topicalCustomInput.value.trim().length >= 2) {
        submitTopical(topicalCustomInput.value.trim());
      }
    });

    topicalCustomBtn.addEventListener('click', () => {
      const val = topicalCustomInput.value.trim();
      if (val.length >= 2) submitTopical(val);
    });

    // ===== Daily Devotional =====
    const DEVOTIONAL_SEEN_KEY = 'bible-devotional-last-seen';
    const DEVOTIONAL_CACHE_KEY = 'bible-devotional-cache';
    let devotionalData = null;

    function getDevotionalCache() {
      try { return JSON.parse(localStorage.getItem(DEVOTIONAL_CACHE_KEY) || '{}'); } catch { return {}; }
    }

    function saveDevotionalCache(cache) {
      localStorage.setItem(DEVOTIONAL_CACHE_KEY, JSON.stringify(cache));
    }

    async function fetchDailyDevotional() {
      const today = new Date().toISOString().split('T')[0];
      const cache = getDevotionalCache();
      if (cache[today]) {
        devotionalData = cache[today];
        return devotionalData;
      }

      const resp = await fetch('/api/daily-devotional', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({})
      });

      if (!resp.ok) throw new Error('Failed to fetch devotional');
      const data = await resp.json();
      devotionalData = data;
      cache[today] = data;
      // Keep only last 3 days in localStorage
      const keys = Object.keys(cache).sort();
      while (keys.length > 3) {
        delete cache[keys.shift()];
      }
      saveDevotionalCache(cache);
      return data;
    }

    function renderDevotionalCard(data) {
      const card = document.createElement('div');
      card.className = 'devotional-card';
      card.id = 'devotional-card';

      const d = new Date(data.date + 'T12:00:00');
      const dateStr = d.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric', year: 'numeric' });

      card.innerHTML = '';

      // Header
      const header = document.createElement('div');
      header.className = 'devotional-card-header';
      const dateEl = document.createElement('div');
      dateEl.className = 'devotional-card-date';
      dateEl.textContent = 'Daily Devotional \u2022 ' + dateStr;
      header.appendChild(dateEl);
      const titleEl = document.createElement('div');
      titleEl.className = 'devotional-card-title';
      titleEl.textContent = data.verse.reference;
      header.appendChild(titleEl);
      card.appendChild(header);

      // Body
      const body = document.createElement('div');
      body.className = 'devotional-card-body';

      const verseText = document.createElement('div');
      verseText.className = 'devotional-verse-text';
      verseText.textContent = data.verse.text;
      body.appendChild(verseText);

      const reflection = document.createElement('div');
      reflection.className = 'devotional-reflection';
      reflection.textContent = data.reflection;
      body.appendChild(reflection);

      if (data.originalLanguageInsight) {
        const langBox = document.createElement('div');
        langBox.className = 'devotional-language-box';
        const wordEl = document.createElement('div');
        wordEl.className = 'devotional-language-word';
        wordEl.textContent = data.originalLanguageInsight.word;
        langBox.appendChild(wordEl);
        const detailEl = document.createElement('div');
        detailEl.className = 'devotional-language-detail';
        detailEl.innerHTML = '<strong>' + data.originalLanguageInsight.transliteration + '</strong> (' + data.originalLanguageInsight.language + ')<br>' + data.originalLanguageInsight.insight;
        langBox.appendChild(detailEl);
        body.appendChild(langBox);
      }

      if (data.applicationThought) {
        const appEl = document.createElement('div');
        appEl.className = 'devotional-application';
        appEl.textContent = data.applicationThought;
        body.appendChild(appEl);
      }

      card.appendChild(body);

      // Actions
      const actions = document.createElement('div');
      actions.className = 'devotional-card-actions';

      const readBtn = document.createElement('button');
      readBtn.className = 'devotional-read-btn';
      readBtn.textContent = 'Read in Context';
      readBtn.addEventListener('click', () => {
        dismissDevotional();
        navigateToPassage(data.verse);
      });
      actions.appendChild(readBtn);

      const dismissBtn = document.createElement('button');
      dismissBtn.className = 'devotional-dismiss-btn';
      dismissBtn.textContent = 'Start Reading';
      dismissBtn.addEventListener('click', dismissDevotional);
      actions.appendChild(dismissBtn);

      card.appendChild(actions);
      return card;
    }

    function showDevotionalOnLoad(data) {
      const instructions = document.getElementById('instructions');
      if (!instructions || instructions.style.display === 'none') return;

      instructions.style.display = 'none';
      const card = renderDevotionalCard(data);
      instructions.parentNode.insertBefore(card, instructions.nextSibling);
    }

    function dismissDevotional() {
      const card = document.getElementById('devotional-card');
      if (card) card.remove();
      const instructions = document.getElementById('instructions');
      if (instructions && !document.getElementById('chapter-header').style.display !== 'none') {
        instructions.style.display = '';
      }
      localStorage.setItem(DEVOTIONAL_SEEN_KEY, new Date().toISOString().split('T')[0]);
    }

    function openDailyDevotional() {
      // Show devotional from drawer  fetch and display
      if (devotionalData) {
        showDevotionalInModal(devotionalData);
        return;
      }
      showToast('Loading devotional...');
      fetchDailyDevotional().then(data => {
        showDevotionalInModal(data);
      }).catch(() => showToast('Could not load devotional'));
    }

    function showDevotionalInModal(data) {
      // Reuse instructions area if no chapter is loaded, otherwise replace content
      const instructions = document.getElementById('instructions');
      const chapterHeader = document.getElementById('chapter-header');
      const existingCard = document.getElementById('devotional-card');
      if (existingCard) existingCard.remove();

      if (chapterHeader && chapterHeader.style.display !== 'none') {
        // A chapter is loaded  scroll to top and show card above verses
        const card = renderDevotionalCard(data);
        const versesContainer = document.getElementById('verses-container');
        versesContainer.parentNode.insertBefore(card, versesContainer);
        card.scrollIntoView({ behavior: 'smooth', block: 'start' });
      } else {
        // No chapter loaded  show in instructions area
        showDevotionalOnLoad(data);
      }
    }

    // Auto-show devotional on first visit of the day
    (function checkDailyDevotional() {
      const today = new Date().toISOString().split('T')[0];
      const lastSeen = localStorage.getItem(DEVOTIONAL_SEEN_KEY);
      if (lastSeen === today) return;

      fetchDailyDevotional()
        .then(data => showDevotionalOnLoad(data))
        .catch(() => {}); // silently fail
    })();

    // ===== Reading Plans =====
    const PLANS_KEY = 'bible-reading-plans';
    const ACTIVE_PLAN_KEY = 'bible-active-plan';
    const STREAK_KEY = 'bible-reading-streak';

    const READING_PLANS = [
      {
        id: 'gospels-40',
        title: 'Gospels in 40 Days',
        description: 'Walk through the life of Jesus by reading all four Gospels in 40 days.',
        duration: 40,
        readings: [
          { ref: 'Matthew 1-2', book: 'Matthew', chapter: 1, startVerse: 1, endVerse: 25, title: 'The Birth of Jesus' },
          { ref: 'Matthew 3-4', book: 'Matthew', chapter: 3, startVerse: 1, endVerse: 17, title: 'Baptism & Temptation' },
          { ref: 'Matthew 5-6', book: 'Matthew', chapter: 5, startVerse: 1, endVerse: 48, title: 'Sermon on the Mount (Part 1)' },
          { ref: 'Matthew 7-8', book: 'Matthew', chapter: 7, startVerse: 1, endVerse: 29, title: 'Sermon on the Mount (Part 2)' },
          { ref: 'Matthew 9-10', book: 'Matthew', chapter: 9, startVerse: 1, endVerse: 38, title: 'Healing & Sending the Twelve' },
          { ref: 'Matthew 11-12', book: 'Matthew', chapter: 11, startVerse: 1, endVerse: 30, title: 'Jesus and John the Baptist' },
          { ref: 'Matthew 13-14', book: 'Matthew', chapter: 13, startVerse: 1, endVerse: 58, title: 'Kingdom Parables' },
          { ref: 'Matthew 15-17', book: 'Matthew', chapter: 16, startVerse: 13, endVerse: 28, title: 'Peter\'s Confession & Transfiguration' },
          { ref: 'Matthew 18-20', book: 'Matthew', chapter: 18, startVerse: 1, endVerse: 35, title: 'Forgiveness & the Kingdom' },
          { ref: 'Matthew 21-23', book: 'Matthew', chapter: 21, startVerse: 1, endVerse: 22, title: 'Triumphal Entry' },
          { ref: 'Matthew 24-25', book: 'Matthew', chapter: 25, startVerse: 31, endVerse: 46, title: 'End Times Teaching' },
          { ref: 'Matthew 26-28', book: 'Matthew', chapter: 28, startVerse: 1, endVerse: 20, title: 'Crucifixion & Resurrection' },
          { ref: 'Mark 1-2', book: 'Mark', chapter: 1, startVerse: 1, endVerse: 45, title: 'Jesus Begins His Ministry' },
          { ref: 'Mark 3-4', book: 'Mark', chapter: 4, startVerse: 35, endVerse: 41, title: 'Calming the Storm' },
          { ref: 'Mark 5-6', book: 'Mark', chapter: 5, startVerse: 21, endVerse: 43, title: 'Jairus\' Daughter & Feeding 5000' },
          { ref: 'Mark 7-8', book: 'Mark', chapter: 8, startVerse: 27, endVerse: 38, title: 'Who Do You Say I Am?' },
          { ref: 'Mark 9-10', book: 'Mark', chapter: 10, startVerse: 17, endVerse: 31, title: 'Rich Young Ruler' },
          { ref: 'Mark 11-13', book: 'Mark', chapter: 12, startVerse: 28, endVerse: 34, title: 'Greatest Commandment' },
          { ref: 'Mark 14-16', book: 'Mark', chapter: 16, startVerse: 1, endVerse: 8, title: 'Mark\'s Passion & Resurrection' },
          { ref: 'Luke 1-2', book: 'Luke', chapter: 2, startVerse: 1, endVerse: 20, title: 'The Birth Narrative' },
          { ref: 'Luke 3-4', book: 'Luke', chapter: 4, startVerse: 14, endVerse: 30, title: 'Jesus in Nazareth' },
          { ref: 'Luke 5-6', book: 'Luke', chapter: 6, startVerse: 20, endVerse: 49, title: 'Sermon on the Plain' },
          { ref: 'Luke 7-8', book: 'Luke', chapter: 7, startVerse: 36, endVerse: 50, title: 'The Sinful Woman Anoints Jesus' },
          { ref: 'Luke 9-10', book: 'Luke', chapter: 10, startVerse: 25, endVerse: 37, title: 'Good Samaritan' },
          { ref: 'Luke 11-12', book: 'Luke', chapter: 12, startVerse: 22, endVerse: 34, title: 'Do Not Worry' },
          { ref: 'Luke 13-14', book: 'Luke', chapter: 14, startVerse: 15, endVerse: 35, title: 'Cost of Discipleship' },
          { ref: 'Luke 15-16', book: 'Luke', chapter: 15, startVerse: 11, endVerse: 32, title: 'The Prodigal Son' },
          { ref: 'Luke 17-18', book: 'Luke', chapter: 18, startVerse: 1, endVerse: 14, title: 'Persistent Prayer' },
          { ref: 'Luke 19-20', book: 'Luke', chapter: 19, startVerse: 1, endVerse: 10, title: 'Zacchaeus' },
          { ref: 'Luke 21-22', book: 'Luke', chapter: 22, startVerse: 39, endVerse: 53, title: 'Garden of Gethsemane' },
          { ref: 'Luke 23-24', book: 'Luke', chapter: 24, startVerse: 13, endVerse: 35, title: 'Road to Emmaus' },
          { ref: 'John 1-2', book: 'John', chapter: 1, startVerse: 1, endVerse: 18, title: 'The Word Became Flesh' },
          { ref: 'John 3-4', book: 'John', chapter: 3, startVerse: 1, endVerse: 21, title: 'Nicodemus & Living Water' },
          { ref: 'John 5-6', book: 'John', chapter: 6, startVerse: 25, endVerse: 59, title: 'Bread of Life' },
          { ref: 'John 7-8', book: 'John', chapter: 8, startVerse: 1, endVerse: 11, title: 'Light of the World' },
          { ref: 'John 9-10', book: 'John', chapter: 10, startVerse: 1, endVerse: 18, title: 'The Good Shepherd' },
          { ref: 'John 11-12', book: 'John', chapter: 11, startVerse: 1, endVerse: 44, title: 'Raising Lazarus' },
          { ref: 'John 13-15', book: 'John', chapter: 15, startVerse: 1, endVerse: 17, title: 'The Vine & Farewell' },
          { ref: 'John 16-18', book: 'John', chapter: 17, startVerse: 1, endVerse: 26, title: 'Jesus\' High Priestly Prayer' },
          { ref: 'John 19-21', book: 'John', chapter: 21, startVerse: 1, endVerse: 25, title: 'Crucifixion & Restoration of Peter' },
        ]
      },
      {
        id: 'psalms-proverbs',
        title: 'Psalms & Proverbs',
        description: 'Read through the wisdom literature  one Psalm or Proverb chapter each day for 61 days.',
        duration: 61,
        readings: Array.from({ length: 31 }, (_, i) => ({
          ref: 'Proverbs ' + (i + 1), book: 'Proverbs', chapter: i + 1, startVerse: 1, endVerse: 1,
          title: 'Proverbs ' + (i + 1)
        })).concat(Array.from({ length: 30 }, (_, i) => ({
          ref: 'Psalm ' + (i * 5 + 1) + '-' + (i * 5 + 5), book: 'Psalms', chapter: i * 5 + 1, startVerse: 1, endVerse: 1,
          title: 'Psalms ' + (i * 5 + 1) + '\u2013' + (i * 5 + 5)
        })))
      },
      {
        id: 'pauls-letters',
        title: 'Paul\'s Letters',
        description: 'Explore the apostle Paul\'s letters to the early churches  one reading each day for 30 days.',
        duration: 30,
        readings: [
          { ref: 'Romans 1-2', book: 'Romans', chapter: 1, startVerse: 1, endVerse: 32, title: 'The Gospel\'s Power' },
          { ref: 'Romans 3-4', book: 'Romans', chapter: 3, startVerse: 21, endVerse: 31, title: 'Righteousness by Faith' },
          { ref: 'Romans 5-6', book: 'Romans', chapter: 5, startVerse: 1, endVerse: 21, title: 'Peace with God' },
          { ref: 'Romans 7-8', book: 'Romans', chapter: 8, startVerse: 1, endVerse: 39, title: 'Life in the Spirit' },
          { ref: 'Romans 9-11', book: 'Romans', chapter: 11, startVerse: 33, endVerse: 36, title: 'God\'s Sovereign Plan' },
          { ref: 'Romans 12-14', book: 'Romans', chapter: 12, startVerse: 1, endVerse: 21, title: 'Living Sacrifice' },
          { ref: 'Romans 15-16', book: 'Romans', chapter: 15, startVerse: 1, endVerse: 13, title: 'Unity & Greetings' },
          { ref: '1 Corinthians 1-3', book: '1 Corinthians', chapter: 1, startVerse: 18, endVerse: 31, title: 'Wisdom of the Cross' },
          { ref: '1 Corinthians 4-7', book: '1 Corinthians', chapter: 6, startVerse: 12, endVerse: 20, title: 'Temple of the Spirit' },
          { ref: '1 Corinthians 8-10', book: '1 Corinthians', chapter: 10, startVerse: 1, endVerse: 13, title: 'Freedom & Responsibility' },
          { ref: '1 Corinthians 11-13', book: '1 Corinthians', chapter: 13, startVerse: 1, endVerse: 13, title: 'The Love Chapter' },
          { ref: '1 Corinthians 14-16', book: '1 Corinthians', chapter: 15, startVerse: 1, endVerse: 28, title: 'The Resurrection' },
          { ref: '2 Corinthians 1-4', book: '2 Corinthians', chapter: 4, startVerse: 1, endVerse: 18, title: 'Treasure in Jars of Clay' },
          { ref: '2 Corinthians 5-9', book: '2 Corinthians', chapter: 5, startVerse: 14, endVerse: 21, title: 'Ministry of Reconciliation' },
          { ref: '2 Corinthians 10-13', book: '2 Corinthians', chapter: 12, startVerse: 1, endVerse: 10, title: 'Strength in Weakness' },
          { ref: 'Galatians 1-3', book: 'Galatians', chapter: 2, startVerse: 15, endVerse: 21, title: 'Justified by Faith' },
          { ref: 'Galatians 4-6', book: 'Galatians', chapter: 5, startVerse: 16, endVerse: 26, title: 'Fruit of the Spirit' },
          { ref: 'Ephesians 1-3', book: 'Ephesians', chapter: 2, startVerse: 1, endVerse: 10, title: 'Saved by Grace' },
          { ref: 'Ephesians 4-6', book: 'Ephesians', chapter: 6, startVerse: 10, endVerse: 20, title: 'Armor of God' },
          { ref: 'Philippians 1-2', book: 'Philippians', chapter: 2, startVerse: 1, endVerse: 18, title: 'Christ\'s Humility' },
          { ref: 'Philippians 3-4', book: 'Philippians', chapter: 4, startVerse: 4, endVerse: 13, title: 'Rejoice in the Lord' },
          { ref: 'Colossians 1-2', book: 'Colossians', chapter: 1, startVerse: 15, endVerse: 23, title: 'Supremacy of Christ' },
          { ref: 'Colossians 3-4', book: 'Colossians', chapter: 3, startVerse: 1, endVerse: 17, title: 'New Self in Christ' },
          { ref: '1 Thessalonians', book: '1 Thessalonians', chapter: 4, startVerse: 13, endVerse: 18, title: 'The Lord\'s Return' },
          { ref: '2 Thessalonians', book: '2 Thessalonians', chapter: 2, startVerse: 1, endVerse: 12, title: 'Stand Firm' },
          { ref: '1 Timothy', book: '1 Timothy', chapter: 6, startVerse: 6, endVerse: 19, title: 'Godliness & Contentment' },
          { ref: '2 Timothy', book: '2 Timothy', chapter: 2, startVerse: 1, endVerse: 13, title: 'Endure as a Soldier' },
          { ref: 'Titus & Philemon', book: 'Titus', chapter: 3, startVerse: 3, endVerse: 8, title: 'Saved by Mercy' },
          { ref: 'Hebrews 1-7', book: 'Hebrews', chapter: 4, startVerse: 14, endVerse: 16, title: 'Our Great High Priest' },
          { ref: 'Hebrews 8-13', book: 'Hebrews', chapter: 11, startVerse: 1, endVerse: 6, title: 'The Hall of Faith' },
        ]
      },
      {
        id: 'redemption-30',
        title: 'The Story of Redemption',
        description: 'Trace God\'s plan of salvation from Genesis to Revelation in 30 key passages.',
        duration: 30,
        readings: [
          { ref: 'Genesis 1-2', book: 'Genesis', chapter: 1, startVerse: 1, endVerse: 31, title: 'Creation' },
          { ref: 'Genesis 3', book: 'Genesis', chapter: 3, startVerse: 1, endVerse: 24, title: 'The Fall' },
          { ref: 'Genesis 6-9', book: 'Genesis', chapter: 6, startVerse: 5, endVerse: 22, title: 'Noah & The Flood' },
          { ref: 'Genesis 12', book: 'Genesis', chapter: 12, startVerse: 1, endVerse: 9, title: 'Abraham\'s Call' },
          { ref: 'Genesis 22', book: 'Genesis', chapter: 22, startVerse: 1, endVerse: 19, title: 'The Sacrifice of Isaac' },
          { ref: 'Exodus 3', book: 'Exodus', chapter: 3, startVerse: 1, endVerse: 15, title: 'The Burning Bush' },
          { ref: 'Exodus 12', book: 'Exodus', chapter: 12, startVerse: 1, endVerse: 14, title: 'The Passover' },
          { ref: 'Exodus 20', book: 'Exodus', chapter: 20, startVerse: 1, endVerse: 21, title: 'The Ten Commandments' },
          { ref: 'Joshua 1', book: 'Joshua', chapter: 1, startVerse: 1, endVerse: 9, title: 'Entering the Promised Land' },
          { ref: '1 Samuel 16', book: '1 Samuel', chapter: 16, startVerse: 1, endVerse: 13, title: 'David Anointed King' },
          { ref: '2 Samuel 7', book: '2 Samuel', chapter: 7, startVerse: 8, endVerse: 16, title: 'The Davidic Covenant' },
          { ref: 'Psalm 22', book: 'Psalms', chapter: 22, startVerse: 1, endVerse: 18, title: 'Prophecy of the Cross' },
          { ref: 'Isaiah 53', book: 'Isaiah', chapter: 53, startVerse: 1, endVerse: 12, title: 'The Suffering Servant' },
          { ref: 'Jeremiah 31', book: 'Jeremiah', chapter: 31, startVerse: 31, endVerse: 34, title: 'The New Covenant' },
          { ref: 'Ezekiel 37', book: 'Ezekiel', chapter: 37, startVerse: 1, endVerse: 14, title: 'Valley of Dry Bones' },
          { ref: 'Daniel 7', book: 'Daniel', chapter: 7, startVerse: 13, endVerse: 14, title: 'The Son of Man' },
          { ref: 'Micah 5', book: 'Micah', chapter: 5, startVerse: 2, endVerse: 5, title: 'Out of Bethlehem' },
          { ref: 'Luke 1-2', book: 'Luke', chapter: 2, startVerse: 1, endVerse: 20, title: 'The Incarnation' },
          { ref: 'Matthew 3', book: 'Matthew', chapter: 3, startVerse: 13, endVerse: 17, title: 'Baptism of Jesus' },
          { ref: 'John 3', book: 'John', chapter: 3, startVerse: 16, endVerse: 21, title: 'For God So Loved' },
          { ref: 'Matthew 16', book: 'Matthew', chapter: 16, startVerse: 13, endVerse: 20, title: 'Peter\'s Confession' },
          { ref: 'Mark 10', book: 'Mark', chapter: 10, startVerse: 32, endVerse: 45, title: 'Servant of All' },
          { ref: 'Luke 22', book: 'Luke', chapter: 22, startVerse: 14, endVerse: 23, title: 'The Last Supper' },
          { ref: 'John 19', book: 'John', chapter: 19, startVerse: 16, endVerse: 30, title: 'The Crucifixion' },
          { ref: 'Luke 24', book: 'Luke', chapter: 24, startVerse: 1, endVerse: 12, title: 'The Resurrection' },
          { ref: 'Acts 2', book: 'Acts', chapter: 2, startVerse: 1, endVerse: 21, title: 'Pentecost' },
          { ref: 'Romans 8', book: 'Romans', chapter: 8, startVerse: 28, endVerse: 39, title: 'More Than Conquerors' },
          { ref: 'Ephesians 2', book: 'Ephesians', chapter: 2, startVerse: 1, endVerse: 10, title: 'Saved by Grace' },
          { ref: 'Revelation 21', book: 'Revelation', chapter: 21, startVerse: 1, endVerse: 8, title: 'New Heaven & New Earth' },
          { ref: 'Revelation 22', book: 'Revelation', chapter: 22, startVerse: 1, endVerse: 5, title: 'The River of Life' },
        ]
      }
    ];

    const plansModal = document.getElementById('plans-modal');
    const plansBackdrop = document.getElementById('plans-backdrop');
    const plansBrowse = document.getElementById('plans-browse');
    const plansDetail = document.getElementById('plans-detail');

    function getPlansProgress() { return DataStore.getPlansProgress(); }
    function savePlansProgress(p) { DataStore.savePlansProgress(p); }
    function getActivePlan() { return DataStore.getActivePlan(); }
    function setActivePlan(id) { DataStore.setActivePlan(id); }
    function getStreak() { return DataStore.getStreak(); }
    function saveStreak(s) { DataStore.saveStreak(s); }

    function updateStreak() {
      const streak = getStreak();
      const today = new Date().toISOString().split('T')[0];
      if (streak.lastRead === today) return streak;

      const yesterday = new Date(Date.now() - 86400000).toISOString().split('T')[0];
      if (streak.lastRead === yesterday) {
        streak.current += 1;
      } else {
        streak.current = 1;
      }
      streak.lastRead = today;
      if (streak.current > streak.longest) streak.longest = streak.current;
      saveStreak(streak);
      return streak;
    }

    function openReadingPlans() {
      plansModal.classList.add('open');
      plansBackdrop.classList.add('open');
      const activePlanId = getActivePlan();
      if (activePlanId) {
        showPlanDetail(activePlanId);
      } else {
        showPlansBrowse();
      }
    }

    function closeReadingPlans() {
      plansModal.classList.remove('open');
      plansBackdrop.classList.remove('open');
    }

    function showPlansBrowse() {
      plansBrowse.classList.remove('hidden');
      plansDetail.classList.add('hidden');
      document.getElementById('plans-title').textContent = 'Reading Plans';
      plansBrowse.textContent = '';

      const progress = getPlansProgress();
      const activePlanId = getActivePlan();
      const streak = getStreak();

      if (streak.current > 0) {
        const streakEl = document.createElement('div');
        streakEl.className = 'plans-streak';
        streakEl.innerHTML = '<div class="plans-streak-fire">\ud83d\udd25</div><div class="plans-streak-info"><div class="plans-streak-count">' + streak.current + ' day' + (streak.current > 1 ? 's' : '') + '</div><div class="plans-streak-label">Reading streak (best: ' + streak.longest + ')</div></div>';
        plansBrowse.appendChild(streakEl);
      }

      READING_PLANS.forEach(plan => {
        const card = document.createElement('div');
        card.className = 'plan-card' + (plan.id === activePlanId ? ' active' : '');

        const title = document.createElement('div');
        title.className = 'plan-card-title';
        title.textContent = plan.title;
        card.appendChild(title);

        const desc = document.createElement('div');
        desc.className = 'plan-card-desc';
        desc.textContent = plan.description;
        card.appendChild(desc);

        const meta = document.createElement('div');
        meta.className = 'plan-card-meta';
        meta.textContent = plan.duration + ' days';

        const completed = progress[plan.id] ? Object.keys(progress[plan.id]).filter(k => progress[plan.id][k]).length : 0;
        if (completed > 0) {
          meta.textContent += ' \u2022 ' + completed + '/' + plan.duration + ' completed';
        }
        card.appendChild(meta);

        if (completed > 0) {
          const bar = document.createElement('div');
          bar.className = 'plan-progress-bar';
          const fill = document.createElement('div');
          fill.className = 'plan-progress-fill';
          fill.style.width = Math.round((completed / plan.duration) * 100) + '%';
          bar.appendChild(fill);
          card.appendChild(bar);
        }

        card.addEventListener('click', () => showPlanDetail(plan.id));
        plansBrowse.appendChild(card);
      });
    }

    function showPlanDetail(planId) {
      const plan = READING_PLANS.find(p => p.id === planId);
      if (!plan) return;

      plansBrowse.classList.add('hidden');
      plansDetail.classList.remove('hidden');
      plansDetail.textContent = '';
      document.getElementById('plans-title').textContent = plan.title;

      const progress = getPlansProgress();
      if (!progress[planId]) progress[planId] = {};
      const planProgress = progress[planId];
      const completed = Object.keys(planProgress).filter(k => planProgress[k]).length;

      // Back button
      const back = document.createElement('button');
      back.className = 'plan-detail-back';
      back.innerHTML = '<svg fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width:14px;height:14px"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/></svg> All Plans';
      back.addEventListener('click', showPlansBrowse);
      plansDetail.appendChild(back);

      // Find current day (first incomplete)
      let currentDay = 0;
      for (let i = 0; i < plan.readings.length; i++) {
        if (!planProgress[i]) { currentDay = i; break; }
        if (i === plan.readings.length - 1) currentDay = i;
      }

      const reading = plan.readings[currentDay];
      if (reading) {
        const todayCard = document.createElement('div');
        todayCard.className = 'plan-today-card';

        const label = document.createElement('div');
        label.className = 'plan-today-label';
        label.textContent = 'Day ' + (currentDay + 1) + ' of ' + plan.duration;
        todayCard.appendChild(label);

        const ref = document.createElement('div');
        ref.className = 'plan-today-ref';
        ref.textContent = reading.ref;
        todayCard.appendChild(ref);

        const title = document.createElement('div');
        title.className = 'plan-today-title';
        title.textContent = reading.title;
        todayCard.appendChild(title);

        // Progress bar
        const bar = document.createElement('div');
        bar.className = 'plan-progress-bar';
        const fill = document.createElement('div');
        fill.className = 'plan-progress-fill';
        fill.style.width = Math.round((completed / plan.duration) * 100) + '%';
        bar.appendChild(fill);
        todayCard.appendChild(bar);

        const pctLabel = document.createElement('div');
        pctLabel.style.cssText = 'font-size: var(--text-xs); color: var(--neutral-400); margin-top: var(--space-1); text-align: right;';
        pctLabel.textContent = Math.round((completed / plan.duration) * 100) + '% complete';
        todayCard.appendChild(pctLabel);

        const actions = document.createElement('div');
        actions.className = 'plan-today-actions';
        actions.style.marginTop = 'var(--space-3)';

        const readBtn = document.createElement('button');
        readBtn.className = 'plan-read-btn';
        readBtn.textContent = 'Read Now';
        readBtn.addEventListener('click', () => {
          closeReadingPlans();
          navigateToPassage(reading);
        });
        actions.appendChild(readBtn);

        if (!planProgress[currentDay]) {
          const markBtn = document.createElement('button');
          markBtn.className = 'plan-mark-btn';
          markBtn.textContent = 'Mark as Read';
          markBtn.addEventListener('click', () => {
            planProgress[currentDay] = true;
            savePlansProgress(progress);
            updateStreak();
            showToast('Day ' + (currentDay + 1) + ' completed!');
            showPlanDetail(planId);
          });
          actions.appendChild(markBtn);
        }

        todayCard.appendChild(actions);
        plansDetail.appendChild(todayCard);
      }

      // Start/continue button
      if (!getActivePlan() || getActivePlan() !== planId) {
        const startBtn = document.createElement('button');
        startBtn.className = 'plan-start-btn';
        startBtn.textContent = completed > 0 ? 'Continue This Plan' : 'Start This Plan';
        startBtn.addEventListener('click', () => {
          setActivePlan(planId);
          showToast('Plan activated!');
          showPlanDetail(planId);
        });
        plansDetail.appendChild(startBtn);
      }

      // Calendar grid
      const calLabel = document.createElement('div');
      calLabel.style.cssText = 'font-size: var(--text-xs); color: var(--neutral-400); margin-top: var(--space-4); margin-bottom: var(--space-2);';
      calLabel.textContent = 'Progress Calendar';
      plansDetail.appendChild(calLabel);

      const cal = document.createElement('div');
      cal.className = 'plan-calendar';
      for (let i = 0; i < plan.readings.length; i++) {
        const day = document.createElement('div');
        day.className = 'plan-calendar-day' + (planProgress[i] ? ' completed' : '') + (i === currentDay ? ' today' : '');
        day.textContent = i + 1;
        day.title = plan.readings[i].ref;
        cal.appendChild(day);
      }
      plansDetail.appendChild(cal);
    }

    document.getElementById('close-plans').addEventListener('click', closeReadingPlans);
    document.getElementById('plans-backdrop').addEventListener('click', closeReadingPlans);

    // ===== Left Drawer =====
    const drawerEl = document.getElementById('drawer');
    const drawerBackdrop = document.getElementById('drawer-backdrop');
    const drawerBtn = document.getElementById('drawer-btn');

    function openDrawer() {
      drawerEl.classList.add('open');
      drawerBackdrop.classList.add('open');
      updateDrawerGreeting();
    }

    function closeDrawer() {
      drawerEl.classList.remove('open');
      drawerBackdrop.classList.remove('open');
    }

    function updateDrawerGreeting() {
      const hour = new Date().getHours();
      let greeting = 'Good evening';
      if (hour < 12) greeting = 'Good morning';
      else if (hour < 17) greeting = 'Good afternoon';

      document.getElementById('drawer-greeting').textContent = greeting;

      const now = new Date();
      const options = { weekday: 'long', month: 'long', day: 'numeric' };
      document.getElementById('drawer-date').textContent = now.toLocaleDateString('en-US', options);
    }

    drawerBtn.addEventListener('click', openDrawer);
    drawerBackdrop.addEventListener('click', closeDrawer);

    // Drawer item handlers
    document.getElementById('drawer-life-app').addEventListener('click', () => {
      closeDrawer();
      openLifeApp();
    });

    document.getElementById('drawer-topical').addEventListener('click', () => {
      closeDrawer();
      openTopicalBrowse();
    });

    document.getElementById('drawer-plans').addEventListener('click', () => {
      closeDrawer();
      openReadingPlans();
    });

    document.getElementById('drawer-prayers').addEventListener('click', () => {
      closeDrawer();
      openPrayerJournal();
    });

    document.getElementById('drawer-devotional').addEventListener('click', () => {
      closeDrawer();
      openDailyDevotional();
    });

    document.getElementById('drawer-shortcuts').addEventListener('click', () => {
      closeDrawer();
      showToast('/ Search    T Topics    P Plans    L Life App    D Dark mode    ` Menu');
    });

    // ===== Auth UI Event Handlers =====
    document.getElementById('auth-btn').addEventListener('click', () => DataStore._openAuthModal());
    document.getElementById('auth-backdrop').addEventListener('click', () => DataStore._closeAuthModal());
    document.getElementById('drawer-account').addEventListener('click', () => {
      closeDrawer();
      DataStore._openAuthModal();
    });

    document.getElementById('auth-toggle-link').addEventListener('click', () => {
      const mode = document.getElementById('auth-submit').dataset.mode;
      DataStore._setAuthMode(mode === 'signin' ? 'signup' : 'signin');
    });

    document.getElementById('auth-submit').addEventListener('click', async () => {
      const email = document.getElementById('auth-email').value.trim();
      const password = document.getElementById('auth-password').value;
      const errorEl = document.getElementById('auth-error');
      const submitBtn = document.getElementById('auth-submit');
      const mode = submitBtn.dataset.mode;

      if (!email || !password) {
        errorEl.textContent = 'Please enter email and password';
        return;
      }
      if (mode === 'signup') {
        const confirm = document.getElementById('auth-confirm').value;
        if (password !== confirm) {
          errorEl.textContent = 'Passwords do not match';
          return;
        }
        if (password.length < 6) {
          errorEl.textContent = 'Password must be at least 6 characters';
          return;
        }
      }

      submitBtn.disabled = true;
      errorEl.textContent = '';
      try {
        if (mode === 'signup') {
          await DataStore.signUp(email, password);
        } else {
          await DataStore.signIn(email, password);
          DataStore._closeAuthModal();
        }
      } catch (e) {
        errorEl.textContent = e.message || 'Authentication failed';
      } finally {
        submitBtn.disabled = false;
      }
    });

    // Allow Enter key to submit auth form
    ['auth-email', 'auth-password', 'auth-confirm'].forEach(id => {
      document.getElementById(id).addEventListener('keydown', (e) => {
        if (e.key === 'Enter') document.getElementById('auth-submit').click();
      });
    });

    document.getElementById('auth-signout').addEventListener('click', async () => {
      await DataStore.signOut();
      DataStore._closeAuthModal();
      showToast('Signed out');
    });

    document.getElementById('auth-import-btn').addEventListener('click', () => DataStore.importLocalData());
    document.getElementById('auth-skip-btn').addEventListener('click', () => DataStore.skipImport());

  </script>
</body>
</html>
